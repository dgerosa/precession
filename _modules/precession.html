<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>precession &mdash; precession 2.0.4 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            precession
          </a>
              <div class="version">
                2.0.4
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Readme</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../auto.html">Package documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">precession</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">precession</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for precession</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.special</span>
<span class="kn">import</span> <span class="nn">scipy.integrate</span>
<span class="kn">import</span> <span class="nn">scipy.spatial.transform</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">repeat</span>

<span class="c1">################ Utilities ################</span>


<div class="viewcode-block" id="roots_vec"><a class="viewcode-back" href="../auto.html#precession.roots_vec">[docs]</a><span class="k">def</span> <span class="nf">roots_vec</span><span class="p">(</span><span class="n">p</span><span class="p">):</span> <span class="c1">#, enforce=False):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Locate roots of polynomial using a vectorized version of numpy.roots.</span>
<span class="sd">    Credit to stackoverflow user &#39;pv&#39; (https://stackoverflow.com/a/35853977) for some of this code, which we generalize to accomodate equations of different degrees.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    p: float</span>
<span class="sd">        Polynomial coefficients.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    roots: float</span>
<span class="sd">        Polynomial roots.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``roots = precession.roots_vec(p)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">non_zeros</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># Mask arrays with all zeros with a dummy equation</span>
    <span class="n">p</span><span class="p">[</span><span class="n">non_zeros</span><span class="o">==</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>

    <span class="c1">#if not non_zeros.all()!=0:</span>
    <span class="c1">#    if enforce:</span>
    <span class="c1">#        raise ValueError(&quot;There is at least one coefficients line with all zeros [roots_vec_zeros].&quot;)</span>
    <span class="c1">#    else:</span>
    <span class="c1">#        warnings.warn(&quot;There is at least one coefficients line with all zeros [roots_vec_zeros].&quot;, Warning)</span>

    <span class="c1">#https://stackoverflow.com/a/20361561</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])[:,</span><span class="kc">None</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">nz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">B</span><span class="o">!=</span><span class="mi">0</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">rows</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ogrid</span><span class="p">[:</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">nz</span><span class="p">)</span>
    <span class="n">shift</span><span class="p">[</span><span class="n">shift</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span> <span class="o">+</span> <span class="n">shift</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">rows</span><span class="p">,</span> <span class="n">columns</span><span class="p">]</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="nb">float</span><span class="p">)</span>
    <span class="n">A</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">A</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">/</span><span class="n">p</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigvals</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>

    <span class="n">nansol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">nz</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">results</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">resind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">results</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">:</span><span class="n">results</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">resind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">resind</span><span class="o">&lt;</span><span class="n">nansol</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>

    <span class="c1"># Replace nans for arrays where it&#39;s all zeros</span>
    <span class="n">resind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">non_zeros</span><span class="o">==</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">resind</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">resind</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="k">return</span> <span class="n">resind</span></div>


<div class="viewcode-block" id="norm_nested"><a class="viewcode-back" href="../auto.html#precession.norm_nested">[docs]</a><span class="k">def</span> <span class="nf">norm_nested</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Norm of 2D array of shape (N,3) along last axis.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : array</span>
<span class="sd">        Input array.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    n : array</span>
<span class="sd">        Norm of the input arrays.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``n = norm_nested(x)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="normalize_nested"><a class="viewcode-back" href="../auto.html#precession.normalize_nested">[docs]</a><span class="k">def</span> <span class="nf">normalize_nested</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalize 2D array of shape (N,3) along last axis.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : array</span>
<span class="sd">        Input array.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    y : array</span>
<span class="sd">        Normalized array.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``y = normalize_nested(x)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">x</span><span class="o">/</span><span class="n">norm_nested</span><span class="p">(</span><span class="n">x</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span></div>


<div class="viewcode-block" id="dot_nested"><a class="viewcode-back" href="../auto.html#precession.dot_nested">[docs]</a><span class="k">def</span> <span class="nf">dot_nested</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dot product between 2D arrays along last axis.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : array</span>
<span class="sd">        Input array.</span>
<span class="sd">    y : array</span>
<span class="sd">        Input array.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    z : array</span>
<span class="sd">        Dot product array.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``z = dot_nested(x, y)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij, ij-&gt;i&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span></div>


<div class="viewcode-block" id="scalar_nested"><a class="viewcode-back" href="../auto.html#precession.scalar_nested">[docs]</a><span class="k">def</span> <span class="nf">scalar_nested</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Nested scalar product between a 1D and a 2D array.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    k : float</span>
<span class="sd">        Input scalar.</span>
<span class="sd">    x : array</span>
<span class="sd">        Input array.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    y : array</span>
<span class="sd">        Scalar product array.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``y = scalar_nested(k, x)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">k</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">*</span><span class="n">x</span></div>


<div class="viewcode-block" id="rotate_nested"><a class="viewcode-back" href="../auto.html#precession.rotate_nested">[docs]</a><span class="k">def</span> <span class="nf">rotate_nested</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">align_zaxis</span><span class="p">,</span> <span class="n">align_xzplane</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rotate a given vector vec to a frame such that the vector align_zaxis lies along z and the vector align_xzplane lies in the xz plane.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vec : array</span>
<span class="sd">        Input array.</span>
<span class="sd">    align_zaxis : array</span>
<span class="sd">        Reference array.</span>
<span class="sd">    align_xzplane : array</span>
<span class="sd">        Reference array.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    vecrot : array</span>
<span class="sd">        Rotated array.</span>
<span class="sd"> </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``vecrot = rotate_nested(vec, align_zaxis, align_xzplane)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
    <span class="n">align_zaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">align_zaxis</span><span class="p">)</span>
    <span class="n">align_xzplane</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">align_xzplane</span><span class="p">)</span>
    
    <span class="n">align_zaxis</span> <span class="o">=</span> <span class="n">normalize_nested</span><span class="p">(</span><span class="n">align_zaxis</span><span class="p">)</span>
    
    <span class="n">angle1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">align_zaxis</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">vec1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">align_zaxis</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">vec1</span> <span class="o">=</span> <span class="n">normalize_nested</span><span class="p">(</span><span class="n">vec1</span><span class="p">)</span>
    <span class="n">r1</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">Rotation</span><span class="o">.</span><span class="n">from_rotvec</span><span class="p">(</span><span class="n">angle1</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">vec1</span><span class="p">)</span>

    <span class="n">align_xzplane</span> <span class="o">=</span> <span class="n">r1</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">align_xzplane</span><span class="p">)</span>    
    <span class="n">align_xzplane</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">align_xzplane</span> <span class="o">=</span> <span class="n">normalize_nested</span><span class="p">(</span><span class="n">align_xzplane</span><span class="p">)</span>

    <span class="n">angle2</span><span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">align_xzplane</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">align_xzplane</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">vec2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">Rotation</span><span class="o">.</span><span class="n">from_rotvec</span><span class="p">(</span><span class="n">angle2</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">vec2</span><span class="p">)</span>
    
    <span class="n">vecrot</span> <span class="o">=</span> <span class="n">r2</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">r1</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">vec</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">vecrot</span></div>


<div class="viewcode-block" id="sample_unitsphere"><a class="viewcode-back" href="../auto.html#precession.sample_unitsphere">[docs]</a><span class="k">def</span> <span class="nf">sample_unitsphere</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sample points uniformly on a sphere of unit radius. Returns array of shape (N,3).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    N: integer, optional (default: 1)</span>
<span class="sd">        Number of samples.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    vec: array</span>
<span class="sd">        Vector in Cartesian coomponents.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``vec = sample_unitsphere(N=1)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
    <span class="n">vec</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">vec</span><span class="o">.</span><span class="n">T</span></div>


<div class="viewcode-block" id="isotropic_angles"><a class="viewcode-back" href="../auto.html#precession.isotropic_angles">[docs]</a><span class="k">def</span> <span class="nf">isotropic_angles</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sample the angles theta1, theta2, and deltaphi from an isotropic distribution.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    N: integer, optional (default: 1)</span>
<span class="sd">        Number of samples.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    vec: array</span>
<span class="sd">        Vector in Cartesian coomponents.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``vec = precession.isotropic_angles(N=1)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">theta1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="p">))</span>
    <span class="n">theta2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="p">))</span>
    <span class="n">deltaphi</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">theta1</span><span class="p">,</span><span class="n">theta2</span><span class="p">,</span><span class="n">deltaphi</span><span class="p">])</span></div>


<div class="viewcode-block" id="tiler"><a class="viewcode-back" href="../auto.html#precession.tiler">[docs]</a><span class="k">def</span> <span class="nf">tiler</span><span class="p">(</span><span class="n">thing</span><span class="p">,</span><span class="n">shaper</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Repeat the quantity thing a numer of times give by the shape of shaper.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    thing: float  </span>
<span class="sd">        Quantity to be repeated</span>
<span class="sd">    shaper: array</span>
<span class="sd">        Quantity providing the shape.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    thing: float  </span>
<span class="sd">        Quantity to be repeated</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``thing = precession.tiler(thing,shaper)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">thing</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span>
    <span class="n">shaper</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">shaper</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">thing</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">shaper</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">thing</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">shaper</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shaper</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">thing</span><span class="p">)))</span></div>


<div class="viewcode-block" id="affine"><a class="viewcode-back" href="../auto.html#precession.affine">[docs]</a><span class="k">def</span> <span class="nf">affine</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">up</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform an affine trasformation to scale a vector given upper and lower limits: rescaled = ( vec - low ) / (up - low). If these are outside the domain of the vector, the result will be in [0,1].</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vec: array</span>
<span class="sd">        Vector in Cartesian coomponents.</span>
<span class="sd">    low: float</span>
<span class="sd">        Lower limit.</span>
<span class="sd">    up: float</span>
<span class="sd">        Upper limit.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    rescaled: float, optional</span>
<span class="sd">        Rescaled vector.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``rescaled = precession.affine(vec,low,up)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">up</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">low</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">rescaled</span> <span class="o">=</span> <span class="p">(</span> <span class="n">vec</span> <span class="o">-</span> <span class="n">low</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">up</span> <span class="o">-</span> <span class="n">low</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rescaled</span></div>

<div class="viewcode-block" id="inverseaffine"><a class="viewcode-back" href="../auto.html#precession.inverseaffine">[docs]</a><span class="k">def</span> <span class="nf">inverseaffine</span><span class="p">(</span><span class="n">rescaled</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">up</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform an inferse affine trasformation to scale a vector from some upper and lower limits: vec = low + rescaled*(up-low). If rescaled is defined in [0,1], the result will be defined in [low,up].</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rescaled: float</span>
<span class="sd">        Rescaled vector.</span>
<span class="sd">    low: float</span>
<span class="sd">        Lower limit.</span>
<span class="sd">    up: float</span>
<span class="sd">        Upper limit.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    vec: array</span>
<span class="sd">        Vector in Cartesian coomponents.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``vec = precession.inverseaffine(rescaled,low,up)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">rescaled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">rescaled</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">up</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">low</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">vec</span> <span class="o">=</span> <span class="n">low</span> <span class="o">+</span> <span class="n">rescaled</span><span class="o">*</span><span class="p">(</span><span class="n">up</span><span class="o">-</span><span class="n">low</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">vec</span></div>


<div class="viewcode-block" id="wraproots"><a class="viewcode-back" href="../auto.html#precession.wraproots">[docs]</a><span class="k">def</span> <span class="nf">wraproots</span><span class="p">(</span><span class="n">coefficientfunction</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find roots of a polynomial given coefficients, ordered according to their real part. Complex roots are masked with nans. This is essentially a wrapper of numpy.roots.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    coefficientfunction: callable</span>
<span class="sd">        Function returning  the polynomial coefficients ordered from highest to lowest degree.</span>
<span class="sd">    *args, **kwargs:</span>
<span class="sd">        Parameters of `coefficientfunction`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sols: array</span>
<span class="sd">        Roots of the polynomial.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``sols = precession.wraproots(coefficientfunction, *args, **kwargs)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">coeffs</span> <span class="o">=</span> <span class="n">coefficientfunction</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">sols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort_complex</span><span class="p">(</span><span class="n">roots_vec</span><span class="p">(</span><span class="n">coeffs</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
    <span class="n">sols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isreal</span><span class="p">(</span><span class="n">sols</span><span class="p">),</span> <span class="n">sols</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">sols</span></div>


<div class="viewcode-block" id="ellippi"><a class="viewcode-back" href="../auto.html#precession.ellippi">[docs]</a><span class="k">def</span> <span class="nf">ellippi</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Incomplete elliptic integral of the third kind. This is reconstructed using scipy&#39;s implementation of Carlson&#39;s R integrals (arxiv:math/9409227).</span>
<span class="sd"> </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n: foat</span>
<span class="sd">        Characheristic of the elliptic integral.</span>
<span class="sd">    phi: float</span>
<span class="sd">        Amplitude of the elliptic integral.</span>
<span class="sd">    m: float</span>
<span class="sd">        Parameter of the elliptic integral</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    piintegral: float</span>
<span class="sd">        Incomplete elliptic integral of the third kind</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``piintegral = precession.ellippi(n, phi, m)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Important: this requires scipy&gt;=1.8.0</span>
    <span class="c1"># https://docs.scipy.org/doc/scipy/release.1.8.0.html</span>

    <span class="c1"># Notation used here:</span>
    <span class="c1"># https://reference.wolfram.com/language/ref/EllipticPi.html</span>

    <span class="c1"># A much slower implementation using simpy</span>
    <span class="c1"># from sympy import elliptic_pi</span>
    <span class="c1">#return float(elliptic_pi(float(n), float(phi), float(m)))</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="k">if</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">phi</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">phi</span><span class="o">&lt;=</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">m</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">m</span><span class="o">&lt;=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Elliptic intergal of the third kind evaluated outside of the expected domain. Our implementation has not been tested in this regime!&quot;</span><span class="p">,</span> <span class="ne">Warning</span><span class="p">)</span>

    <span class="c1"># Eq (61) in Carlson 1994 (arxiv:math/9409227v1). Careful with the notation: one has k^2 --&gt; m and n --&gt; -n.</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">elliprf</span><span class="p">(</span><span class="n">c</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">c</span><span class="o">-</span><span class="n">m</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">elliprj</span><span class="p">(</span><span class="n">c</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">c</span><span class="o">-</span><span class="n">m</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">c</span><span class="o">-</span><span class="n">n</span><span class="p">)</span></div>


<div class="viewcode-block" id="ismonotonic"><a class="viewcode-back" href="../auto.html#precession.ismonotonic">[docs]</a><span class="k">def</span> <span class="nf">ismonotonic</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">which</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if an array is monotonic. The parameter `which` can takes the following values:</span>
<span class="sd">        - `&lt;` check array is strictly increasing.</span>
<span class="sd">        - `&lt;=` check array is increasing.</span>
<span class="sd">        - `&gt;` check array is strictly decreasing.</span>
<span class="sd">        - `&gt;=` check array is decreasing.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vec: array</span>
<span class="sd">        Input array.</span>
<span class="sd">    which: string</span>
<span class="sd">        Select function behavior.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    check: boolean</span>
<span class="sd">        Result</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``check = ismonotonic(vec, which)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">vec</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">vec</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">vec</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">vec</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">vec</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">vec</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">vec</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">vec</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`which` needs to be one of the following: `&gt;`, `&gt;=`, `&lt;`, `&lt;=`.&quot;</span><span class="p">)</span></div>


<span class="c1">################ Some definitions ################</span>


<div class="viewcode-block" id="eval_m1"><a class="viewcode-back" href="../auto.html#precession.eval_m1">[docs]</a><span class="k">def</span> <span class="nf">eval_m1</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Mass of the heavier black hole in units of the total mass.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    m1: float</span>
<span class="sd">        Mass of the primary (heavier) black hole.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``m1 = precession.eval_m1(q)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">m1</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">m1</span></div>


<div class="viewcode-block" id="eval_m2"><a class="viewcode-back" href="../auto.html#precession.eval_m2">[docs]</a><span class="k">def</span> <span class="nf">eval_m2</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Mass of the lighter black hole in units of the total mass.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    m2: float</span>
<span class="sd">        Mass of the secondary (lighter) black hole.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``m2 = precession.eval_m2(q)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">m2</span> <span class="o">=</span> <span class="n">q</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">m2</span></div>


<div class="viewcode-block" id="eval_q"><a class="viewcode-back" href="../auto.html#precession.eval_q">[docs]</a><span class="k">def</span> <span class="nf">eval_q</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Mass ratio, 0 &lt; q = m2/m1 &lt; 1.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    m1: float</span>
<span class="sd">        Mass of the primary (heavier) black hole.</span>
<span class="sd">    m2: float</span>
<span class="sd">        Mass of the secondary (lighter) black hole.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``q = precession.eval_q(m1,m2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">m1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">m1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">m2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">m2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">m2</span><span class="o">/</span><span class="n">m1</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">q</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="s2">&quot;The convention used in this code is q=m2/m1&lt;1.&quot;</span>

    <span class="k">return</span> <span class="n">q</span></div>


<div class="viewcode-block" id="eval_eta"><a class="viewcode-back" href="../auto.html#precession.eval_eta">[docs]</a><span class="k">def</span> <span class="nf">eval_eta</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Symmetric mass ratio eta = m1*m2/(m1+m2)^2 = q/(1+q)^2.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    eta: float</span>
<span class="sd">        Symmetric mass ratio 0&lt;=eta&lt;=1/4.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``eta = precession.eval_eta(q)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">eta</span> <span class="o">=</span> <span class="n">q</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">return</span> <span class="n">eta</span></div>


<div class="viewcode-block" id="eval_S1"><a class="viewcode-back" href="../auto.html#precession.eval_S1">[docs]</a><span class="k">def</span> <span class="nf">eval_S1</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Spin angular momentum of the heavier black hole.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    S1: float</span>
<span class="sd">        Magnitude of the primary spin.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``S1 = precession.eval_S1(q,chi1)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">chi1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">S1</span> <span class="o">=</span> <span class="n">chi1</span><span class="o">*</span><span class="p">(</span><span class="n">eval_m1</span><span class="p">(</span><span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">return</span> <span class="n">S1</span></div>


<div class="viewcode-block" id="eval_S2"><a class="viewcode-back" href="../auto.html#precession.eval_S2">[docs]</a><span class="k">def</span> <span class="nf">eval_S2</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">chi2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Spin angular momentum of the lighter black hole.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    S2: float</span>
<span class="sd">        Magnitude of the secondary spin.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``S2 = precession.eval_S2(q,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">S2</span> <span class="o">=</span> <span class="n">chi2</span><span class="o">*</span><span class="p">(</span><span class="n">eval_m2</span><span class="p">(</span><span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">return</span> <span class="n">S2</span></div>


<div class="viewcode-block" id="eval_chi1"><a class="viewcode-back" href="../auto.html#precession.eval_chi1">[docs]</a><span class="k">def</span> <span class="nf">eval_chi1</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">S1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dimensionless spin of the heavier black hole.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    S1: float</span>
<span class="sd">        Magnitude of the primary spin.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``chi1 = precession.eval_chi1(q,S1)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">S1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">S1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi1</span> <span class="o">=</span> <span class="n">S1</span><span class="o">/</span><span class="p">(</span><span class="n">eval_m1</span><span class="p">(</span><span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">return</span> <span class="n">chi1</span></div>


<div class="viewcode-block" id="eval_chi2"><a class="viewcode-back" href="../auto.html#precession.eval_chi2">[docs]</a><span class="k">def</span> <span class="nf">eval_chi2</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">S2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dimensionless spin of the lighter black hole.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    S2: float</span>
<span class="sd">        Magnitude of the secondary spin.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``chi2 = precession.eval_chi2(q,S2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">S2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">S2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi2</span> <span class="o">=</span> <span class="n">S2</span><span class="o">/</span><span class="p">(</span><span class="n">eval_m2</span><span class="p">(</span><span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">return</span> <span class="n">chi2</span></div>


<div class="viewcode-block" id="eval_L"><a class="viewcode-back" href="../auto.html#precession.eval_L">[docs]</a><span class="k">def</span> <span class="nf">eval_L</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Newtonian angular momentum of the binary.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    L: float</span>
<span class="sd">        Magnitude of the Newtonian orbital angular momentum.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``L = precession.eval_L(r,q)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">L</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="mf">0.5</span>

    <span class="k">return</span> <span class="n">L</span></div>


<div class="viewcode-block" id="eval_v"><a class="viewcode-back" href="../auto.html#precession.eval_v">[docs]</a><span class="k">def</span> <span class="nf">eval_v</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Newtonian orbital velocity of the binary.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    v: float</span>
<span class="sd">        Newtonian orbital velocity.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``v = precession.eval_v(r)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">r</span><span class="o">**</span><span class="mf">0.5</span>

    <span class="k">return</span> <span class="n">v</span></div>


<div class="viewcode-block" id="eval_r"><a class="viewcode-back" href="../auto.html#precession.eval_r">[docs]</a><span class="k">def</span> <span class="nf">eval_r</span><span class="p">(</span><span class="n">L</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">u</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">q</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Orbital separation of the binary. Valid inputs are either (L,q) or (u,q).</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    L: float, optional (default: None)</span>
<span class="sd">        Magnitude of the Newtonian orbital angular momentum.</span>
<span class="sd">    u: float, optional (default: None)</span>
<span class="sd">        Compactified separation 1/(2L).</span>
<span class="sd">    q: float, optional (default: None)</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``r = precession.eval_r(L=L,q=q)``</span>
<span class="sd">    ``r = precession.eval_r(u=u,q=q)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">L</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">u</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">L</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">L</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">q</span> <span class="p">)</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">elif</span> <span class="n">L</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">u</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">u</span><span class="o">*</span><span class="n">q</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Provide either (L,q) or (u,q).&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">r</span></div>


<div class="viewcode-block" id="eval_u"><a class="viewcode-back" href="../auto.html#precession.eval_u">[docs]</a><span class="k">def</span> <span class="nf">eval_u</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compactified orbital separation.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    u: float</span>
<span class="sd">        Compactified separation 1/(2L).</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``u = precession.eval_u(r,q)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">L</span> <span class="o">=</span> <span class="n">eval_L</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">L</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">u</span></div>


<div class="viewcode-block" id="eval_chieff"><a class="viewcode-back" href="../auto.html#precession.eval_chieff">[docs]</a><span class="k">def</span> <span class="nf">eval_chieff</span><span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Eftective spin.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    theta1: float</span>
<span class="sd">        Angle between orbital angular momentum and primary spin.</span>
<span class="sd">    theta2: float</span>
<span class="sd">        Angle between orbital angular momentum and secondary spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``chieff = precession.eval_chieff(theta1,theta2,q,chi1,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">theta1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">theta1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">theta2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">theta2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">chieff</span> <span class="o">=</span> <span class="p">(</span><span class="n">chi1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta1</span><span class="p">)</span> <span class="o">+</span> <span class="n">q</span><span class="o">*</span><span class="n">chi2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta2</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">chieff</span></div>


<div class="viewcode-block" id="eval_deltachi"><a class="viewcode-back" href="../auto.html#precession.eval_deltachi">[docs]</a><span class="k">def</span> <span class="nf">eval_deltachi</span><span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Weighted spin difference.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    theta1: float</span>
<span class="sd">        Angle between orbital angular momentum and primary spin.</span>
<span class="sd">    theta2: float</span>
<span class="sd">        Angle between orbital angular momentum and secondary spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    deltachi: float</span>
<span class="sd">        Weighted spin difference.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``deltachi = precession.eval_deltachi(theta1,theta2,q,chi1,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">theta1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">theta1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">theta2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">theta2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">deltachi</span> <span class="o">=</span> <span class="p">(</span><span class="n">chi1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta1</span><span class="p">)</span> <span class="o">-</span><span class="n">q</span><span class="o">*</span><span class="n">chi2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta2</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">deltachi</span></div>


<div class="viewcode-block" id="eval_deltachiinf"><a class="viewcode-back" href="../auto.html#precession.eval_deltachiinf">[docs]</a><span class="k">def</span> <span class="nf">eval_deltachiinf</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Large-separation limit of the weighted spin difference.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kappa: float</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    deltachi: float</span>
<span class="sd">        Weighted spin difference.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``deltachi = precession.eval_deltachiinf(kappa,chieff,q,chi1,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">kappa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">kappa</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chieff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chieff</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">deltachi</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">kappa</span><span class="o">-</span><span class="n">chieff</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">deltachi</span></div>


<div class="viewcode-block" id="eval_costheta1"><a class="viewcode-back" href="../auto.html#precession.eval_costheta1">[docs]</a><span class="k">def</span> <span class="nf">eval_costheta1</span><span class="p">(</span><span class="n">deltachi</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cosine of the angle between the orbital angular momentum and the spin of the primary black hole.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    deltachi: float</span>
<span class="sd">        Weighted spin difference.</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    costheta1: float</span>
<span class="sd">        Cosine of the angle between orbital angular momentum and primary spin.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``costheta1 = precession.eval_costheta1(deltachi,chieff,q,chi1)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">deltachi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">deltachi</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chieff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chieff</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">costheta1</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">chi1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">chieff</span><span class="o">+</span><span class="n">deltachi</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">costheta1</span></div>


<div class="viewcode-block" id="eval_theta1"><a class="viewcode-back" href="../auto.html#precession.eval_theta1">[docs]</a><span class="k">def</span> <span class="nf">eval_theta1</span><span class="p">(</span><span class="n">deltachi</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Angle between the orbital angular momentum and the spin of the primary black hole.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    deltachi: float</span>
<span class="sd">        Weighted spin difference.</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    theta1: float</span>
<span class="sd">        Angle between orbital angular momentum and primary spin.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``theta1 = precession.eval_theta1(deltachi,chieff,q,chi1)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">costheta1</span> <span class="o">=</span> <span class="n">eval_costheta1</span><span class="p">(</span><span class="n">deltachi</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">)</span>
    <span class="n">theta1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">costheta1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">theta1</span></div>


<div class="viewcode-block" id="eval_costheta2"><a class="viewcode-back" href="../auto.html#precession.eval_costheta2">[docs]</a><span class="k">def</span> <span class="nf">eval_costheta2</span><span class="p">(</span><span class="n">deltachi</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cosine of the angle between the orbital angular momentum and the spin of the secondary black hole.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    deltachi: float</span>
<span class="sd">        Weighted spin difference.</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    costheta2: float</span>
<span class="sd">        Cosine of the angle between orbital angular momentum and secondary spin.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``costheta2 = precession.eval_costheta2(deltachi,chieff,q,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">deltachi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">deltachi</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chieff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chieff</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">costheta2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="o">*</span><span class="n">chi2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">chieff</span><span class="o">-</span><span class="n">deltachi</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">costheta2</span></div>


<div class="viewcode-block" id="eval_theta2"><a class="viewcode-back" href="../auto.html#precession.eval_theta2">[docs]</a><span class="k">def</span> <span class="nf">eval_theta2</span><span class="p">(</span><span class="n">deltachi</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Angle between the orbital angular momentum and the spin of the secondary black hole.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    deltachi: float</span>
<span class="sd">        Weighted spin difference.</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    theta2: float</span>
<span class="sd">        Angle between orbital angular momentum and secondary spin.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``theta2 = precession.eval_theta2(deltachi,chieff,q,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">costheta2</span> <span class="o">=</span> <span class="n">eval_costheta2</span><span class="p">(</span><span class="n">deltachi</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
    <span class="n">theta2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">costheta2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">theta2</span></div>


<div class="viewcode-block" id="eval_costheta12"><a class="viewcode-back" href="../auto.html#precession.eval_costheta12">[docs]</a><span class="k">def</span> <span class="nf">eval_costheta12</span><span class="p">(</span><span class="n">theta1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">theta2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deltaphi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deltachi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chieff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chi1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chi2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cosine of the angle between the two spins. Valid inputs are either (theta1,theta2,deltaphi) or (deltachi,kappa,chieff,q,chi1,chi2).</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    theta1: float, optional (default: None)</span>
<span class="sd">        Angle between orbital angular momentum and primary spin.</span>
<span class="sd">    theta2: float, optional (default: None)</span>
<span class="sd">        Angle between orbital angular momentum and secondary spin.</span>
<span class="sd">    deltaphi: float, optional (default: None)</span>
<span class="sd">        Angle between the projections of the two spins onto the orbital plane.</span>
<span class="sd">    deltachi: float, optional (default: None)</span>
<span class="sd">        Weighted spin difference.</span>
<span class="sd">    kappa: float, optional (default: None)</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    chieff: float, optional (default: None)</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float, optional (default: None)</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float, optional (default: None)</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float, optional (default: None)</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    costheta12: float</span>
<span class="sd">        Cosine of the angle between the two spins.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``costheta12 = precession.eval_costheta12(theta1=theta1,theta2=theta2,deltaphi=deltaphi)``</span>
<span class="sd">    ``costheta12 = precession.eval_costheta12(deltachi=deltachi,kappa=kappa,chieff=chieff,q=q,chi1=chi1,chi2=chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">theta1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">theta2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">deltaphi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">deltachi</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">kappa</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chieff</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">q</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chi1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chi2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">theta1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">theta1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">theta2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">theta2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">deltaphi</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">deltaphi</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">costheta12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">deltaphi</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta2</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">theta1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">theta2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">deltaphi</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">deltachi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">kappa</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chieff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chi1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chi2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">deltachi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">deltachi</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">kappa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">kappa</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">chieff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chieff</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">chi1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

        <span class="c1"># Machine generated with eq_generator.nb</span>
        <span class="n">costheta12</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi1</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> \
        <span class="p">(</span><span class="n">chi1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">q</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> \
        <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="n">deltachi</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="n">kappa</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> \
        <span class="n">chieff</span><span class="p">))))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Provide either (theta1,theta2,deltaphi) or (deltachi,kappa,chieff,q,chi1,chi2).&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">costheta12</span></div>


<div class="viewcode-block" id="eval_theta12"><a class="viewcode-back" href="../auto.html#precession.eval_theta12">[docs]</a><span class="k">def</span> <span class="nf">eval_theta12</span><span class="p">(</span><span class="n">theta1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">theta2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deltaphi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deltachi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chieff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chi1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chi2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Angle between the two spins. Valid inputs are either (theta1,theta2,deltaphi) or (deltachi,kappa,chieff,q,chi1,chi2).</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    theta1: float, optional (default: None)</span>
<span class="sd">        Angle between orbital angular momentum and primary spin.</span>
<span class="sd">    theta2: float, optional (default: None)</span>
<span class="sd">        Angle between orbital angular momentum and secondary spin.</span>
<span class="sd">    deltaphi: float, optional (default: None)</span>
<span class="sd">        Angle between the projections of the two spins onto the orbital plane.</span>
<span class="sd">    deltachi: float, optional (default: None)</span>
<span class="sd">        Weighted spin difference.</span>
<span class="sd">    kappa: float, optional (default: None)</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    chieff: float, optional (default: None)</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float, optional (default: None)</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float, optional (default: None)</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float, optional (default: None)</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    theta12: float</span>
<span class="sd">        Angle between the two spins.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``theta12 = precession.eval_theta12(theta1=theta1,theta2=theta2,deltaphi=deltaphi)``</span>
<span class="sd">    ``theta12 = precession.eval_theta12(deltachi=deltachi,kappa=kappa,chieff=chieff,q=q,chi1=chi1,chi2=chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">costheta12</span> <span class="o">=</span> <span class="n">eval_costheta12</span><span class="p">(</span><span class="n">theta1</span><span class="o">=</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="o">=</span><span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span><span class="o">=</span><span class="n">deltaphi</span><span class="p">,</span> <span class="n">deltachi</span><span class="o">=</span><span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="n">kappa</span><span class="p">,</span> <span class="n">chieff</span><span class="o">=</span><span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="o">=</span><span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="o">=</span><span class="n">chi2</span><span class="p">)</span>
    <span class="n">theta12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">costheta12</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">theta12</span></div>


<div class="viewcode-block" id="eval_cosdeltaphi"><a class="viewcode-back" href="../auto.html#precession.eval_cosdeltaphi">[docs]</a><span class="k">def</span> <span class="nf">eval_cosdeltaphi</span><span class="p">(</span><span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cosine of the angle between the projections of the two spins onto the orbital plane.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    deltachi: float</span>
<span class="sd">        Weighted spin difference.</span>
<span class="sd">    kappa: float</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    cosdeltaphi: float</span>
<span class="sd">        Cosine of the angle between the projections of the two spins onto the orbital plane.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``cosdeltaphi = precession.eval_cosdeltaphi(deltachi,kappa,r,chieff,q,chi1,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">deltachi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">deltachi</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">kappa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">kappa</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chieff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chieff</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>


    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        
        <span class="c1"># If there are infinitely large separation in the array the following will throw a warning. You can safely ignore it because that value is not used, see below  </span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span>
 
        <span class="c1"># Machine generated with eq_generator.nb</span>
        <span class="n">cosdeltaphi</span> <span class="o">=</span> <span class="n">q</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> \
        <span class="p">((</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">deltachi</span> <span class="o">+</span> <span class="n">chieff</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> \
        <span class="p">((</span><span class="n">deltachi</span> <span class="o">+</span> <span class="n">chieff</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="p">((</span><span class="n">chi1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> \
        <span class="p">(</span><span class="n">chi2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> \
        <span class="n">deltachi</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="n">kappa</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="n">chieff</span><span class="p">))</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> \
        <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">deltachi</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>

    <span class="c1"># At infinity, the only thing I can do is putting a random number for deltaphi, unformly distributed</span>
    <span class="n">cosdeltaphi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">r</span><span class="o">!=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">cosdeltaphi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cosdeltaphi</span><span class="p">))))</span>

    <span class="k">return</span> <span class="n">cosdeltaphi</span></div>


<div class="viewcode-block" id="eval_deltaphi"><a class="viewcode-back" href="../auto.html#precession.eval_deltaphi">[docs]</a><span class="k">def</span> <span class="nf">eval_deltaphi</span><span class="p">(</span><span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">cyclesign</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Angle between the projections of the two spins onto the orbital plane.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    deltachi: float</span>
<span class="sd">        Weighted spin difference.</span>
<span class="sd">    kappa: float</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    cyclesign: integer, optional (default: 1)</span>
<span class="sd">        Sign (either +1 or -1) to cover the two halves of a precesion cycle.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    deltaphi: float</span>
<span class="sd">        Angle between the projections of the two spins onto the orbital plane.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``deltaphi = precession.eval_deltaphi(deltachi,kappa,r,chieff,q,chi1,chi2,cyclesign=1)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cyclesign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">cyclesign</span><span class="p">)</span>
    <span class="n">cosdeltaphi</span> <span class="o">=</span> <span class="n">eval_cosdeltaphi</span><span class="p">(</span><span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
    <span class="n">deltaphi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">cyclesign</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">cosdeltaphi</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">deltaphi</span></div>


<div class="viewcode-block" id="eval_costhetaL"><a class="viewcode-back" href="../auto.html#precession.eval_costhetaL">[docs]</a><span class="k">def</span> <span class="nf">eval_costhetaL</span><span class="p">(</span><span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cosine of the angle betwen the orbital angular momentum and the total angular momentum.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    deltachi: float</span>
<span class="sd">        Weighted spin difference.</span>
<span class="sd">    kappa: float</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    costhetaL: float</span>
<span class="sd">        Cosine of the angle betwen orbital angular momentum and total angular momentum.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``costhetaL = precession.eval_costhetaL(deltachi,kappa,r,chieff,q)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">deltachi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">deltachi</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">kappa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">kappa</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chieff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chieff</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="c1"># Machine generated with eq_generator.nb</span>
    <span class="n">costhetaL</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> \
    <span class="n">kappa</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> \
    <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="n">deltachi</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="n">chieff</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">costhetaL</span></div>


<div class="viewcode-block" id="eval_thetaL"><a class="viewcode-back" href="../auto.html#precession.eval_thetaL">[docs]</a><span class="k">def</span> <span class="nf">eval_thetaL</span><span class="p">(</span><span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Angle betwen the orbital angular momentum and the total angular momentum.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    deltachi: float</span>
<span class="sd">        Weighted spin difference.</span>
<span class="sd">    kappa: float</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    thetaL: float</span>
<span class="sd">        Angle betwen orbital angular momentum and total angular momentum.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``thetaL = precession.eval_thetaL(deltachi,kappa,r,chieff,q)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">costhetaL</span> <span class="o">=</span> <span class="n">eval_costhetaL</span><span class="p">(</span><span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span><span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
    <span class="n">thetaL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">costhetaL</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">thetaL</span></div>


<div class="viewcode-block" id="eval_J"><a class="viewcode-back" href="../auto.html#precession.eval_J">[docs]</a><span class="k">def</span> <span class="nf">eval_J</span><span class="p">(</span><span class="n">theta1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">theta2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deltaphi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chi1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chi2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Magnitude of the total angular momentum. Provide either (theta1,theta2,deltaphi,r,q,chi1,chhi2) or (kappa,r,q).</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    theta1: float, optional (default: None)</span>
<span class="sd">        Angle between orbital angular momentum and primary spin.</span>
<span class="sd">    theta2: float, optional (default: None)</span>
<span class="sd">        Angle between orbital angular momentum and secondary spin.</span>
<span class="sd">    deltaphi: float, optional (default: None)</span>
<span class="sd">        Angle between the projections of the two spins onto the orbital plane.</span>
<span class="sd">    kappa: float, optional (default: None)</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    r: float, optional (default: None)</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    q: float, optional (default: None)</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float, optional (default: None)</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float, optional (default: None)</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    J: float</span>
<span class="sd">        Magnitude of the total angular momentum.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``J = precession.eval_J(theta1=theta1,theta2=theta2,deltaphi=deltaphi,r=r,q=q,chi1=chi1,chi2=chi2)``</span>
<span class="sd">    ``J = precession.eval_J(kappa=kappa,r=r,q=q,chi1=chi1,chi2=chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">theta1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">theta2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">deltaphi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">kappa</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chi1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chi2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">theta1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">theta1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">theta2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">theta2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">deltaphi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">deltaphi</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

        <span class="n">S1</span> <span class="o">=</span> <span class="n">eval_S1</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">)</span>
        <span class="n">S2</span> <span class="o">=</span> <span class="n">eval_S2</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">eval_L</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
        <span class="n">S</span> <span class="o">=</span> <span class="n">eval_S</span><span class="p">(</span><span class="n">theta1</span><span class="o">=</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="o">=</span><span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span><span class="o">=</span><span class="n">deltaphi</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="o">=</span><span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="o">=</span><span class="n">chi2</span><span class="p">)</span>
        <span class="n">J</span> <span class="o">=</span> <span class="p">(</span><span class="n">L</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">S</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">L</span><span class="o">*</span><span class="p">(</span><span class="n">S1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta1</span><span class="p">)</span><span class="o">+</span><span class="n">S2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta2</span><span class="p">)))</span><span class="o">**</span><span class="mf">0.5</span>

    <span class="k">elif</span> <span class="n">theta1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">theta2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">deltaphi</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">kappa</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chi1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chi2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">kappa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">kappa</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

        <span class="n">L</span> <span class="o">=</span> <span class="n">eval_L</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
        <span class="n">J</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">L</span><span class="o">*</span><span class="n">kappa</span> <span class="o">+</span> <span class="n">L</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Provide either (theta1,theta2,deltaphi,r,q,chi1,chhi2) or (kappa,r,q).&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">J</span></div>


<div class="viewcode-block" id="eval_kappa"><a class="viewcode-back" href="../auto.html#precession.eval_kappa">[docs]</a><span class="k">def</span> <span class="nf">eval_kappa</span><span class="p">(</span><span class="n">theta1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">theta2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deltaphi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">J</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chi1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chi2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Asymptotic angular momentum. Provide either (theta1,theta2,deltaphi,r,q,chi1,chhi2) or (J,r,q).</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    theta1: float, optional (default: None)</span>
<span class="sd">        Angle between orbital angular momentum and primary spin.</span>
<span class="sd">    theta2: float, optional (default: None)</span>
<span class="sd">        Angle between orbital angular momentum and secondary spin.</span>
<span class="sd">    deltaphi: float, optional (default: None)</span>
<span class="sd">        Angle between the projections of the two spins onto the orbital plane.</span>
<span class="sd">    J: float, optional (default: None)</span>
<span class="sd">        Magnitude of the total angular momentum.</span>
<span class="sd">    r: float, optional (default: None)</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    q: float, optional (default: None)</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float, optional (default: None)</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float, optional (default: None)</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    kappa: float</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``kappa = precession.eval_kappa(theta1=theta1,theta2=theta2,deltaphi=deltaphi,r=r,q=q,chi1=chi1,chi2=chi2)``</span>
<span class="sd">    ``kappa = precession.eval_kappa(J=J,r=r,q=q)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">theta1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">theta2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">deltaphi</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">J</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chi1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chi2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">J</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">eval_L</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
        <span class="n">kappa</span> <span class="o">=</span> <span class="p">(</span><span class="n">J</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">L</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">L</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">theta1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">theta2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">deltaphi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">J</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chi1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chi2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">theta1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">theta1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">theta2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">theta2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">deltaphi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">deltaphi</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">chi1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

        <span class="n">kappa</span> <span class="o">=</span> <span class="p">(</span><span class="n">chi1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta1</span><span class="p">)</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chi2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta2</span><span class="p">)</span> <span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> \
                <span class="p">(</span><span class="n">chi1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span><span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">chi1</span><span class="o">*</span><span class="n">chi2</span><span class="o">*</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta2</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">deltaphi</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta2</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Please provide provide either (theta1,theta2,deltaphi,r,q,chi1,chhi2) or (J,r,q).&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">kappa</span></div>


<div class="viewcode-block" id="eval_S"><a class="viewcode-back" href="../auto.html#precession.eval_S">[docs]</a><span class="k">def</span> <span class="nf">eval_S</span><span class="p">(</span><span class="n">theta1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">theta2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deltaphi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deltachi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chieff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chi1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chi2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Magnitude of the total spin. Valid inputs are either (theta1, theta2, deltaphi, q, chi1, chi2) or (deltachi, kappa, r, chieff, q).</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    S: float</span>
<span class="sd">        Magnitude of the total spin.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``S = precession.eval_S(theta1=theta1,theta2=theta2,deltaphi=deltaphi,q=q,chi1=chi1,chi2=chi2)``</span>
<span class="sd">    ``S = precession.eval_S(deltachi=deltachi,kappa=kappa,r=r,chieff=chieff,q=q)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">theta1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">theta2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">deltaphi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">deltachi</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">kappa</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">r</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chieff</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chi1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chi2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">theta1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">theta1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">theta2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">theta2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">deltaphi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">deltaphi</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

        <span class="n">S1</span> <span class="o">=</span> <span class="n">eval_S1</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">)</span>
        <span class="n">S2</span> <span class="o">=</span> <span class="n">eval_S2</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>

        <span class="n">S</span> <span class="o">=</span> <span class="p">(</span><span class="n">S1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">S2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">S1</span><span class="o">*</span><span class="n">S2</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">deltaphi</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta2</span><span class="p">)))</span><span class="o">**</span><span class="mf">0.5</span>

    <span class="k">if</span> <span class="n">theta1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">theta2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">deltaphi</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">deltachi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">kappa</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chieff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chi1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chi2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">deltachi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">deltachi</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">kappa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">kappa</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">chieff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chieff</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

        <span class="n">S</span> <span class="o">=</span> <span class="p">(</span> <span class="n">q</span> <span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">kappa</span> <span class="o">-</span> <span class="n">chieff</span> <span class="o">-</span> <span class="n">deltachi</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">q</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span> <span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Please provide provide either (theta1,theta2,deltaphi,r,q,chi1,chhi2) or (J,r,q).&quot;</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">S</span></div>


<span class="c1">################ Conversions ################</span>


<div class="viewcode-block" id="eval_cyclesign"><a class="viewcode-back" href="../auto.html#precession.eval_cyclesign">[docs]</a><span class="k">def</span> <span class="nf">eval_cyclesign</span><span class="p">(</span><span class="n">ddeltachidt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deltaphi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Lvec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">S1vec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">S2vec</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate if the input parameters are in the first of the second half of a precession cycle. We refer to this as the &#39;sign&#39; of a precession cycle, defined as +1 if deltachi is increasing and -1 deltachi is decreasing. Valid inputs are one and not more of the following:</span>
<span class="sd">        - dSdt</span>
<span class="sd">        - deltaphi</span>
<span class="sd">        - Lvec, S1vec, S2vec.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ddeltachidt: float, optional (default: None)</span>
<span class="sd">        Time derivative of the total spin.</span>
<span class="sd">    deltaphi: float, optional (default: None)</span>
<span class="sd">        Angle between the projections of the two spins onto the orbital plane.</span>
<span class="sd">    Lvec: array, optional (default: None)</span>
<span class="sd">        Cartesian vector of the orbital angular momentum.</span>
<span class="sd">    S1vec: array, optional (default: None)</span>
<span class="sd">        Cartesian vector of the primary spin.</span>
<span class="sd">    S2vec: array, optional (default: None)</span>
<span class="sd">        Cartesian vector of the secondary spin.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    cyclesign: integer</span>
<span class="sd">        Sign (either +1 or -1) to cover the two halves of a precesion cycle.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``cyclesign = precession.eval_cyclesign(ddeltachidt=ddeltachidt)``</span>
<span class="sd">    ``cyclesign = precession.eval_cyclesign(deltaphi=deltaphi)``</span>
<span class="sd">    ``cyclesign = precession.eval_cyclesign(Lvec=Lvec,S1vec=S1vec,S2vec=S2vec)``</span>
<span class="sd">    &quot;&quot;&quot;</span>



    <span class="k">if</span> <span class="n">ddeltachidt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">deltaphi</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">Lvec</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">S1vec</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">S2vec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ddeltachidt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">ddeltachidt</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">cyclesign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">ddeltachidt</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">ddeltachidt</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">deltaphi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">Lvec</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">S1vec</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">S2vec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">deltaphi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">deltaphi</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">cyclesign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">deltaphi</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">ddeltachidt</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">deltaphi</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">Lvec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">S1vec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">S2vec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">Lvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">Lvec</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">S1vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">S1vec</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">S2vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">S2vec</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">cyclesign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">dot_nested</span><span class="p">(</span><span class="n">S1vec</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">S2vec</span><span class="p">,</span> <span class="n">Lvec</span><span class="p">)))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Please provide one and not more of the following: ddeltachidt, deltaphi, (Lvec, S1vec, S2vec).&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cyclesign</span></div>


<div class="viewcode-block" id="conserved_to_angles"><a class="viewcode-back" href="../auto.html#precession.conserved_to_angles">[docs]</a><span class="k">def</span> <span class="nf">conserved_to_angles</span><span class="p">(</span><span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">cyclesign</span><span class="o">=+</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert conserved quantities (deltachi,kappa,chieff) into angles (theta1,theta2,deltaphi).</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    deltachi: float</span>
<span class="sd">        Weighted spin difference.</span>
<span class="sd">    kappa: float</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    cyclesign: integer, optional (default: +1)</span>
<span class="sd">        Sign (either +1 or -1) to cover the two halves of a precesion cycle.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    deltaphi: float</span>
<span class="sd">        Angle between the projections of the two spins onto the orbital plane.</span>
<span class="sd">    theta1: float</span>
<span class="sd">        Angle between orbital angular momentum and primary spin.</span>
<span class="sd">    theta2: float</span>
<span class="sd">        Angle between orbital angular momentum and secondary spin.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``theta1,theta2,deltaphi = precession.conserved_to_angles(deltachi,kappa,r,chieff,q,chi1,chi2,cyclesign=+1)``</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="n">theta1</span><span class="o">=</span> <span class="n">eval_theta1</span><span class="p">(</span><span class="n">deltachi</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">)</span>
    <span class="n">theta2</span> <span class="o">=</span> <span class="n">eval_theta2</span><span class="p">(</span><span class="n">deltachi</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
    <span class="n">deltaphi</span> <span class="o">=</span> <span class="n">eval_deltaphi</span><span class="p">(</span><span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">cyclesign</span><span class="o">=</span><span class="n">cyclesign</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span><span class="p">])</span></div>


<div class="viewcode-block" id="angles_to_conserved"><a class="viewcode-back" href="../auto.html#precession.angles_to_conserved">[docs]</a><span class="k">def</span> <span class="nf">angles_to_conserved</span><span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">full_output</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert angles (theta1,theta2,deltaphi) into conserved quantities (deltachi,kappa,chieff).</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    theta1: float</span>
<span class="sd">        Angle between orbital angular momentum and primary spin.</span>
<span class="sd">    theta2: float</span>
<span class="sd">        Angle between orbital angular momentum and secondary spin.</span>
<span class="sd">    deltaphi: float</span>
<span class="sd">        Angle between the projections of the two spins onto the orbital plane.</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    full_output: boolean, optional (default: False)</span>
<span class="sd">        Return additional outputs.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    cyclesign: integer, optional</span>
<span class="sd">        Sign (either +1 or -1) to cover the two halves of a precesion cycle.</span>
<span class="sd">    deltachi: float</span>
<span class="sd">        Weighted spin difference.</span>
<span class="sd">    kappa: float</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``deltachi,kappa,chieff = precession.angles_to_conserved(theta1,theta2,deltaphi,r,q,chi1,chi2)``</span>
<span class="sd">    ``deltachi,kappa,chieff,cyclesign = precession.angles_to_conserved(theta1,theta2,deltaphi,r,q,chi1,chi2,full_output=True)``</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="n">deltachi</span> <span class="o">=</span> <span class="n">eval_deltachi</span><span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
    <span class="n">kappa</span> <span class="o">=</span> <span class="n">eval_kappa</span><span class="p">(</span><span class="n">theta1</span><span class="o">=</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="o">=</span><span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span><span class="o">=</span><span class="n">deltaphi</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="o">=</span><span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="o">=</span><span class="n">chi2</span><span class="p">)</span>
    <span class="n">chieff</span> <span class="o">=</span> <span class="n">eval_chieff</span><span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">full_output</span><span class="p">:</span>
        <span class="n">cyclesign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">r</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span><span class="n">eval_cyclesign</span><span class="p">(</span><span class="n">deltaphi</span><span class="o">=</span><span class="n">deltaphi</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">cyclesign</span><span class="p">])</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">chieff</span><span class="p">])</span></div>


<div class="viewcode-block" id="vectors_to_angles"><a class="viewcode-back" href="../auto.html#precession.vectors_to_angles">[docs]</a><span class="k">def</span> <span class="nf">vectors_to_angles</span><span class="p">(</span><span class="n">Lvec</span><span class="p">,</span> <span class="n">S1vec</span><span class="p">,</span> <span class="n">S2vec</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert cartesian vectors (L,S1,S2) into angles (theta1,theta2,deltaphi).</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Lvec: array</span>
<span class="sd">        Cartesian vector of the orbital angular momentum.</span>
<span class="sd">    S1vec: array</span>
<span class="sd">        Cartesian vector of the primary spin.</span>
<span class="sd">    S2vec: array</span>
<span class="sd">        Cartesian vector of the secondary spin.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    deltaphi: float</span>
<span class="sd">        Angle between the projections of the two spins onto the orbital plane.</span>
<span class="sd">    theta1: float</span>
<span class="sd">        Angle between orbital angular momentum and primary spin.</span>
<span class="sd">    theta2: float</span>
<span class="sd">        Angle between orbital angular momentum and secondary spin.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``theta1,theta2,deltaphi = precession.vectors_to_angles(Lvec,S1vec,S2vec)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">Lvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">Lvec</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">S1vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">S1vec</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">S2vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">S2vec</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">S1vec</span> <span class="o">=</span> <span class="n">normalize_nested</span><span class="p">(</span><span class="n">S1vec</span><span class="p">)</span>
    <span class="n">S2vec</span> <span class="o">=</span> <span class="n">normalize_nested</span><span class="p">(</span><span class="n">S2vec</span><span class="p">)</span>
    <span class="n">Lvec</span> <span class="o">=</span> <span class="n">normalize_nested</span><span class="p">(</span><span class="n">Lvec</span><span class="p">)</span>

    <span class="n">theta1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">dot_nested</span><span class="p">(</span><span class="n">S1vec</span><span class="p">,</span> <span class="n">Lvec</span><span class="p">))</span>
    <span class="n">theta2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">dot_nested</span><span class="p">(</span><span class="n">S2vec</span><span class="p">,</span> <span class="n">Lvec</span><span class="p">))</span>
    <span class="n">S1crL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">S1vec</span><span class="p">,</span> <span class="n">Lvec</span><span class="p">)</span>
    <span class="n">S2crL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">S2vec</span><span class="p">,</span> <span class="n">Lvec</span><span class="p">)</span>

    <span class="n">absdeltaphi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">dot_nested</span><span class="p">(</span><span class="n">normalize_nested</span><span class="p">(</span><span class="n">S1crL</span><span class="p">),</span> <span class="n">normalize_nested</span><span class="p">(</span><span class="n">S2crL</span><span class="p">)))</span>
    <span class="n">cyclesign</span> <span class="o">=</span> <span class="n">eval_cyclesign</span><span class="p">(</span><span class="n">Lvec</span><span class="o">=</span><span class="n">Lvec</span><span class="p">,</span> <span class="n">S1vec</span><span class="o">=</span><span class="n">S1vec</span><span class="p">,</span> <span class="n">S2vec</span><span class="o">=</span><span class="n">S2vec</span><span class="p">)</span>
    <span class="n">deltaphi</span> <span class="o">=</span> <span class="n">absdeltaphi</span><span class="o">*</span><span class="n">cyclesign</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span><span class="p">])</span></div>


<div class="viewcode-block" id="vectors_to_Jframe"><a class="viewcode-back" href="../auto.html#precession.vectors_to_Jframe">[docs]</a><span class="k">def</span> <span class="nf">vectors_to_Jframe</span><span class="p">(</span><span class="n">Lvec</span><span class="p">,</span> <span class="n">S1vec</span><span class="p">,</span> <span class="n">S2vec</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rotate vectors of the three momenta onto a frame where J is along z and L lies in the x-z plane.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Lvec: array</span>
<span class="sd">        Cartesian vector of the orbital angular momentum.</span>
<span class="sd">    S1vec: array</span>
<span class="sd">        Cartesian vector of the primary spin.</span>
<span class="sd">    S2vec: array</span>
<span class="sd">        Cartesian vector of the secondary spin.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Lvec: array</span>
<span class="sd">        Cartesian vector of the orbital angular momentum.</span>
<span class="sd">    S1vec: array</span>
<span class="sd">        Cartesian vector of the primary spin.</span>
<span class="sd">    S2vec: array</span>
<span class="sd">        Cartesian vector of the secondary spin.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``Lvec,S1vec,S2vec = precession.vectors_to_Jframe(Lvec,S1vec,S2vec)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">Jvec</span> <span class="o">=</span> <span class="n">Lvec</span> <span class="o">+</span> <span class="n">S1vec</span> <span class="o">+</span> <span class="n">S2vec</span>

    <span class="n">rotation</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">vec</span><span class="p">:</span> <span class="n">rotate_nested</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">Jvec</span><span class="p">,</span> <span class="n">Lvec</span><span class="p">)</span>

    <span class="n">Lvecrot</span> <span class="o">=</span> <span class="n">rotation</span><span class="p">(</span><span class="n">Lvec</span><span class="p">)</span>
    <span class="n">S1vecrot</span> <span class="o">=</span> <span class="n">rotation</span><span class="p">(</span><span class="n">S1vec</span><span class="p">)</span>
    <span class="n">S2vecrot</span> <span class="o">=</span> <span class="n">rotation</span><span class="p">(</span><span class="n">S2vec</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">Lvecrot</span><span class="p">,</span> <span class="n">S1vecrot</span><span class="p">,</span> <span class="n">S2vecrot</span><span class="p">])</span></div>


<div class="viewcode-block" id="vectors_to_Lframe"><a class="viewcode-back" href="../auto.html#precession.vectors_to_Lframe">[docs]</a><span class="k">def</span> <span class="nf">vectors_to_Lframe</span><span class="p">(</span><span class="n">Lvec</span><span class="p">,</span> <span class="n">S1vec</span><span class="p">,</span> <span class="n">S2vec</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rotate vectors of the three momenta onto a frame where L is along z and S1 lies in the x-z plane.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Lvec: array</span>
<span class="sd">        Cartesian vector of the orbital angular momentum.</span>
<span class="sd">    S1vec: array</span>
<span class="sd">        Cartesian vector of the primary spin.</span>
<span class="sd">    S2vec: array</span>
<span class="sd">        Cartesian vector of the secondary spin.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Lvec: array</span>
<span class="sd">        Cartesian vector of the orbital angular momentum.</span>
<span class="sd">    S1vec: array</span>
<span class="sd">        Cartesian vector of the primary spin.</span>
<span class="sd">    S2vec: array</span>
<span class="sd">        Cartesian vector of the secondary spin.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``Lvec,S1vec,S2vec = precession.vectors_to_Lframe(Lvec,S1vec,S2vec)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">Jvec</span> <span class="o">=</span> <span class="n">Lvec</span> <span class="o">+</span> <span class="n">S1vec</span> <span class="o">+</span> <span class="n">S2vec</span>

    <span class="n">rotation</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">vec</span><span class="p">:</span> <span class="n">rotate_nested</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">Lvec</span><span class="p">,</span> <span class="n">S1vec</span><span class="p">)</span>

    <span class="n">Lvecrot</span> <span class="o">=</span> <span class="n">rotation</span><span class="p">(</span><span class="n">Lvec</span><span class="p">)</span>
    <span class="n">S1vecrot</span> <span class="o">=</span> <span class="n">rotation</span><span class="p">(</span><span class="n">S1vec</span><span class="p">)</span>
    <span class="n">S2vecrot</span> <span class="o">=</span> <span class="n">rotation</span><span class="p">(</span><span class="n">S2vec</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">Lvecrot</span><span class="p">,</span> <span class="n">S1vecrot</span><span class="p">,</span> <span class="n">S2vecrot</span><span class="p">])</span></div>


<div class="viewcode-block" id="angles_to_Lframe"><a class="viewcode-back" href="../auto.html#precession.angles_to_Lframe">[docs]</a><span class="k">def</span> <span class="nf">angles_to_Lframe</span><span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert the angles (theta1,theta2,deltaphi) to angular momentum vectors (L,S1,S2) in the frame</span>
<span class="sd">    aligned with the orbital angular momentum. In particular, we set Lx=Ly=S1y=0.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    theta1: float</span>
<span class="sd">        Angle between orbital angular momentum and primary spin.</span>
<span class="sd">    theta2: float</span>
<span class="sd">        Angle between orbital angular momentum and secondary spin.</span>
<span class="sd">    deltaphi: float</span>
<span class="sd">        Angle between the projections of the two spins onto the orbital plane.</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Lvec: array</span>
<span class="sd">        Cartesian vector of the orbital angular momentum.</span>
<span class="sd">    S1vec: array</span>
<span class="sd">        Cartesian vector of the primary spin.</span>
<span class="sd">    S2vec: array</span>
<span class="sd">        Cartesian vector of the secondary spin.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``Lvec,S1vec,S2vec = precession.angles_to_Lframe(theta1,theta2,deltaphi,r,q,chi1,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">L</span> <span class="o">=</span> <span class="n">eval_L</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
    <span class="n">S1</span> <span class="o">=</span> <span class="n">eval_S1</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">)</span>
    <span class="n">S2</span> <span class="o">=</span> <span class="n">eval_S2</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>

    <span class="n">Lx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Ly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Lz</span> <span class="o">=</span> <span class="n">L</span>
    <span class="n">Lvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span><span class="n">Lx</span><span class="p">,</span> <span class="n">Ly</span><span class="p">,</span> <span class="n">Lz</span><span class="p">])</span>

    <span class="n">S1x</span> <span class="o">=</span> <span class="n">S1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta1</span><span class="p">)</span>
    <span class="n">S1y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">S1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">S1z</span> <span class="o">=</span> <span class="n">S1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta1</span><span class="p">)</span>
    <span class="n">S1vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span><span class="n">S1x</span><span class="p">,</span> <span class="n">S1y</span><span class="p">,</span> <span class="n">S1z</span><span class="p">])</span>

    <span class="n">S2x</span> <span class="o">=</span> <span class="n">S2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">deltaphi</span><span class="p">)</span>
    <span class="n">S2y</span> <span class="o">=</span> <span class="n">S2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">deltaphi</span><span class="p">)</span>
    <span class="n">S2z</span> <span class="o">=</span> <span class="n">S2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta2</span><span class="p">)</span>
    <span class="n">S2vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span><span class="n">S2x</span><span class="p">,</span> <span class="n">S2y</span><span class="p">,</span> <span class="n">S2z</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">Lvec</span><span class="p">,</span> <span class="n">S1vec</span><span class="p">,</span> <span class="n">S2vec</span><span class="p">])</span></div>


<div class="viewcode-block" id="angles_to_Jframe"><a class="viewcode-back" href="../auto.html#precession.angles_to_Jframe">[docs]</a><span class="k">def</span> <span class="nf">angles_to_Jframe</span><span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert the angles (theta1,theta2,deltaphi) to angular momentum vectors (L,S1,S2) in the frame</span>
<span class="sd">    aligned with the total angular momentum. In particular, we set Jx=Jy=Ly=0.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    theta1: float</span>
<span class="sd">        Angle between orbital angular momentum and primary spin.</span>
<span class="sd">    theta2: float</span>
<span class="sd">        Angle between orbital angular momentum and secondary spin.</span>
<span class="sd">    deltaphi: float</span>
<span class="sd">        Angle between the projections of the two spins onto the orbital plane.</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Lvec: array</span>
<span class="sd">        Cartesian vector of the orbital angular momentum.</span>
<span class="sd">    S1vec: array</span>
<span class="sd">        Cartesian vector of the primary spin.</span>
<span class="sd">    S2vec: array</span>
<span class="sd">        Cartesian vector of the secondary spin.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``Lvec,S1vec,S2vec = precession.angles_to_Jframe(theta1,theta2,deltaphi,r,q,chi1,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">Lvec</span><span class="p">,</span> <span class="n">S1vec</span><span class="p">,</span> <span class="n">S2vec</span> <span class="o">=</span> <span class="n">angles_to_Lframe</span><span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
    <span class="n">Lvec</span><span class="p">,</span> <span class="n">S1vec</span><span class="p">,</span> <span class="n">S2vec</span> <span class="o">=</span> <span class="n">vectors_to_Jframe</span><span class="p">(</span><span class="n">Lvec</span><span class="p">,</span> <span class="n">S1vec</span><span class="p">,</span> <span class="n">S2vec</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">Lvec</span><span class="p">,</span> <span class="n">S1vec</span><span class="p">,</span> <span class="n">S2vec</span><span class="p">])</span></div>


<div class="viewcode-block" id="conserved_to_Lframe"><a class="viewcode-back" href="../auto.html#precession.conserved_to_Lframe">[docs]</a><span class="k">def</span> <span class="nf">conserved_to_Lframe</span><span class="p">(</span><span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">cyclesign</span><span class="o">=+</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert the conserved quanties (deltachi,kappa,chieff) to angular momentum vectors (L,S1,S2) in the frame</span>
<span class="sd">    aligned with the orbital angular momentum. In particular, we set Lx=Ly=S1y=0.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    deltachi: float</span>
<span class="sd">        Weighted spin difference.</span>
<span class="sd">    kappa: float</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    cyclesign: integer, optional (default: +1)</span>
<span class="sd">        Sign (either +1 or -1) to cover the two halves of a precesion cycle.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Lvec: array</span>
<span class="sd">        Cartesian vector of the orbital angular momentum.</span>
<span class="sd">    S1vec: array</span>
<span class="sd">        Cartesian vector of the primary spin.</span>
<span class="sd">    S2vec: array</span>
<span class="sd">        Cartesian vector of the secondary spin.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``Lvec,S1vec,S2vec = precession.conserved_to_Lframe(deltachi,kappa,r,chieff,q,chi1,chi2,cyclesign=+1)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">theta1</span><span class="p">,</span><span class="n">theta2</span><span class="p">,</span><span class="n">deltaphi</span> <span class="o">=</span> <span class="n">conserved_to_angles</span><span class="p">(</span><span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">cyclesign</span><span class="o">=</span><span class="n">cyclesign</span><span class="p">)</span>
    <span class="n">Lvec</span><span class="p">,</span> <span class="n">S1vec</span><span class="p">,</span> <span class="n">S2vec</span> <span class="o">=</span> <span class="n">angles_to_Lframe</span><span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">Lvec</span><span class="p">,</span> <span class="n">S1vec</span><span class="p">,</span> <span class="n">S2vec</span><span class="p">])</span></div>


<div class="viewcode-block" id="conserved_to_Jframe"><a class="viewcode-back" href="../auto.html#precession.conserved_to_Jframe">[docs]</a><span class="k">def</span> <span class="nf">conserved_to_Jframe</span><span class="p">(</span><span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">cyclesign</span><span class="o">=+</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert the conserved quanties (deltachi,kappa,chieff) to angular momentum vectors (L,S1,S2) in the frame</span>
<span class="sd">    aligned with the total angular momentum. In particular, we set Jx=Jy=Ly=0.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    deltachi: float</span>
<span class="sd">        Weighted spin difference.</span>
<span class="sd">    kappa: float</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    cyclesign: integer, optional (default: +1)</span>
<span class="sd">        Sign (either +1 or -1) to cover the two halves of a precesion cycle.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Lvec: array</span>
<span class="sd">        Cartesian vector of the orbital angular momentum.</span>
<span class="sd">    S1vec: array</span>
<span class="sd">        Cartesian vector of the primary spin.</span>
<span class="sd">    S2vec: array</span>
<span class="sd">        Cartesian vector of the secondary spin.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``Lvec,S1vec,S2vec = precession.conserved_to_Jframe(deltachi,kappa,r,chieff,q,chi1,chi2,cyclesign=+1)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">theta1</span><span class="p">,</span><span class="n">theta2</span><span class="p">,</span><span class="n">deltaphi</span> <span class="o">=</span> <span class="n">conserved_to_angles</span><span class="p">(</span><span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">cyclesign</span><span class="o">=</span><span class="n">cyclesign</span><span class="p">)</span>
    <span class="n">Lvec</span><span class="p">,</span> <span class="n">S1vec</span><span class="p">,</span> <span class="n">S2vec</span> <span class="o">=</span> <span class="n">angles_to_Jframe</span><span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">Lvec</span><span class="p">,</span> <span class="n">S1vec</span><span class="p">,</span> <span class="n">S2vec</span><span class="p">])</span></div>


<div class="viewcode-block" id="vectors_to_conserved"><a class="viewcode-back" href="../auto.html#precession.vectors_to_conserved">[docs]</a><span class="k">def</span> <span class="nf">vectors_to_conserved</span><span class="p">(</span><span class="n">Lvec</span><span class="p">,</span> <span class="n">S1vec</span><span class="p">,</span> <span class="n">S2vec</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span><span class="n">full_output</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert vectors (L,S1,S2) to conserved quanties (deltachi,kappa,chieff).</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Lvec: array</span>
<span class="sd">        Cartesian vector of the orbital angular momentum.</span>
<span class="sd">    S1vec: array</span>
<span class="sd">        Cartesian vector of the primary spin.</span>
<span class="sd">    S2vec: array</span>
<span class="sd">        Cartesian vector of the secondary spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    full_output: boolean, optional (default: False)</span>
<span class="sd">        Return additional outputs.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    cyclesign: integer, optional</span>
<span class="sd">        Sign (either +1 or -1) to cover the two halves of a precesion cycle.</span>
<span class="sd">    deltachi: float</span>
<span class="sd">        Weighted spin difference.</span>
<span class="sd">    kappa: float</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``deltachi,kappa,chieff = precession.vectors_to_conserved(Lvec,S1vec,S2vec,q)``</span>
<span class="sd">    ``deltachi,kappa,chieff,cyclesign = precession.vectors_to_conserved(Lvec,S1vec,S2vec,q,full_output=True)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">L</span> <span class="o">=</span> <span class="n">norm_nested</span><span class="p">(</span><span class="n">Lvec</span><span class="p">)</span>
    <span class="n">S1</span> <span class="o">=</span> <span class="n">norm_nested</span><span class="p">(</span><span class="n">S1vec</span><span class="p">)</span>
    <span class="n">S2</span> <span class="o">=</span> <span class="n">norm_nested</span><span class="p">(</span><span class="n">S2vec</span><span class="p">)</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">eval_r</span><span class="p">(</span><span class="n">L</span><span class="o">=</span><span class="n">L</span><span class="p">,</span><span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">)</span>
    <span class="n">chi1</span> <span class="o">=</span> <span class="n">eval_chi1</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">S1</span><span class="p">)</span>
    <span class="n">chi2</span> <span class="o">=</span> <span class="n">eval_chi2</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">S2</span><span class="p">)</span>

    <span class="n">theta1</span><span class="p">,</span><span class="n">theta2</span><span class="p">,</span><span class="n">deltaphi</span> <span class="o">=</span> <span class="n">vectors_to_angles</span><span class="p">(</span><span class="n">Lvec</span><span class="p">,</span> <span class="n">S1vec</span><span class="p">,</span> <span class="n">S2vec</span><span class="p">)</span>

    <span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">cyclesign</span><span class="o">=</span> <span class="n">angles_to_conserved</span><span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">full_output</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">cyclesign</span><span class="p">])</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">chieff</span><span class="p">])</span></div>


<span class="c1">################ Spin-orbit resonances ################</span>


<div class="viewcode-block" id="kappadiscriminant_coefficients"><a class="viewcode-back" href="../auto.html#precession.kappadiscriminant_coefficients">[docs]</a><span class="k">def</span> <span class="nf">kappadiscriminant_coefficients</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Coefficients of the quintic equation in kappa that defines the spin-orbit resonances.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    u: float</span>
<span class="sd">        Compactified separation 1/(2L).</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    coeff0: float</span>
<span class="sd">        Coefficient to the x^0 term in polynomial.</span>
<span class="sd">    coeff1: float</span>
<span class="sd">        Coefficient to the x^1 term in polynomial.</span>
<span class="sd">    coeff2: float</span>
<span class="sd">        Coefficient to the x^2 term in polynomial.</span>
<span class="sd">    coeff3: float</span>
<span class="sd">        Coefficient to the x^3 term in polynomial.</span>
<span class="sd">    coeff4: float</span>
<span class="sd">        Coefficient to the x^4 term in polynomial.</span>
<span class="sd">    coeff5: float</span>
<span class="sd">        Coefficient to the x^5 term in polynomial.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``coeff5,coeff4,coeff3,coeff2,coeff1,coeff0 = precession.kappadiscriminant_coefficients(u,chieff,q,chi1,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chieff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chieff</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">coeff5</span> <span class="o">=</span> <span class="o">-</span><span class="n">u</span>

    <span class="c1"># Machine generated with eq_generator.nb</span>
    <span class="n">coeff4</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">16</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">6</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">+</span> \
    <span class="p">(</span><span class="mi">80</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chi1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">40</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">80</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">40</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="mi">8</span> \
    <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">160</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> \
    <span class="p">(</span><span class="o">-</span><span class="mi">3</span> <span class="o">*</span> <span class="n">chi1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">160</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">*</span> \
    <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">3</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)))))))))</span>

    <span class="c1"># Machine generated with eq_generator.nb</span>
    <span class="n">coeff3</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">8</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="p">(((</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> \
    <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">8</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">((</span><span class="mi">10</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">12</span> <span class="o">*</span> <span class="n">q</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> \
    <span class="n">chi1</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">chi1</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">3</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">11</span> <span class="o">*</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)))))</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> \
    <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">3</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> \
    <span class="p">(</span><span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">))))))</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> \
    <span class="n">chieff</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">20</span> <span class="o">+</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">q</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">chi1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">q</span> <span class="o">*</span> <span class="p">(</span><span class="mi">20</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">12</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> \
    <span class="p">(</span><span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">12</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">3</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">))))))</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">((</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> \
    <span class="mi">5</span> <span class="o">*</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="n">chi1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">q</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">5</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">40</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">7</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">11</span> <span class="o">*</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">40</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">5</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">64</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">))))))))))</span>

    <span class="c1"># Machine generated with eq_generator.nb</span>
    <span class="n">coeff2</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">16</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">12</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">16</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">10</span> <span class="o">+</span> <span class="p">(</span><span class="mi">18</span> <span class="o">*</span> \
    <span class="n">q</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">9</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">3</span><span class="p">)))</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chi1</span><span class="o">**</span><span class="mi">6</span> <span class="o">+</span> <span class="p">(</span><span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> \
    <span class="p">(</span><span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span><span class="p">)))</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">59</span> <span class="o">+</span> <span class="p">(</span><span class="mi">144</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">40</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">6</span> <span class="o">+</span> <span class="p">(</span><span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> \
    <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">12</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span><span class="p">)</span> <span class="o">+</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="mi">24</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)))))</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">4</span> <span class="o">*</span> \
    <span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span><span class="p">)</span> <span class="o">+</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">19</span> <span class="o">+</span> <span class="p">(</span><span class="mi">126</span> \
    <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="mi">24</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> \
    <span class="o">+</span> <span class="p">(</span><span class="mi">43</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">201</span> <span class="o">+</span> \
    <span class="p">(</span><span class="mi">3920</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="mi">976</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">5</span> <span class="o">*</span> \
    <span class="p">(</span><span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">13</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2430</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="mi">704</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">72</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">3</span> \
    <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">3</span><span class="p">))))</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">7</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="mi">19</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">27</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1218</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="mi">392</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">20</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="p">(</span><span class="mi">169</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">32</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">3</span><span class="p">)))))</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">288</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">6</span> <span class="o">+</span> <span class="p">(</span><span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">59</span> <span class="o">+</span> <span class="p">(</span><span class="mi">144</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">67</span> <span class="o">+</span> <span class="p">(</span><span class="mi">204</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="mi">48</span> <span class="o">*</span> \
    <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">95</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="p">(</span><span class="mi">296</span> <span class="o">*</span> \
    <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">48</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">3</span><span class="p">))))))</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">9</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> \
    <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="mi">13</span> <span class="o">+</span> <span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="o">-</span><span class="mi">8</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> \
    <span class="p">(</span><span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">13</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2430</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="mi">704</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="mi">2</span> \
    <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">70</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="p">(</span><span class="mi">379</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">100</span> <span class="o">*</span> \
    <span class="n">u</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">3</span><span class="p">)))))</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">36</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">6</span> <span class="o">+</span> <span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="mi">5</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">16</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="mi">24</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">19</span> <span class="o">+</span> <span class="p">(</span><span class="mi">126</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="mi">24</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">102</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="p">(</span><span class="mi">406</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">112</span> <span class="o">*</span> \
    <span class="n">u</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">3</span><span class="p">))))))</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">53</span> <span class="o">+</span> <span class="p">(</span><span class="mi">28</span> <span class="o">*</span> <span class="n">u</span> \
    <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">261</span> <span class="o">+</span> <span class="p">(</span><span class="mi">16416</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> \
    <span class="n">chieff</span> <span class="o">+</span> <span class="mi">5152</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">7</span> <span class="o">+</span> <span class="p">(</span><span class="mi">189</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> \
    <span class="n">chieff</span> <span class="o">+</span> <span class="p">(</span><span class="mi">614</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">120</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">3</span><span class="p">)))))</span> <span class="o">+</span> \
    <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">6</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">8</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">261</span> <span class="o">+</span> <span class="p">(</span><span class="mi">16416</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> \
    <span class="n">chieff</span> <span class="o">+</span> <span class="mi">5152</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">17</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">338</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> \
    <span class="n">chieff</span> <span class="o">+</span> <span class="p">(</span><span class="mi">424</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">128</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">3</span><span class="p">)))))</span> <span class="o">+</span> \
    <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">10</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">16</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">6</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">121</span> <span class="o">+</span> <span class="p">(</span><span class="mi">136</span> \
    <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="mi">40</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">201</span> <span class="o">+</span> <span class="p">(</span><span class="mi">3920</span> <span class="o">*</span> \
    <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="mi">976</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">17</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">148</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> \
    <span class="n">chieff</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2680</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">832</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">3</span><span class="p">))))))</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> \
    <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chi1</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">8</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">7</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">19</span> <span class="o">+</span> <span class="p">(</span><span class="mi">36</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">8</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="mi">24</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> \
    <span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">5</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">16</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="mi">24</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> \
    <span class="p">(</span><span class="o">-</span><span class="mi">67</span> <span class="o">+</span> <span class="p">(</span><span class="mi">204</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="mi">48</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">13</span> \
    <span class="o">+</span> <span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span> <span class="o">+</span> \
    <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">6</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">53</span> <span class="o">+</span> <span class="p">(</span><span class="mi">28</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">27</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">121</span> <span class="o">+</span> <span class="p">(</span><span class="mi">136</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">18</span> \
    <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)))))))))))</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">chi1</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="o">+</span> \
    <span class="p">(</span><span class="o">-</span><span class="mi">6</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">16</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="o">-</span><span class="mi">96</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> \
    <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">190</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">592</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">96</span> <span class="o">*</span> \
    <span class="n">u</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">3</span><span class="p">)))</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">10</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">288</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">86</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> \
    <span class="n">chieff</span> <span class="o">+</span> <span class="p">(</span><span class="mi">24</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)))))</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">102</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="p">(</span><span class="mi">112</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">15</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">406</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">))))</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">9</span> \
    <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">72</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">3</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">29</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">24</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> \
    <span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)))))</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">17</span> <span class="o">+</span> <span class="p">(</span><span class="mi">148</span> <span class="o">*</span> \
    <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">670</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> \
    <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="o">-</span><span class="mi">104</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">3</span><span class="p">))))</span> <span class="o">+</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">70</span> <span class="o">*</span> <span class="n">u</span> \
    <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="p">(</span><span class="mi">12</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">29</span> <span class="o">*</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">379</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="o">-</span><span class="mi">25</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">3</span><span class="p">)))))</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">6</span> <span class="o">*</span> <span class="p">(</span><span class="mi">7</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">189</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">614</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">*</span> \
    <span class="n">u</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">7</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="o">-</span><span class="mi">20</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">3</span><span class="p">)))))</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">17</span> <span class="o">+</span> \
    <span class="p">(</span><span class="mi">338</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">106</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">16</span> <span class="o">*</span> \
    <span class="n">u</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="mi">27</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">21</span> <span class="o">*</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="o">-</span><span class="mi">16</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">3</span><span class="p">)))))</span> <span class="o">+</span> <span class="o">-</span><span class="mi">8</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">7</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">20</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> \
    <span class="n">chieff</span> <span class="o">+</span> <span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">43</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">169</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="mi">9</span> <span class="o">*</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="o">-</span><span class="mi">8</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> \
    <span class="n">chieff</span> <span class="o">+</span> <span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">3</span><span class="p">)))))))))))))))))))))))))))))))))))</span>

    <span class="c1"># Machine generated with eq_generator.nb</span>
    <span class="n">coeff1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">8</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">16</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">((</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> \
    <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">*</span> <span class="p">(((</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chi1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">q</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">3</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> \
    <span class="o">-</span><span class="mi">3</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">))))))</span> <span class="o">+</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> \
    <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">chi1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mi">5</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">7</span> <span class="o">*</span> <span class="n">q</span> \
    <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">chi1</span><span class="o">**</span><span class="mi">6</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="n">chi1</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">7</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> \
    <span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">5</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">7</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">))))))</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> \
    <span class="n">chi1</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">7</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">5</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">7</span> <span class="o">*</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">))))))</span> \
    <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">8</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span> \
    <span class="o">*</span> <span class="p">(</span><span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">7</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)))))))</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">*</span> <span class="p">((</span><span class="mi">20</span> <span class="o">+</span> \
    <span class="p">(</span><span class="o">-</span><span class="mi">49</span> <span class="o">*</span> <span class="n">q</span> <span class="o">+</span> <span class="p">(</span><span class="mi">41</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">12</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">3</span><span class="p">)))</span> <span class="o">*</span> <span class="n">chi1</span><span class="o">**</span><span class="mi">6</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chi1</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">3</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">6</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> \
    <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">22</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">28</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">14</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> \
    <span class="mi">4</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">7</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">5</span> <span class="o">*</span> \
    <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)))))))</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">8</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="mi">20</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">5</span> <span class="o">*</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">12</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">41</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> \
    <span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">49</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">))))))</span> <span class="o">+</span> <span class="n">q</span> <span class="o">*</span> <span class="n">chi1</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="mi">22</span> <span class="o">*</span> \
    <span class="n">q</span><span class="o">**</span><span class="mi">5</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">8</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">6</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">12</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="mi">7</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">6</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> \
    <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">))))))))))</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">8</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="p">(((</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> \
    <span class="n">chi1</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(((</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chi1</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">14</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">5</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">6</span> <span class="o">*</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">16</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="mi">26</span> <span class="o">*</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">7</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">14</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">32</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> \
    <span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">42</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)))))))</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">8</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> \
    <span class="p">(</span><span class="o">-</span><span class="mi">56</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> \
    <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">7</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">18</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> \
    <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">15</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">152</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">7</span> <span class="o">*</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">152</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">104</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">6</span> <span class="o">*</span> <span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">8</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">))</span> <span class="o">+</span> <span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">))))))))))))</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> \
    <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">((</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">15</span> <span class="o">*</span> <span class="n">q</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">chi1</span><span class="o">**</span><span class="mi">6</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">q</span> \
    <span class="o">*</span> <span class="n">chi1</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">6</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">7</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">24</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">16</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="mi">143</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">32</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">5</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">17</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">5</span> <span class="o">*</span> \
    <span class="p">(</span><span class="o">-</span><span class="mi">87</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">15</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">32</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">))))))))</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chi1</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">15</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">9</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">24</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="mi">85</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="o">-</span><span class="mi">4</span> <span class="o">*</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">7</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">143</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">24</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">48</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> \
    <span class="o">-</span><span class="mi">44</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> \
    <span class="o">+</span> <span class="o">-</span><span class="mi">30</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">6</span> <span class="o">*</span> <span class="p">(</span><span class="mi">87</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">20</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">24</span> \
    <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">))</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">40</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">))))))))))</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">6</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">8</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">24</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">88</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">20</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> \
    <span class="o">+</span> <span class="o">-</span><span class="mi">6</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">7</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">17</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">24</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">16</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> \
    <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">6</span> <span class="o">*</span> <span class="p">(</span><span class="mi">27</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">16</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">))</span> \
    <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">7</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">32</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">24</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">))</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">40</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">)))))))))))))</span> <span class="o">+</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">7</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">((</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> \
    <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">3</span> <span class="o">+</span> <span class="p">(</span><span class="mi">49</span> <span class="o">*</span> <span class="n">q</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">chi1</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> \
    <span class="n">chi1</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">22</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">15</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">5</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">6</span> <span class="o">*</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> \
    <span class="o">+</span> <span class="o">-</span><span class="mi">7</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">15</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">38</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)))))))</span> \
    <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">8</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">16</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">80</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span> \
    <span class="o">+</span> <span class="p">(</span><span class="mi">160</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">6</span> <span class="o">*</span> <span class="p">(</span><span class="mi">85</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">7</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">55</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> \
    <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">17</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">44</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">))</span> \
    <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">19</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">40</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> \
    <span class="p">(</span><span class="o">-</span><span class="mi">16</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">132</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">80</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">)))))))))))))))))</span>


    <span class="c1"># Machine generated with eq_generator.nb</span>
    <span class="n">coeff0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">16</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">)</span> <span class="o">*</span> <span class="p">(((</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> \
    <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">((</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chi1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> \
    <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)))))</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">16</span> \
    <span class="o">*</span> <span class="p">((</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">6</span> <span class="o">*</span> <span class="p">((</span><span class="n">chi1</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> \
    <span class="n">chi1</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">7</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span><span class="p">)))</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="n">chi1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> \
    <span class="n">q</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)))))</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">5</span> <span class="o">*</span> \
    <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">chi1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">*</span> <span class="p">((</span><span class="mi">5</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">13</span> <span class="o">*</span> <span class="n">q</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> \
    <span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">chi1</span><span class="o">**</span><span class="mi">6</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">8</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">4</span> \
    <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">8</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">12</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">13</span> <span class="o">*</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)))))</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chi1</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">5</span> \
    <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> \
    <span class="p">(</span><span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> \
    <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="mi">7</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">))))))</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">chi1</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> \
    <span class="n">q</span><span class="o">**</span><span class="mi">5</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">6</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> \
    <span class="p">(</span><span class="o">-</span><span class="mi">7</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">))))))))</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">*</span> <span class="p">(((</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> \
    <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chi1</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">((</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="n">chi1</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">10</span> \
    <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">5</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">8</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">3</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)))))</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">8</span> \
    <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">20</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">8</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">6</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">7</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">40</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> \
    <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">6</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">20</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">))</span> <span class="o">+</span> <span class="o">-</span><span class="mi">2</span> \
    <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">))))))))))))</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">7</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">*</span> <span class="p">(((</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> \
    <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">25</span> <span class="o">*</span> <span class="n">q</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">chi1</span><span class="o">**</span><span class="mi">6</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="n">chi1</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="mi">85</span> <span class="o">*</span> \
    <span class="n">q</span><span class="o">**</span><span class="mi">6</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">32</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">7</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">48</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="mi">83</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">40</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> \
    <span class="p">(</span><span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">7</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">103</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> \
    <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">37</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">84</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">))))))))</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> \
    <span class="n">chi1</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">37</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">8</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">9</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">16</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">32</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">16</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> \
    <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">7</span> <span class="o">*</span> <span class="p">(</span><span class="mi">83</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> \
    <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">6</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">103</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">24</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">85</span> <span class="o">*</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">8</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">32</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> \
    <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">16</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="o">-</span><span class="mi">8</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">)))))))))))</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">7</span> <span class="o">*</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">8</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">32</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">112</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">7</span> <span class="o">*</span> <span class="p">(</span><span class="mi">27</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">6</span> \
    <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">39</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">48</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">32</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">8</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">21</span> <span class="o">*</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">))</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">28</span> <span class="o">*</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">)))))))))))))</span> <span class="o">+</span> <span class="p">(((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> \
    <span class="n">u</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(((</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">20</span> <span class="o">*</span> <span class="n">q</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">chi1</span><span class="o">**</span><span class="mi">8</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">4</span> <span class="o">*</span> \
    <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">chi1</span><span class="o">**</span><span class="mi">6</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">11</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">5</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">6</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> \
    <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">8</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">20</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="mi">30</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">22</span> \
    <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">8</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">42</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)))))))</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">10</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">8</span> <span class="o">*</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">96</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">288</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">7</span> <span class="o">*</span> <span class="p">(</span><span class="mi">22</span> <span class="o">*</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="o">-</span><span class="mi">32</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">11</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">26</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">8</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">7</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> \
    <span class="o">+</span> <span class="o">-</span><span class="mi">16</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">6</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">33</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">112</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">16</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">22</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> \
    <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">))</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">25</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> \
    <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">24</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">))))))))))</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">6</span> <span class="o">*</span> <span class="n">chi1</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">9</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">24</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">56</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span> \
    <span class="o">+</span> <span class="p">(</span><span class="mi">12</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">7</span> <span class="o">*</span> <span class="p">(</span><span class="mi">62</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="o">-</span><span class="mi">6</span> <span class="o">*</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">37</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">8</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">52</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">6</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">41</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">38</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> \
    <span class="mi">24</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">))</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">19</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">6</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> \
    <span class="mi">56</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">)))))))))))</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chi1</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">9</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> \
    <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">10</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">8</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">16</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> \
    <span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">24</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="mi">53</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> \
    <span class="o">+</span> <span class="o">-</span><span class="mi">32</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">7</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">110</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">24</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> \
    <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">6</span> <span class="o">*</span> <span class="p">(</span><span class="mi">53</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">104</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> \
    <span class="o">-</span><span class="mi">48</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">19</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> \
    <span class="o">+</span> <span class="o">-</span><span class="mi">26</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">12</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">64</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">72</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">))))))))))))))))</span> <span class="o">+</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">8</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(((</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> \
    <span class="n">chi1</span><span class="o">**</span><span class="mi">6</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">((</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chi1</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">5</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">10</span> <span class="o">*</span> \
    <span class="n">q</span><span class="o">**</span><span class="mi">6</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">38</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">26</span> <span class="o">*</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">86</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="mi">39</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">23</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">102</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)))))))</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> \
    <span class="n">chi1</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">28</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">9</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">10</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">32</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span> \
    <span class="o">+</span> <span class="p">(</span><span class="mi">72</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">48</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">5</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="mi">92</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="o">-</span><span class="mi">22</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> \
    <span class="p">(</span><span class="o">-</span><span class="mi">12</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">7</span> <span class="o">*</span> <span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">5</span> <span class="o">*</span> \
    <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">12</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">11</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">6</span> \
    <span class="o">*</span> <span class="p">(</span><span class="mi">37</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">22</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">8</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> \
    <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">11</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="mi">5</span> \
    <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">11</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">120</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">))))))))))))</span> \
    <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">16</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">6</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">96</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">6</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">8</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">30</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">9</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi2</span><span class="o">**</span><span class="mi">6</span> <span class="o">+</span> <span class="o">-</span><span class="mi">10</span> \
    <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">10</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi2</span><span class="o">**</span><span class="mi">6</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">7</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi2</span><span class="o">**</span><span class="mi">6</span> <span class="o">+</span> <span class="p">(</span><span class="mi">20</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">18</span> \
    <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">6</span> <span class="o">+</span> <span class="p">(</span><span class="mi">25</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">32</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="mi">23</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">240</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="o">-</span><span class="mi">240</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">6</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">6</span> \
    <span class="o">*</span> <span class="p">(</span><span class="n">chi2</span><span class="o">**</span><span class="mi">6</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">47</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">40</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span> \
    <span class="o">+</span> <span class="o">-</span><span class="mi">16</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">6</span><span class="p">)))</span> <span class="o">+</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">30</span> <span class="o">*</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="o">-</span><span class="mi">12</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">6</span><span class="p">))</span> <span class="o">+</span> <span class="o">-</span><span class="mi">8</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">11</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">40</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">6</span><span class="p">))))))))))))))))))))</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">coeff5</span><span class="p">,</span> <span class="n">coeff4</span><span class="p">,</span> <span class="n">coeff3</span><span class="p">,</span> <span class="n">coeff2</span><span class="p">,</span> <span class="n">coeff1</span><span class="p">,</span> <span class="n">coeff0</span><span class="p">])</span></div>


<div class="viewcode-block" id="kappalimits_geometrical"><a class="viewcode-back" href="../auto.html#precession.kappalimits_geometrical">[docs]</a><span class="k">def</span> <span class="nf">kappalimits_geometrical</span><span class="p">(</span><span class="n">r</span> <span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Limits in kappa conditioned on r, q, chi1, chi2.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    kappamax: float</span>
<span class="sd">        Maximum value of the asymptotic angular momentum kappa.</span>
<span class="sd">    kappamin: float</span>
<span class="sd">        Minimum value of the asymptotic angular momentum kappa.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``kappamin,kappamax = precession.kappalimits_geometrical(r,q,chi1,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    
    <span class="n">k1</span> <span class="o">=</span> <span class="o">-</span><span class="n">q</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">k2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">q</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">&gt;=</span><span class="n">chi1</span><span class="o">+</span><span class="n">chi2</span><span class="o">*</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="p">(</span><span class="n">chi1</span><span class="o">+</span><span class="n">chi2</span><span class="o">*</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span> <span class="p">(</span><span class="n">chi1</span><span class="o">+</span><span class="n">chi2</span><span class="o">*</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">))),</span>
                <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">q</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">chi1</span><span class="o">+</span><span class="n">chi2</span><span class="o">*</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">chi1</span><span class="o">+</span><span class="n">chi2</span><span class="o">*</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)))</span>
                <span class="p">)</span>
    <span class="n">k3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">chi1</span><span class="o">-</span><span class="n">chi2</span><span class="o">*</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">&gt;=</span> <span class="n">q</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">chi1</span><span class="o">-</span><span class="n">chi2</span><span class="o">*</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">chi1</span><span class="o">-</span><span class="n">chi2</span><span class="o">*</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">))),</span>
                <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">q</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">chi1</span><span class="o">-</span><span class="n">chi2</span><span class="o">*</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">chi1</span><span class="o">-</span><span class="n">chi2</span><span class="o">*</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)))</span>
                <span class="p">)</span>

    <span class="n">kappamin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="o">.</span><span class="n">reduce</span><span class="p">([</span><span class="n">k1</span><span class="p">,</span><span class="n">k2</span><span class="p">,</span><span class="n">k3</span><span class="p">])</span>

    <span class="c1"># An alternative implementation that breaks down for r=inf</span>
    <span class="c1"># def squarewithsign(x):</span>
    <span class="c1">#     return x*np.abs(x)</span>
    <span class="c1"># kappamin_old= q*r**(1/2)/(2*(1+q)**2)*(</span>
    <span class="c1">#      np.maximum.reduce([np.zeros(q.shape), </span>
    <span class="c1">#         squarewithsign( 1- (chi1+chi2*q**2) / (q*r**(1/2))),</span>
    <span class="c1">#         squarewithsign( np.abs(chi1-chi2*q**2) / (q*r**(1/2)) - 1 )] )</span>
    <span class="c1">#      -1)</span>

    <span class="n">kappamax</span> <span class="o">=</span> <span class="p">(</span><span class="n">chi1</span><span class="o">+</span><span class="n">chi2</span><span class="o">*</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span><span class="n">chi1</span><span class="o">+</span><span class="n">chi2</span><span class="o">*</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span><span class="mi">1</span> <span class="p">)</span>


    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">kappamin</span><span class="p">,</span><span class="n">kappamax</span><span class="p">])</span></div>


<div class="viewcode-block" id="kapparesonances"><a class="viewcode-back" href="../auto.html#precession.kapparesonances">[docs]</a><span class="k">def</span> <span class="nf">kapparesonances</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    asymptotic angular momentum of the two spin-orbit resonances. The resonances minimizes and maximizes kappa for given values of r, chieff, q, chi1, chi2. The minimum corresponds to deltaphi=pi and the maximum corresponds to deltaphi=0.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    tol: float, optional (default: 1e-4)</span>
<span class="sd">        Numerical tolerance, see source code for details.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    kappamax: float</span>
<span class="sd">        Maximum value of the asymptotic angular momentum kappa.</span>
<span class="sd">    kappamin: float</span>
<span class="sd">        Minimum value of the asymptotic angular momentum kappa.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``kappamin,kappamax = precession.kapparesonances(u,chieff,q,chi1,chi2,tol=1e-4)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">chieff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chieff</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">u</span> <span class="o">=</span> <span class="n">eval_u</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">q</span><span class="p">)</span>

    <span class="c1">#kapparoots = wraproots(kappadiscriminant_coefficients, u, chieff, q, chi1, chi2)</span>
    
    <span class="n">coeffs</span> <span class="o">=</span> <span class="n">kappadiscriminant_coefficients</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
    <span class="n">kapparootscomplex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort_complex</span><span class="p">(</span><span class="n">roots_vec</span><span class="p">(</span><span class="n">coeffs</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
    <span class="c1">#sols = np.real(np.where(np.isreal(sols), sols, np.nan))</span>

    <span class="c1"># There are in principle five solutions, but only two are physical.</span>
    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="n">kapparootscomplex</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">):</span>
        <span class="n">kappares</span><span class="o">=</span><span class="kc">None</span>

        <span class="c1"># At infinitely large separations the resonances are analytic...</span>
        <span class="k">if</span> <span class="n">u</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">kappaminus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">((</span><span class="n">q</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="n">chieff</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="n">chi1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="p">,</span> <span class="p">((</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="n">chieff</span> <span class="o">-</span> <span class="n">q</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="n">chi2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">kappaplus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">((</span><span class="n">q</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="n">chieff</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="n">chi1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="p">((</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="n">chieff</span> <span class="o">+</span> <span class="n">q</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="n">chi2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">kappares</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">kappaminus</span><span class="p">,</span><span class="n">kappaplus</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">kappares</span>

        <span class="n">kapparoots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">kapparootscomplex</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isreal</span><span class="p">(</span><span class="n">kapparootscomplex</span><span class="p">)])</span>

        <span class="n">upup</span><span class="p">,</span><span class="n">updown</span><span class="p">,</span><span class="n">downup</span><span class="p">,</span><span class="n">downdown</span><span class="o">=</span><span class="n">eval_chieff</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">chi1</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">chi2</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>


        <span class="c1"># If too close to perfect alignment, return the analytical result.</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">chieff</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">([</span><span class="n">upup</span><span class="p">,</span><span class="n">downdown</span><span class="p">]))</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Close to either up-up or down-down configuration. Using analytical results.&quot;</span><span class="p">,</span> <span class="ne">Warning</span><span class="p">)</span>

            <span class="n">S1</span> <span class="o">=</span> <span class="n">eval_S1</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">)</span>
            <span class="n">S2</span> <span class="o">=</span> <span class="n">eval_S2</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
            <span class="n">L</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">u</span><span class="p">)</span>
            <span class="n">kappar</span> <span class="o">=</span> <span class="p">((</span><span class="n">L</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">chieff</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">S1</span><span class="o">+</span><span class="n">S2</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">L</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">L</span><span class="p">)</span>
            <span class="n">kappares</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">([</span><span class="n">kappar</span><span class="p">,</span><span class="n">kappar</span><span class="p">])</span>



        <span class="c1"># In this case, the spurious solution is always the smaller one. Just leave it out.</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">kapparoots</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
            <span class="n">kappares</span> <span class="o">=</span> <span class="n">kapparoots</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="c1"># Here we have two candidate pairs of resonances...</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">kapparoots</span><span class="p">)</span><span class="o">==</span><span class="mi">5</span><span class="p">:</span>

            <span class="c1"># Edge case with two coincident roots that are exactly zeros. This happens for q=chi1=chi2=1</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">kapparoots</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                <span class="n">kappares</span> <span class="o">=</span> <span class="n">kapparoots</span><span class="p">[</span><span class="n">kapparoots</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">kapparoots</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">kappares</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="mi">0</span><span class="p">],</span><span class="n">kapparoots</span><span class="p">[</span><span class="n">kapparoots</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Compute the corresponding values of deltachi at the resonances</span>
                <span class="n">deltachires</span> <span class="o">=</span> <span class="n">deltachiresonance</span><span class="p">(</span><span class="n">kappa</span><span class="o">=</span><span class="n">kapparoots</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="n">tiler</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">kapparoots</span><span class="p">),</span> <span class="n">chieff</span><span class="o">=</span><span class="n">tiler</span><span class="p">(</span><span class="n">chieff</span><span class="p">,</span><span class="n">kapparoots</span><span class="p">),</span> <span class="n">q</span><span class="o">=</span><span class="n">tiler</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">kapparoots</span><span class="p">),</span> <span class="n">chi1</span><span class="o">=</span><span class="n">tiler</span><span class="p">(</span><span class="n">chi1</span><span class="p">,</span><span class="n">kapparoots</span><span class="p">),</span> <span class="n">chi2</span><span class="o">=</span><span class="n">tiler</span><span class="p">(</span><span class="n">chi2</span><span class="p">,</span><span class="n">kapparoots</span><span class="p">))</span>
                <span class="c1"># Check which of those values is within the allowed region</span>
                <span class="n">deltachimin</span><span class="p">,</span><span class="n">deltachimax</span> <span class="o">=</span> <span class="n">deltachilimits_rectangle</span><span class="p">(</span><span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
                <span class="n">check</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">deltachires</span><span class="o">&gt;</span><span class="n">deltachimin</span><span class="p">,</span><span class="n">deltachires</span><span class="o">&lt;</span><span class="n">deltachimax</span><span class="p">))</span>

                <span class="c1"># The first root cannot possibly be right</span>
                <span class="k">if</span> <span class="n">check</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">kapparoots</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">kapparoots</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input values are not compatible [kapparesonances].&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">check</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">check</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">check</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">check</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span>
                    <span class="n">kappares</span> <span class="o">=</span> <span class="n">kapparoots</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">check</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">check</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">check</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="ow">and</span> <span class="n">check</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span>
                    <span class="n">kappares</span> <span class="o">=</span> <span class="n">kapparoots</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">check</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">check</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">check</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="ow">and</span> <span class="n">check</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span>
                    
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Unphysical resonances detected and removed&quot;</span><span class="p">,</span> <span class="ne">Warning</span><span class="p">)</span>
                    
                    <span class="c1"># Root 1 is a spurious copy of root 0</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">kapparoots</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">kapparoots</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>



                        <span class="n">kappares</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">kapparoots</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]),</span><span class="n">kapparoots</span><span class="p">[</span><span class="mi">4</span><span class="p">]])</span>
                    <span class="c1">#err = np.abs( (kapparoots[2]-kapparoots[3])/np.mean(kapparoots[2:4]))</span>
                    <span class="c1">#warnings.warn(&quot;Unphysical resonances detected and removed. Relative accuracy Delta_kappa/kappa=&quot;+str(err)+&quot;, [kapparesonances].&quot;, Warning)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">kappares</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">kapparoots</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">kapparoots</span><span class="p">[</span><span class="mi">4</span><span class="p">]])</span>
                    
                    <span class="c1"># # Root 1 is a spurious copy of root 0:</span>
                    <span class="c1"># if kapparoots[1]-kapparoots[0]&lt;kapparoots[3]-kapparoots[2]:</span>
                    <span class="c1">#     kappares = kapparoots[3:5]</span>
                    <span class="c1"># # Root 2 and 3 are actually complex but appear real because of numerical errors </span>
                    <span class="c1"># else:</span>
                    <span class="c1">#     kappares=np.array([kapparoots[1],kapparoots[4]])</span>

        <span class="c1"># This is an edge (and hopefully rare) case where the resonances are missed because of numerical errors</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">kapparoots</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>

            <span class="c1"># 5 complex solutions correspond to 3 real parts (i.e. thare are two conjugate pairs)</span>
            <span class="n">kapparoots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">kapparootscomplex</span><span class="p">))</span>

            <span class="n">deltachires</span> <span class="o">=</span> <span class="n">deltachiresonance</span><span class="p">(</span><span class="n">kappa</span><span class="o">=</span><span class="n">kapparoots</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="n">tiler</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">kapparoots</span><span class="p">),</span> <span class="n">chieff</span><span class="o">=</span><span class="n">tiler</span><span class="p">(</span><span class="n">chieff</span><span class="p">,</span><span class="n">kapparoots</span><span class="p">),</span> <span class="n">q</span><span class="o">=</span><span class="n">tiler</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">kapparoots</span><span class="p">),</span> <span class="n">chi1</span><span class="o">=</span><span class="n">tiler</span><span class="p">(</span><span class="n">chi1</span><span class="p">,</span><span class="n">kapparoots</span><span class="p">),</span> <span class="n">chi2</span><span class="o">=</span><span class="n">tiler</span><span class="p">(</span><span class="n">chi2</span><span class="p">,</span><span class="n">kapparoots</span><span class="p">))</span>

            <span class="n">deltachimin</span><span class="p">,</span><span class="n">deltachimax</span> <span class="o">=</span> <span class="n">deltachilimits_rectangle</span><span class="p">(</span><span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
            <span class="n">check</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">deltachires</span><span class="o">&gt;</span><span class="n">deltachimin</span><span class="p">,</span><span class="n">deltachires</span><span class="o">&lt;</span><span class="n">deltachimax</span><span class="p">))</span>

            <span class="c1"># Two of these are compatible</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">check</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">kappares</span><span class="o">=</span><span class="n">kapparoots</span><span class="p">[</span><span class="n">check</span><span class="p">]</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Resonances not detected, best guess returned (soft sanitizing)&quot;</span><span class="p">,</span> <span class="ne">Warning</span><span class="p">)</span>

            <span class="c1"># In case that also fails, returns the closest two</span>
            <span class="k">else</span><span class="p">:</span>


                <span class="n">diffmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">deltachires</span><span class="o">-</span><span class="n">deltachimin</span><span class="p">)</span>
                <span class="n">diffmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">deltachires</span><span class="o">-</span><span class="n">deltachimax</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">kappares</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">([</span><span class="n">kapparoots</span><span class="p">[</span><span class="n">diffmin</span><span class="o">==</span><span class="nb">min</span><span class="p">(</span><span class="n">diffmin</span><span class="p">)],</span> <span class="n">kapparoots</span><span class="p">[</span><span class="n">diffmax</span><span class="o">==</span><span class="nb">min</span><span class="p">(</span><span class="n">diffmax</span><span class="p">)]]))</span>
            
                <span class="k">except</span><span class="p">:</span>
                    <span class="c1"># If that also fails and you&#39;re close to q=1, return the analytic result</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>

                        <span class="n">r</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">eval_r</span><span class="p">(</span><span class="n">u</span><span class="o">=</span><span class="n">u</span><span class="p">,</span><span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">))</span>
                        <span class="n">kappamin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">((</span><span class="n">chi1</span><span class="o">-</span><span class="n">chi2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">8</span> <span class="p">,</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span><span class="n">r</span><span class="o">**</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">chieff</span><span class="o">/</span><span class="mi">2</span>
                        <span class="n">kappamax</span> <span class="o">=</span> <span class="p">(</span><span class="n">chi1</span><span class="o">+</span><span class="n">chi2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">8</span> <span class="o">/</span><span class="n">r</span><span class="o">**</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">chieff</span><span class="o">/</span><span class="mi">2</span>

                        <span class="n">kappares</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">kappamin</span><span class="p">,</span><span class="n">kappamax</span><span class="p">])</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Resonances not detected, best guess returned (using analytic result for q=1)&quot;</span><span class="p">,</span> <span class="ne">Warning</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Resonances not detected, best guess returned (aggressive sanitizing)&quot;</span><span class="p">,</span> <span class="ne">Warning</span><span class="p">)</span>

        <span class="c1"># Up-down and down-up are challenging. </span>
        <span class="c1"># Evaluate the resonances outside of those points and interpolate linearly.</span>
        <span class="c1"># Note usage of recursive functions.</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">chieff</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">([</span><span class="n">updown</span><span class="p">,</span><span class="n">downup</span><span class="p">]))</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Close to either up-down or down-up configuration. Using recursive approach (tol=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">tol</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;) and analytical results.&quot;</span><span class="p">,</span> <span class="ne">Warning</span><span class="p">)</span>
            <span class="n">chieff1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">chieff</span><span class="o">+</span><span class="n">tol</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">upup</span><span class="p">),</span><span class="n">downdown</span><span class="p">)</span>
            <span class="n">coeffs</span> <span class="o">=</span> <span class="n">kappadiscriminant_coefficients</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">chieff1</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
            <span class="n">kapparootscomplex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort_complex</span><span class="p">(</span><span class="n">roots_vec</span><span class="p">(</span><span class="n">coeffs</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
            <span class="n">kappares1</span> <span class="o">=</span> <span class="n">_compute</span><span class="p">(</span><span class="n">kapparootscomplex</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff1</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
            <span class="n">chieff2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">chieff</span><span class="o">-</span><span class="n">tol</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">upup</span><span class="p">),</span><span class="n">downdown</span><span class="p">)</span>
            <span class="n">coeffs</span> <span class="o">=</span> <span class="n">kappadiscriminant_coefficients</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">chieff2</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
            <span class="n">kapparootscomplex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort_complex</span><span class="p">(</span><span class="n">roots_vec</span><span class="p">(</span><span class="n">coeffs</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
            <span class="n">kappares2</span> <span class="o">=</span> <span class="n">_compute</span><span class="p">(</span><span class="n">kapparootscomplex</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff2</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
 
            <span class="n">kappares</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">kappares1</span><span class="p">,</span><span class="n">kappares2</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># For stable configurations, we know some resonances analytically. </span>
        <span class="c1"># Use those instead of the interpolated results above.</span>
        <span class="n">rudplus</span> <span class="o">=</span> <span class="n">rupdown</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">chieff</span><span class="p">,</span><span class="n">updown</span><span class="p">)</span> <span class="ow">and</span> <span class="n">u</span><span class="o">&lt;</span><span class="n">eval_u</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">rudplus</span><span class="p">,</span><span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">):</span>
            <span class="n">S1</span> <span class="o">=</span> <span class="n">eval_S1</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">)</span>
            <span class="n">S2</span> <span class="o">=</span> <span class="n">eval_S2</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
            <span class="n">L</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">u</span><span class="p">)</span>
            <span class="n">kappares</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span> <span class="p">((</span><span class="n">L</span><span class="o">+</span><span class="n">S1</span><span class="o">-</span><span class="n">S2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">L</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">L</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">chieff</span><span class="p">,</span><span class="n">downup</span><span class="p">):</span>
            <span class="n">S1</span> <span class="o">=</span> <span class="n">eval_S1</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">)</span>
            <span class="n">S2</span> <span class="o">=</span> <span class="n">eval_S2</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
            <span class="n">L</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">u</span><span class="p">)</span>
            <span class="n">kappares</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span> <span class="p">((</span><span class="n">L</span><span class="o">-</span><span class="n">S1</span><span class="o">+</span><span class="n">S2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">L</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">L</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">kappares</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input values are not compatible [kapparesonances].&quot;</span><span class="p">)</span>

        <span class="c1"># If you didn&#39;t find enough solutions, append nans</span>
        <span class="c1">#kappares = np.concatenate([kappares, np.repeat(np.nan, 2-len(kappares))])</span>
        
        <span class="k">return</span> <span class="n">kappares</span>

    <span class="n">kappamin</span><span class="p">,</span> <span class="n">kappamax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">_compute</span><span class="p">,</span> <span class="n">kapparootscomplex</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)))</span><span class="o">.</span><span class="n">T</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">kappamin</span><span class="p">,</span> <span class="n">kappamax</span><span class="p">])</span></div>


<div class="viewcode-block" id="kapparescaling"><a class="viewcode-back" href="../auto.html#precession.kapparescaling">[docs]</a><span class="k">def</span> <span class="nf">kapparescaling</span><span class="p">(</span><span class="n">kappatilde</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute kappa from the rescaled parameter 0&lt;=kappatilde&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kappatilde: float</span>
<span class="sd">        Rescaled version of the asymptotic angular momentum.</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    kappa: float</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``kappa = precession.kapparescaling(kappatilde,r,chieff,q,chi1,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">kappatilde</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">kappatilde</span><span class="p">)</span>
    <span class="n">kappaminus</span><span class="p">,</span> <span class="n">kappaplus</span> <span class="o">=</span> <span class="n">kapparesonances</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
    <span class="n">kappa</span> <span class="o">=</span> <span class="n">inverseaffine</span><span class="p">(</span><span class="n">kappatilde</span><span class="p">,</span><span class="n">kappaminus</span><span class="p">,</span><span class="n">kappaplus</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">kappa</span></div>


<div class="viewcode-block" id="kappalimits"><a class="viewcode-back" href="../auto.html#precession.kappalimits">[docs]</a><span class="k">def</span> <span class="nf">kappalimits</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chieff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chi1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chi2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">enforce</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Limits on the asymptotic angular momentum. The contraints considered depend on the inputs provided.</span>
<span class="sd">        - If r, q, chi1, chi2 are provided, returns the geometrical limits.</span>
<span class="sd">        - If r, chieff, q, chi1, and chi2 are provided, returns the spin-orbit resonances.</span>
<span class="sd">    The boolean flag enforce raises an error in case the inputs are not compatible. Additional kwargs are passed to kapparesonances.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    r: float, optional (default: None)</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    chieff: float, optional (default: None)</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float, optional (default: None)</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float, optional (default: None)</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float, optional (default: None)</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    enforce: boolean, optional (default: False)</span>
<span class="sd">        Perform additional checks.</span>
<span class="sd">    **kwargs: unpacked dictionary, optional</span>
<span class="sd">        Additional keyword arguments.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    kappamax: float</span>
<span class="sd">        Maximum value of the asymptotic angular momentum kappa.</span>
<span class="sd">    kappamin: float</span>
<span class="sd">        Minimum value of the asymptotic angular momentum kappa.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``kappamin,kappamax = precession.kappalimits(r=r,q=q,chi1=chi1,chi2=chi2)``</span>
<span class="sd">    ``kappamin,kappamax = precession.kappalimits(r=r,chieff=chieff,q=q,chi1=chi1,chi2=chi2)``</span>
<span class="sd">    ``kappamin,kappamax = precession.kappalimits(r=r,chieff=chieff,q=q,chi1=chi1,chi2=chi2,enforce=True)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chieff</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chi1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chi2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">kappamin</span><span class="p">,</span> <span class="n">kappamax</span> <span class="o">=</span> <span class="n">kappalimits_geometrical</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chieff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chi1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chi2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">kappamin</span><span class="p">,</span> <span class="n">kappamax</span> <span class="o">=</span> <span class="n">kapparesonances</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># Check precondition</span>
        <span class="n">kappamin_cond</span><span class="p">,</span> <span class="n">kappamax_cond</span> <span class="o">=</span> <span class="n">kappalimits_geometrical</span><span class="p">(</span><span class="n">r</span> <span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">kappamin</span> <span class="o">&gt;=</span> <span class="n">kappamin_cond</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="n">kappamax</span> <span class="o">&lt;=</span> <span class="n">kappamax_cond</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">enforce</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input values are not compatible [kappalimits].&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Input values are not compatible [kappalimits].&quot;</span><span class="p">,</span> <span class="ne">Warning</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Provide either (r,q,chi1,chi2) or (r,chieff,q,chi1,chi2).&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">kappamin</span><span class="p">,</span> <span class="n">kappamax</span><span class="p">])</span></div>


<div class="viewcode-block" id="chiefflimits"><a class="viewcode-back" href="../auto.html#precession.chiefflimits">[docs]</a><span class="k">def</span> <span class="nf">chiefflimits</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Limits on the effective spin based only on its definition.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    chieffmax: float</span>
<span class="sd">        Maximum value of the effective spin.</span>
<span class="sd">    chieffmin: float</span>
<span class="sd">        Minimum value of the effective spin.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``chieffmin,chieffmax = precession.chiefflimits(q,chi1,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chiefflim</span> <span class="o">=</span> <span class="p">(</span><span class="n">chi1</span><span class="o">+</span><span class="n">q</span><span class="o">*</span><span class="n">chi2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="o">-</span><span class="n">chiefflim</span><span class="p">,</span> <span class="n">chiefflim</span><span class="p">])</span></div>


<div class="viewcode-block" id="deltachilimits_definition"><a class="viewcode-back" href="../auto.html#precession.deltachilimits_definition">[docs]</a><span class="k">def</span> <span class="nf">deltachilimits_definition</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Limits on the weighted spin difference based only on its definition.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    deltachimax: float</span>
<span class="sd">        Maximum value of the effective spin chieff.</span>
<span class="sd">    deltachimin: float</span>
<span class="sd">        Minimum value of the effective spin chieff.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``deltachimin,deltachimax = precession.deltachilimits_definition(q,chi1,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">deltachilim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">chi1</span><span class="o">-</span><span class="n">q</span><span class="o">*</span><span class="n">chi2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="o">-</span><span class="n">deltachilim</span><span class="p">,</span> <span class="n">deltachilim</span><span class="p">])</span></div>


<div class="viewcode-block" id="anglesresonances"><a class="viewcode-back" href="../auto.html#precession.anglesresonances">[docs]</a><span class="k">def</span> <span class="nf">anglesresonances</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the values of the angles corresponding to the two spin-orbit resonances.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    deltaphiatmax: float</span>
<span class="sd">        Value of the angle deltaphi at the resonance that maximizes kappa.</span>
<span class="sd">    deltaphiatmin: float</span>
<span class="sd">        Value of the angle deltaphi at the resonance that minimizes kappa.</span>
<span class="sd">    theta1atmax: float</span>
<span class="sd">        Value of the angle theta1 at the resonance that maximizes kappa.</span>
<span class="sd">    theta1atmin: float</span>
<span class="sd">        Value of the angle theta1 at the resonance that minimizes kappa.</span>
<span class="sd">    theta2atmax: float</span>
<span class="sd">        Value of the angle theta2 at the resonance that maximizes kappa.</span>
<span class="sd">    theta2atmin: float</span>
<span class="sd">        Value of the angle theta2 at the resonance that minimizes kappa.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``theta1atmin,theta2atmin,deltaphiatmin,theta1atmax,theta2atmax,deltaphiatmax = precession.anglesresonances(r,chieff,q,chi1,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">kappamin</span><span class="p">,</span> <span class="n">kappamax</span> <span class="o">=</span> <span class="n">kapparesonances</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>

    <span class="n">deltachiatmin</span> <span class="o">=</span> <span class="n">deltachiresonance</span><span class="p">(</span><span class="n">kappa</span><span class="o">=</span><span class="n">kappamin</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="o">=</span><span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="o">=</span><span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="o">=</span><span class="n">chi2</span><span class="p">)</span>
    <span class="n">theta1atmin</span> <span class="o">=</span> <span class="n">eval_theta1</span><span class="p">(</span><span class="n">deltachiatmin</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">)</span>
    <span class="n">theta2atmin</span> <span class="o">=</span> <span class="n">eval_theta2</span><span class="p">(</span><span class="n">deltachiatmin</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
    <span class="n">deltaphiatmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">tiler</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">q</span><span class="p">))</span>

    <span class="n">deltachiatmax</span> <span class="o">=</span> <span class="n">deltachiresonance</span><span class="p">(</span><span class="n">kappa</span><span class="o">=</span><span class="n">kappamax</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="o">=</span><span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="o">=</span><span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="o">=</span><span class="n">chi2</span><span class="p">)</span>
    <span class="n">theta1atmax</span> <span class="o">=</span> <span class="n">eval_theta1</span><span class="p">(</span><span class="n">deltachiatmax</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">)</span>
    <span class="n">theta2atmax</span> <span class="o">=</span> <span class="n">eval_theta2</span><span class="p">(</span><span class="n">deltachiatmax</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
    <span class="n">deltaphiatmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">tiler</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">q</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">theta1atmin</span><span class="p">,</span> <span class="n">theta2atmin</span><span class="p">,</span> <span class="n">deltaphiatmin</span><span class="p">,</span> <span class="n">theta1atmax</span><span class="p">,</span> <span class="n">theta2atmax</span><span class="p">,</span> <span class="n">deltaphiatmax</span><span class="p">])</span></div>


<span class="c1">################ Precession parametrization ################</span>


<div class="viewcode-block" id="deltachicubic_coefficients"><a class="viewcode-back" href="../auto.html#precession.deltachicubic_coefficients">[docs]</a><span class="k">def</span> <span class="nf">deltachicubic_coefficients</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Coefficients of the cubic equation in deltachi for its time evolution.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kappa: float</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    u: float</span>
<span class="sd">        Compactified separation 1/(2L).</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    coeff0: float</span>
<span class="sd">        Coefficient to the x^0 term in polynomial.</span>
<span class="sd">    coeff1: float</span>
<span class="sd">        Coefficient to the x^1 term in polynomial.</span>
<span class="sd">    coeff2: float</span>
<span class="sd">        Coefficient to the x^2 term in polynomial.</span>
<span class="sd">    coeff3: float</span>
<span class="sd">        Coefficient to the x^3 term in polynomial.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``coeff3,coeff2,coeff1,coeff0 = precession.deltachicubic_coefficients(kappa,u,chieff,q,chi1,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">kappa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">kappa</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chieff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chieff</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">coeff3</span> <span class="o">=</span> <span class="n">u</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span>

    <span class="c1"># Machine generated with eq_generator.nb</span>
    <span class="n">coeff2</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> \
    <span class="o">*</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> \
    <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">kappa</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">chieff</span><span class="p">)))</span>

    <span class="c1"># Machine generated with eq_generator.nb</span>
    <span class="n">coeff1</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">kappa</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> \
    <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span> \
    <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">q</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>


    <span class="c1"># Machine generated with eq_generator.nb</span>
    <span class="n">coeff0</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">kappa</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">kappa</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">q</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(((</span><span class="n">chi1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> \
    <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">q</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> \
    <span class="o">*</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">coeff3</span><span class="p">,</span> <span class="n">coeff2</span><span class="p">,</span> <span class="n">coeff1</span><span class="p">,</span> <span class="n">coeff0</span><span class="p">])</span></div>


<div class="viewcode-block" id="deltachicubic_rescaled_coefficients"><a class="viewcode-back" href="../auto.html#precession.deltachicubic_rescaled_coefficients">[docs]</a><span class="k">def</span> <span class="nf">deltachicubic_rescaled_coefficients</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">precomputedcoefficients</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rescaled coefficients of the cubic equation in deltachi for its time evolution. This is necessary to avoid dividing by (1-q).</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kappa: float</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    u: float</span>
<span class="sd">        Compactified separation 1/(2L).</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    precomputedcoefficients: array, optional (default: None)</span>
<span class="sd">        Pre-computed output of deltachicubic_coefficients for computational efficiency.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    coeff0: float</span>
<span class="sd">        Coefficient to the x^0 term in polynomial.</span>
<span class="sd">    coeff1: float</span>
<span class="sd">        Coefficient to the x^1 term in polynomial.</span>
<span class="sd">    coeff2: float</span>
<span class="sd">        Coefficient to the x^2 term in polynomial.</span>
<span class="sd">    coeff3: float</span>
<span class="sd">        Coefficient to the x^3 term in polynomial.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``coeff3,coeff2,coeff1,coeff0 = precession.deltachicubic_rescaled_coefficients(kappa,u,chieff,q,chi1,chi2)``</span>
<span class="sd">    ``coeff3,coeff2,coeff1,coeff0 = precession.deltachicubic_rescaled_coefficients(kappa,u,chieff,q,chi1,chi2,precomputedcoefficients=coeffs)``</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">precomputedcoefficients</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">coeff2</span><span class="p">,</span> <span class="n">coeff1</span><span class="p">,</span> <span class="n">coeff0</span> <span class="o">=</span> <span class="n">deltachicubic_coefficients</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">precomputedcoefficients</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;Shape of precomputedroots must be (3,N), i.e. deltachiminus, deltachiplus, deltachi3. [deltachiroots]&quot;</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">coeff2</span><span class="p">,</span> <span class="n">coeff1</span><span class="p">,</span> <span class="n">coeff0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">precomputedcoefficients</span><span class="p">)</span>

    <span class="c1"># Careful! Do not divide coeff3 by (1-q) but recompute explicitely</span>
    <span class="n">coeff3r</span> <span class="o">=</span> <span class="n">u</span> 
    <span class="n">coeff2r</span> <span class="o">=</span> <span class="n">coeff2</span>
    <span class="n">coeff1r</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="n">coeff1</span>
    <span class="n">coeff0r</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">coeff0</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">coeff3r</span><span class="p">,</span> <span class="n">coeff2r</span><span class="p">,</span> <span class="n">coeff1r</span><span class="p">,</span> <span class="n">coeff0r</span><span class="p">])</span></div>


<div class="viewcode-block" id="deltachiroots"><a class="viewcode-back" href="../auto.html#precession.deltachiroots">[docs]</a><span class="k">def</span> <span class="nf">deltachiroots</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Roots of the cubic equation in deltachi that describes the dynamics on the precession timescale.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kappa: float</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    u: float</span>
<span class="sd">        Compactified separation 1/(2L).</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    full_output: boolean, optional (default: True)</span>
<span class="sd">        Return additional outputs.</span>
<span class="sd">    precomputedroots: array, optional (default: None)</span>
<span class="sd">        Pre-computed output of deltachiroots for computational efficiency.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    deltachi3: float, optional</span>
<span class="sd">        Spurious root of the deltachi evolution.</span>
<span class="sd">    deltachiminus: float</span>
<span class="sd">        Lowest physical root of the deltachi evolution.</span>
<span class="sd">    deltachiplus: float</span>
<span class="sd">        Lowest physical root of the deltachi evolution.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``deltachiminus,deltachiplus,deltachi3 = precession.deltachiroots(kappa,u,chieff,q,chi1,chi2)``</span>
<span class="sd">    ``deltachiminus,deltachiplus,deltachi3 = precession.deltachiroots(kappa,u,chieff,q,chi1,chi2,precomputedroots=roots)``</span>
<span class="sd">    ``deltachiminus,deltachiplus = precession.deltachiroots(kappa,u,chieff,q,chi1,chi2,full_output=False)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">precomputedroots</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">deltachiminus</span><span class="p">,</span> <span class="n">deltachiplus</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">wraproots</span><span class="p">(</span><span class="n">deltachicubic_coefficients</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># If you need the spurious root as well.</span>
        <span class="k">if</span> <span class="n">full_output</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">deltachi3</span> <span class="o">=</span> <span class="n">wraproots</span><span class="p">(</span><span class="n">deltachicubic_rescaled_coefficients</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="c1"># Otherwise avoid (for computational efficiency)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">deltachi3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">tiler</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span><span class="n">deltachiminus</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">deltachiminus</span><span class="p">,</span> <span class="n">deltachiplus</span><span class="p">,</span> <span class="n">deltachi3</span><span class="p">])</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">precomputedroots</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">precomputedroots</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">precomputedroots</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;Shape of precomputedroots must be (3,N), i.e. deltachiminus, deltachiplus, deltachi3. [deltachiroots]&quot;</span>
        <span class="k">return</span> <span class="n">precomputedroots</span></div>


<div class="viewcode-block" id="deltachilimits_rectangle"><a class="viewcode-back" href="../auto.html#precession.deltachilimits_rectangle">[docs]</a><span class="k">def</span> <span class="nf">deltachilimits_rectangle</span><span class="p">(</span><span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Limits on the weighted spin difference for given (chieff, q, chi1, chi2). This is a rectangle in the (chieff,deltachi) plane.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    deltachimax: float</span>
<span class="sd">        Maximum value of the weighted spin difference.</span>
<span class="sd">    deltachimin: float</span>
<span class="sd">        Minimum value of the weighted spin difference.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``deltachimin,deltachimax = precession.deltachilimits_rectangle(chieff,q,chi1,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">chieff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chieff</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>


    <span class="n">deltachimin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span> <span class="o">-</span><span class="n">chieff</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">chi1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">),</span> <span class="n">chieff</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="o">*</span><span class="n">chi2</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">))</span>
    <span class="n">deltachimax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span> <span class="o">-</span><span class="n">chieff</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">chi1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">),</span> <span class="n">chieff</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="o">*</span><span class="n">chi2</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">deltachimin</span><span class="p">,</span> <span class="n">deltachimax</span><span class="p">])</span></div>


<div class="viewcode-block" id="deltachilimits_plusminus"><a class="viewcode-back" href="../auto.html#precession.deltachilimits_plusminus">[docs]</a><span class="k">def</span> <span class="nf">deltachilimits_plusminus</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Limits on the weighted spin difference for given (kappa, r, chieff, q, chi1, chi2). These are two of the solutions of the underlying cubic polynomial.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kappa: float</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    precomputedroots: array, optional (default: None)</span>
<span class="sd">        Pre-computed output of deltachiroots for computational efficiency.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    deltachimax: float</span>
<span class="sd">        Maximum value of the weighted spin difference.</span>
<span class="sd">    deltachimin: float</span>
<span class="sd">        Minimum value of the weighted spin difference.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``deltachimin,deltachimax = precession.deltachilimits_plusminus(kappa,r,chieff,q,chi1,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">u</span> <span class="o">=</span> <span class="n">eval_u</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">q</span><span class="p">)</span>
    <span class="n">deltachiminus</span><span class="p">,</span> <span class="n">deltachiplus</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">deltachiroots</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">full_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="n">precomputedroots</span><span class="p">)</span>

    <span class="c1"># Correct when too close to perfect alignment</span>
    <span class="n">angleup</span><span class="o">=</span><span class="n">tiler</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">q</span><span class="p">)</span>
    <span class="n">angledown</span><span class="o">=</span><span class="n">tiler</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="n">q</span><span class="p">)</span>

    <span class="n">chieffupup</span> <span class="o">=</span> <span class="n">eval_chieff</span><span class="p">(</span><span class="n">angleup</span><span class="p">,</span> <span class="n">angleup</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
    <span class="n">deltachiupup</span> <span class="o">=</span> <span class="n">eval_deltachi</span><span class="p">(</span><span class="n">angleup</span><span class="p">,</span> <span class="n">angleup</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
    <span class="n">deltachiminus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">chieff</span><span class="p">,</span><span class="n">chieffupup</span><span class="p">),</span> <span class="n">deltachiupup</span><span class="p">,</span><span class="n">deltachiminus</span><span class="p">)</span>
    <span class="n">deltachiplus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">chieff</span><span class="p">,</span><span class="n">chieffupup</span><span class="p">),</span> <span class="n">deltachiupup</span><span class="p">,</span><span class="n">deltachiplus</span><span class="p">)</span>

    <span class="n">chieffdowndown</span> <span class="o">=</span> <span class="n">eval_chieff</span><span class="p">(</span><span class="n">angledown</span><span class="p">,</span> <span class="n">angledown</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
    <span class="n">deltachidowndown</span> <span class="o">=</span> <span class="n">eval_deltachi</span><span class="p">(</span><span class="n">angledown</span><span class="p">,</span> <span class="n">angledown</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
    <span class="n">deltachiminus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">chieff</span><span class="p">,</span><span class="n">chieffdowndown</span><span class="p">),</span> <span class="n">deltachidowndown</span><span class="p">,</span><span class="n">deltachiminus</span><span class="p">)</span>
    <span class="n">deltachiplus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">chieff</span><span class="p">,</span><span class="n">chieffdowndown</span><span class="p">),</span> <span class="n">deltachidowndown</span><span class="p">,</span><span class="n">deltachiplus</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">deltachiminus</span><span class="p">,</span> <span class="n">deltachiplus</span><span class="p">])</span></div>


<div class="viewcode-block" id="deltachilimits"><a class="viewcode-back" href="../auto.html#precession.deltachilimits">[docs]</a><span class="k">def</span> <span class="nf">deltachilimits</span><span class="p">(</span><span class="n">kappa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chieff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chi1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chi2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">precomputedroots</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Limits on the weighted spin difference. The contraints considered depend on the inputs provided.</span>
<span class="sd">        - If q, chi1, chi2 are provided, returns the geometrical limits.</span>
<span class="sd">        - If chieff, q, chi1, and chi2 are provided, returns the  joint &#39;rectagle&#39; limits.</span>
<span class="sd">        - If kappa, r, chieff, q, chi1, and chi2 are provided, returns the  solution of the cubic that sets the precession-timescale evolution.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kappa: float, optional (default: None)</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    r: float, optional (default: None)</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    chieff: float, optional (default: None)</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float, optional (default: None)</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float, optional (default: None)</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float, optional (default: None)</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    precomputedroots: array, optional (default: None)</span>
<span class="sd">        Pre-computed output of deltachiroots for computational efficiency.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    deltachimax: float</span>
<span class="sd">        Maximum value of the weighted spin difference.</span>
<span class="sd">    deltachimin: float</span>
<span class="sd">        Minimum value of the weighted spin difference.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``deltachimin,deltachimax = precession.deltachilimits(q=q,chi1=chi1,chi2=chi2)``</span>
<span class="sd">    ``deltachimin,deltachimax = precession.deltachilimits(chieff=chieff,q=q,chi1=chi1,chi2=chi2)``</span>
<span class="sd">    ``deltachimin,deltachimax = precession.deltachilimits(kappa=kappa,r=r,chieff=chieff,q=q,chi1=chi1,chi2=chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">kappa</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">r</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chieff</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chi1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chi2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">deltachimin</span><span class="p">,</span> <span class="n">deltachimax</span> <span class="o">=</span> <span class="n">deltachilimits_definition</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>


    <span class="k">elif</span> <span class="n">kappa</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">r</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chieff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chi1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chi2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">deltachimin</span><span class="p">,</span> <span class="n">deltachimax</span> <span class="o">=</span> <span class="n">deltachilimits_rectangle</span><span class="p">(</span><span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">kappa</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chieff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chi1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chi2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">deltachimin</span><span class="p">,</span> <span class="n">deltachimax</span> <span class="o">=</span> <span class="n">deltachilimits_plusminus</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="n">precomputedroots</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Provide either (q, chi1, chi2), (chieff, q, chi1, chi2), or (kappa, r, chieff, q, chi1, chi2).&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">deltachimin</span><span class="p">,</span> <span class="n">deltachimax</span><span class="p">])</span></div>


<div class="viewcode-block" id="deltachirescaling"><a class="viewcode-back" href="../auto.html#precession.deltachirescaling">[docs]</a><span class="k">def</span> <span class="nf">deltachirescaling</span><span class="p">(</span><span class="n">deltachitilde</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span><span class="n">precomputedroots</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute deltachi from the rescaled parameter 0&lt;=deltachitilde&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    deltachitilde: float</span>
<span class="sd">        Rescaled version of the weighted spin difference.</span>
<span class="sd">    kappa: float</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    precomputedroots: array, optional (default: None)</span>
<span class="sd">        Pre-computed output of deltachiroots for computational efficiency.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    deltachi: float</span>
<span class="sd">        Weighted spin difference.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``deltachi = precession.deltachirescaling(deltachitilde,kappa,r,chieff,q,chi1,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">deltachiminus</span><span class="p">,</span> <span class="n">deltachiplus</span> <span class="o">=</span> <span class="n">deltachilimits_plusminus</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span><span class="n">precomputedroots</span><span class="o">=</span><span class="n">precomputedroots</span><span class="p">)</span>
    <span class="n">deltachi</span> <span class="o">=</span>  <span class="n">inverseaffine</span><span class="p">(</span><span class="n">deltachitilde</span><span class="p">,</span> <span class="n">deltachiminus</span><span class="p">,</span> <span class="n">deltachiplus</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">deltachi</span></div>


<div class="viewcode-block" id="deltachiresonance"><a class="viewcode-back" href="../auto.html#precession.deltachiresonance">[docs]</a><span class="k">def</span> <span class="nf">deltachiresonance</span><span class="p">(</span><span class="n">kappa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chieff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chi1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chi2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Assuming that the inputs correspond to a spin-orbit resonance, find the corresponding value of deltachi. There will be two roots that are coincident if not for numerical errors: for concreteness, return the mean of the real part.</span>
<span class="sd">    This function is dangerous: we do not check that the input is a resonance, that&#39;s up to the user (so use at your own risk).</span>
<span class="sd">    Valid inputs are either (kappa,r,chieff,q,chi1,chi2) or (kappa,u,chieff,q,chi1,chi2).</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kappa: float, optional (default: None)</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    r: float, optional (default: None)</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    u: float, optional (default: None)</span>
<span class="sd">        Compactified separation 1/(2L).</span>
<span class="sd">    chieff: float, optional (default: None)</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float, optional (default: None)</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float, optional (default: None)</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float, optional (default: None)</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    deltachi: float</span>
<span class="sd">        Weighted spin difference.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``deltachi = precession.deltachiresonance(kappa=kappa,r=r,chieff=chieff,q=q,chi1=chi1,chi2=chi2)``</span>
<span class="sd">    ``deltachi = precession.deltachiresonance(kappa=kappa,u=u,chieff=chieff,q=q,chi1=chi1,chi2=chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">q</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">chi1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">chi2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">kappa</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Please provide q, chi1, and chi2.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">u</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Please provide either r or u.&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">u</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">eval_u</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">)</span>

    <span class="n">coeffs</span> <span class="o">=</span> <span class="n">deltachicubic_coefficients</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>  <span class="c1"># nan is ok here</span>
        <span class="n">deltachires</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort_complex</span><span class="p">(</span><span class="n">roots_vec</span><span class="p">(</span><span class="n">coeffs</span><span class="o">.</span><span class="n">T</span><span class="p">))[:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">deltachires</span></div>


<div class="viewcode-block" id="elliptic_parameter"><a class="viewcode-back" href="../auto.html#precession.elliptic_parameter">[docs]</a><span class="k">def</span> <span class="nf">elliptic_parameter</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameter m entering elliptic functions for the evolution of deltachi.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kappa: float</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    u: float</span>
<span class="sd">        Compactified separation 1/(2L).</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    precomputedroots: array, optional (default: None)</span>
<span class="sd">        Pre-computed output of deltachiroots for computational efficiency.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    m: float</span>
<span class="sd">        Parameter of elliptic function(s).</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``m = precession.elliptic_parameter(kappa,u,chieff,q,chi1,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">q</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">deltachiminus</span><span class="p">,</span><span class="n">deltachiplus</span><span class="p">,</span><span class="n">deltachi3</span> <span class="o">=</span> <span class="n">deltachiroots</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="n">precomputedroots</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">deltachiplus</span><span class="o">-</span><span class="n">deltachiminus</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">deltachi3</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="n">deltachiminus</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">m</span></div>


<div class="viewcode-block" id="deltachitildeav"><a class="viewcode-back" href="../auto.html#precession.deltachitildeav">[docs]</a><span class="k">def</span> <span class="nf">deltachitildeav</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Precession average of the rescaled weighted spin difference.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    m: float</span>
<span class="sd">        Parameter of elliptic function(s).</span>
<span class="sd">    tol: float, optional (default: 1e-7)</span>
<span class="sd">        Numerical tolerance, see source code for details.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    coeff: float</span>
<span class="sd">        Coefficient.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``coeff = precession.deltachitildeav(m,tol=1e-7)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="c1"># The limit of the Ssav coefficient as m-&gt;0 is finite and equal to 1/2.</span>
    <span class="c1"># This is implementation is numerically stable up to m~1e-10.</span>
    <span class="c1"># For m=1e-7, the analytic m=0 limit is returned with a precision of 1e-9, which is enough.</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">tol</span><span class="p">,</span> <span class="n">m</span><span class="p">),</span><span class="mi">1</span><span class="o">-</span><span class="n">tol</span><span class="p">)</span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">ellipe</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="o">/</span><span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">ellipk</span><span class="p">(</span><span class="n">m</span><span class="p">))</span><span class="o">/</span><span class="n">m</span>

    <span class="k">return</span> <span class="n">coeff</span></div>


<div class="viewcode-block" id="deltachitildeav2"><a class="viewcode-back" href="../auto.html#precession.deltachitildeav2">[docs]</a><span class="k">def</span> <span class="nf">deltachitildeav2</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Precession average of the rescaled weighted spin difference squared.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    m: float</span>
<span class="sd">        Parameter of elliptic function(s).</span>
<span class="sd">    tol: float, optional (default: 1e-7)</span>
<span class="sd">        Numerical tolerance, see source code for details.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    coeff: float</span>
<span class="sd">        Coefficient.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``coeff = precession.deltachitildeav2(m,tol=1e-7)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="c1"># The limit of the Ssav coefficient as m-&gt;0 is finite and equal to 1/2.</span>
    <span class="c1"># This is implementation is numerically stable up to m~1e-10.</span>
    <span class="c1"># For m=1e-7, the analytic m=0 limit is returned with a precision of 1e-9, which is enough.</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">tol</span><span class="p">,</span> <span class="n">m</span><span class="p">),</span><span class="mi">1</span><span class="o">-</span><span class="n">tol</span><span class="p">)</span>

    <span class="n">coeff</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">+</span><span class="n">m</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">m</span><span class="p">)</span><span class="o">*</span><span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">ellipe</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="o">/</span><span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">ellipk</span><span class="p">(</span><span class="n">m</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">m</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">coeff</span></div>


<div class="viewcode-block" id="ddchidt_prefactor"><a class="viewcode-back" href="../auto.html#precession.ddchidt_prefactor">[docs]</a><span class="k">def</span> <span class="nf">ddchidt_prefactor</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Numerical prefactor to the ddeltachi/dt derivative.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    mathcalA: float</span>
<span class="sd">        Prefactor in the ddeltachi/dt equation.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``mathcalA = precession.ddchidt_prefactor(r,chieff,q)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chieff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chieff</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">mathcalA</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">11</span><span class="o">/</span><span class="mi">4</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="n">chieff</span><span class="o">/</span><span class="n">r</span><span class="o">**</span><span class="mf">0.5</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">mathcalA</span></div>


<div class="viewcode-block" id="dchidt2_RHS"><a class="viewcode-back" href="../auto.html#precession.dchidt2_RHS">[docs]</a><span class="k">def</span> <span class="nf">dchidt2_RHS</span><span class="p">(</span><span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">donotnormalize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Right-hand side of the (ddeltachi/dt)^2 equation. </span>
<span class="sd">    Setting donotnormalize=True is equivalent to mathcalA=1.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    deltachi: float</span>
<span class="sd">        Weighted spin difference.</span>
<span class="sd">    kappa: float</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    precomputedroots: array, optional (default: None)</span>
<span class="sd">        Pre-computed output of deltachiroots for computational efficiency.</span>
<span class="sd">    donotnormalize: boolean, optional (default: False)</span>
<span class="sd">        If True omit the numerical prefactor.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dchidt2: float</span>
<span class="sd">        Squared time derivative of the weighted spin difference.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``dchidt2 = precession.dchidt2_RHS(r,chieff,q)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">q</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">u</span><span class="o">=</span> <span class="n">eval_u</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span><span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">)</span>
    <span class="n">deltachiminus</span><span class="p">,</span><span class="n">deltachiplus</span><span class="p">,</span><span class="n">deltachi3</span> <span class="o">=</span> <span class="n">deltachiroots</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="n">precomputedroots</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">donotnormalize</span><span class="p">:</span>
        <span class="n">mathcalA</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mathcalA</span> <span class="o">=</span> <span class="n">ddchidt_prefactor</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
    
    <span class="n">dchidt2</span> <span class="o">=</span> <span class="n">mathcalA</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span><span class="n">deltachi</span><span class="o">-</span><span class="n">deltachiminus</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">deltachiplus</span><span class="o">-</span><span class="n">deltachi</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">deltachi3</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="n">deltachi</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">dchidt2</span></div>


<div class="viewcode-block" id="eval_tau"><a class="viewcode-back" href="../auto.html#precession.eval_tau">[docs]</a><span class="k">def</span> <span class="nf">eval_tau</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_psiperiod</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">donotnormalize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate the nutation period.</span>
<span class="sd">    Setting return_psiperiod=True return the phase-period instead of the time period (i.e. returns tau/2K(m) insteaf of tau). This is useful to avoid the evaluation of an elliptic integral when it&#39;s not needed.</span>
<span class="sd">    Setting donotnormalize=True is equivalent to mathcalA=1.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kappa: float</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    precomputedroots: array, optional (default: None)</span>
<span class="sd">        Pre-computed output of deltachiroots for computational efficiency.</span>
<span class="sd">    MISSING: COULD NOT BUILD, optional (default: False)</span>
<span class="sd">        FILL MANUALLY.</span>
<span class="sd">    donotnormalize: boolean, optional (default: False)</span>
<span class="sd">        If True omit the numerical prefactor.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tau: float</span>
<span class="sd">        Nutation period.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``tau = precession.eval_tau(kappa,r,chieff,q,chi1,chi2)``</span>
<span class="sd">    ``tau = precession.eval_tau(kappa,r,chieff,q,chi1,chi2,return_psiperiod=True)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">q</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">u</span> <span class="o">=</span> <span class="n">eval_u</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">q</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">donotnormalize</span><span class="p">:</span>
        <span class="n">mathcalA</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mathcalA</span> <span class="o">=</span> <span class="n">ddchidt_prefactor</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>

    <span class="n">deltachiminus</span><span class="p">,</span><span class="n">deltachiplus</span><span class="p">,</span><span class="n">deltachi3</span> <span class="o">=</span> <span class="n">deltachiroots</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="n">precomputedroots</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">elliptic_parameter</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">deltachiminus</span><span class="p">,</span><span class="n">deltachiplus</span><span class="p">,</span><span class="n">deltachi3</span><span class="p">]))</span>

    <span class="n">psiperiod</span> <span class="o">=</span>  <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span> <span class="n">mathcalA</span> <span class="o">*</span> <span class="p">(</span><span class="n">deltachi3</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="n">deltachiminus</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">if</span> <span class="n">return_psiperiod</span><span class="p">:</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">psiperiod</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">ellipk</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">psiperiod</span>

    <span class="k">return</span> <span class="n">tau</span></div>


<div class="viewcode-block" id="deltachioft"><a class="viewcode-back" href="../auto.html#precession.deltachioft">[docs]</a><span class="k">def</span> <span class="nf">deltachioft</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">kappa</span> <span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evolution of deltachi on the precessional timescale (without radiation reaction).</span>
<span class="sd">    The broadcasting rules for this function are more general than those of the rest of the code. The variable t is allowed to have shapes (N,M) while all the other variables have shape (N,). This is useful to sample M precession configuration for each of the N binaries specified as inputs.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    t: float</span>
<span class="sd">        Time.</span>
<span class="sd">    kappa: float</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    precomputedroots: array, optional (default: None)</span>
<span class="sd">        Pre-computed output of deltachiroots for computational efficiency.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    deltachi: float</span>
<span class="sd">        Weighted spin difference.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``deltachi = precession.deltachioft(t,kappa,r,chieff,q,chi1,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">eval_u</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">q</span><span class="p">)</span>

    <span class="n">deltachiminus</span><span class="p">,</span><span class="n">deltachiplus</span><span class="p">,</span><span class="n">deltachi3</span> <span class="o">=</span> <span class="n">deltachiroots</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="n">precomputedroots</span><span class="p">)</span>
    <span class="n">psiperiod</span> <span class="o">=</span> <span class="n">eval_tau</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">deltachiminus</span><span class="p">,</span><span class="n">deltachiplus</span><span class="p">,</span><span class="n">deltachi3</span><span class="p">]),</span> <span class="n">return_psiperiod</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


    <span class="n">m</span> <span class="o">=</span> <span class="n">elliptic_parameter</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">deltachiminus</span><span class="p">,</span><span class="n">deltachiplus</span><span class="p">,</span><span class="n">deltachi3</span><span class="p">]))</span>
 

    <span class="n">sn</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">ellipj</span><span class="p">(</span><span class="n">t</span> <span class="o">/</span> <span class="n">psiperiod</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
    <span class="n">deltachitilde</span> <span class="o">=</span> <span class="n">sn</span><span class="o">**</span><span class="mi">2</span>



    <span class="n">deltachi</span> <span class="o">=</span> <span class="n">deltachirescaling</span><span class="p">(</span><span class="n">deltachitilde</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span><span class="n">precomputedroots</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">deltachiminus</span><span class="p">,</span><span class="n">deltachiplus</span><span class="p">,</span><span class="n">deltachi3</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">deltachi</span></div>


<div class="viewcode-block" id="tofdeltachi"><a class="viewcode-back" href="../auto.html#precession.tofdeltachi">[docs]</a><span class="k">def</span> <span class="nf">tofdeltachi</span><span class="p">(</span><span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span> <span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">cyclesign</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Time as a function of deltachi on the precessional timescale (without radiation reaction).</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    deltachi: float</span>
<span class="sd">        Weighted spin difference.</span>
<span class="sd">    kappa: float</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    cyclesign: integer, optional (default: 1)</span>
<span class="sd">        Sign (either +1 or -1) to cover the two halves of a precesion cycle.</span>
<span class="sd">    precomputedroots: array, optional (default: None)</span>
<span class="sd">        Pre-computed output of deltachiroots for computational efficiency.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    t: float</span>
<span class="sd">        Time.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``t = precession.tofdeltachi(deltachi,kappa,r,chieff,q,chi1,chi2,cyclesign=1)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">u</span><span class="o">=</span> <span class="n">eval_u</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span><span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">)</span>
    <span class="n">deltachiminus</span><span class="p">,</span><span class="n">deltachiplus</span><span class="p">,</span><span class="n">deltachi3</span> <span class="o">=</span> <span class="n">deltachiroots</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="n">precomputedroots</span><span class="p">)</span>

    <span class="n">psiperiod</span> <span class="o">=</span> <span class="n">eval_tau</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">deltachiminus</span><span class="p">,</span><span class="n">deltachiplus</span><span class="p">,</span><span class="n">deltachi3</span><span class="p">]),</span> <span class="n">return_psiperiod</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">deltachitilde</span> <span class="o">=</span> <span class="n">affine</span><span class="p">(</span><span class="n">deltachi</span><span class="p">,</span><span class="n">deltachiminus</span><span class="p">,</span><span class="n">deltachiplus</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">elliptic_parameter</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">deltachiminus</span><span class="p">,</span><span class="n">deltachiplus</span><span class="p">,</span><span class="n">deltachi3</span><span class="p">]))</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">cyclesign</span><span class="p">)</span> <span class="o">*</span> <span class="n">psiperiod</span> <span class="o">*</span> <span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">ellipkinc</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">deltachitilde</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)),</span> <span class="n">m</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">t</span> </div>


<div class="viewcode-block" id="deltachisampling"><a class="viewcode-back" href="../auto.html#precession.deltachisampling">[docs]</a><span class="k">def</span> <span class="nf">deltachisampling</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sample N values of deltachi at fixed separation accoring to its PN-weighted distribution function.</span>
<span class="sd">    Can only be used to sample the *same* number of configuration for each binary. If the inputs have shape (M,) the output will have shape</span>
<span class="sd">        - (M,N) if M&gt;1 and N&gt;1;</span>
<span class="sd">        - (M,) if N=1;</span>
<span class="sd">        - (N,) if M=1.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kappa: float</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    N: integer, optional (default: 1)</span>
<span class="sd">        Number of samples.</span>
<span class="sd">    precomputedroots: array, optional (default: None)</span>
<span class="sd">        Pre-computed output of deltachiroots for computational efficiency.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    deltachi: float</span>
<span class="sd">        Weighted spin difference.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``deltachi = precession.deltachisampling(kappa,r,chieff,q,chi1,chi2,N=1)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">u</span><span class="o">=</span> <span class="n">eval_u</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span><span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">)</span>

    <span class="c1"># Compute the deltachi roots only once and pass them to both functions</span>
    <span class="n">deltachiminus</span><span class="p">,</span><span class="n">deltachiplus</span><span class="p">,</span><span class="n">deltachi3</span> <span class="o">=</span> <span class="n">deltachiroots</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="n">precomputedroots</span><span class="p">)</span>

    <span class="n">tau</span> <span class="o">=</span> <span class="n">eval_tau</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">deltachiminus</span><span class="p">,</span><span class="n">deltachiplus</span><span class="p">,</span><span class="n">deltachi3</span><span class="p">]))</span>

    <span class="c1"># For each binary, generate N samples between 0 and tau.</span>
    <span class="c1"># For r=infinity use a simple placeholder</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tau</span><span class="p">)),</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">u</span><span class="o">!=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">tau</span><span class="p">)))</span>


    <span class="c1"># np.squeeze is necessary to return shape (M,) instead of (M,1) if N=1</span>
    <span class="c1"># np.atleast_1d is necessary to return shape (1,) instead of (,) if M=N=1</span>
    <span class="n">t</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>

    <span class="c1"># Note the special broadcasting rules of deltachioft, see deltachioft.__docs__</span>
    <span class="c1"># deltachi has shape (M, N).</span>
    <span class="n">deltachi</span> <span class="o">=</span> <span class="n">deltachioft</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">kappa</span> <span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">deltachiminus</span><span class="p">,</span><span class="n">deltachiplus</span><span class="p">,</span><span class="n">deltachi3</span><span class="p">]))</span>

    <span class="c1"># For infinity use the analytic result. Ignore q=1 &quot;divide by zero&quot; warning:</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span>
        <span class="n">deltachiinf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span> <span class="n">eval_deltachiinf</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">),</span> <span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="p">))</span>

    <span class="n">deltachi</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">u</span><span class="o">!=</span><span class="mi">0</span><span class="p">,</span> <span class="n">deltachi</span><span class="p">,</span><span class="n">deltachiinf</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">deltachi</span><span class="o">.</span><span class="n">T</span><span class="p">)</span></div>


<span class="c1">################ Dynamics in an intertial frame ################</span>


<div class="viewcode-block" id="intertial_ingredients"><a class="viewcode-back" href="../auto.html#precession.intertial_ingredients">[docs]</a><span class="k">def</span> <span class="nf">intertial_ingredients</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Numerical prefactors entering the precession frequency.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kappa: float</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bigC0: float</span>
<span class="sd">        Prefactor in the OmegaL equation.</span>
<span class="sd">    bigCminus: float</span>
<span class="sd">        Prefactor in the OmegaL equation.</span>
<span class="sd">    bigCplus: float</span>
<span class="sd">        Prefactor in the OmegaL equation.</span>
<span class="sd">    bigRminus: float</span>
<span class="sd">        Prefactor in the PhiL equation.</span>
<span class="sd">    bigRplus: float</span>
<span class="sd">        Prefactor in the PhiL equation.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``bigC0,bigCplus,bigCminus,bigRplus,bigRminus = precession.intertial_ingredients(kappa,r,chieff,q,chi1,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">kappa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">kappa</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chieff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chieff</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>


    <span class="c1"># Machine generated with eq_generator.nb</span>
    <span class="n">bigC0</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> \
    <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">kappa</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Machine generated with eq_generator.nb</span>
    <span class="n">bigCplus</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> \
    <span class="n">kappa</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">chieff</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> \
    <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">kappa</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> \
    <span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> \
    <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">kappa</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> \
    <span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">chieff</span><span class="p">)))</span>

    <span class="c1"># Machine generated with eq_generator.nb</span>
    <span class="n">bigCminus</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> \
    <span class="n">kappa</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">chieff</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> \
    <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">kappa</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> \
    <span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> \
    <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">kappa</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> \
    <span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">chieff</span><span class="p">)))</span>

    <span class="c1"># Machine generated with eq_generator.nb</span>
    <span class="n">bigRplus</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> \
    <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">kappa</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="p">)</span>

    <span class="c1"># Machine generated with eq_generator.nb</span>
    <span class="n">bigRminus</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> \
    <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">kappa</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> \
    <span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">chieff</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">bigC0</span><span class="p">,</span> <span class="n">bigCplus</span><span class="p">,</span> <span class="n">bigCminus</span><span class="p">,</span><span class="n">bigRplus</span><span class="p">,</span><span class="n">bigRminus</span><span class="p">])</span></div>


<div class="viewcode-block" id="eval_OmegaL"><a class="viewcode-back" href="../auto.html#precession.eval_OmegaL">[docs]</a><span class="k">def</span> <span class="nf">eval_OmegaL</span><span class="p">(</span><span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate the precession frequency OmegaL along the precession cycle.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    deltachi: float</span>
<span class="sd">        Weighted spin difference.</span>
<span class="sd">    kappa: float</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    OmegaL: float</span>
<span class="sd">        Precession frequency of L about J.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``OmegaL = precession.eval_OmegaL(deltachi,kappa,r,chieff,q,chi1,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">deltachi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">deltachi</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">bigC0</span><span class="p">,</span> <span class="n">bigCplus</span><span class="p">,</span> <span class="n">bigCminus</span><span class="p">,</span><span class="n">bigRplus</span><span class="p">,</span><span class="n">bigRminus</span> <span class="o">=</span> <span class="n">intertial_ingredients</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>

    <span class="n">OmegaL</span> <span class="o">=</span>  <span class="n">bigC0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">bigCplus</span><span class="o">/</span><span class="p">(</span><span class="n">bigRplus</span> <span class="o">-</span> <span class="n">deltachi</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span> <span class="o">-</span>  <span class="n">bigCminus</span><span class="o">/</span><span class="p">(</span><span class="n">bigRminus</span> <span class="o">-</span> <span class="n">deltachi</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">OmegaL</span></div>



<div class="viewcode-block" id="eval_phiL"><a class="viewcode-back" href="../auto.html#precession.eval_phiL">[docs]</a><span class="k">def</span> <span class="nf">eval_phiL</span><span class="p">(</span><span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">cyclesign</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate the azimuthal angle of L in a plane orthogonal to J along the precession cycle.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    deltachi: float</span>
<span class="sd">        Weighted spin difference.</span>
<span class="sd">    kappa: float</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    cyclesign: integer, optional (default: 1)</span>
<span class="sd">        Sign (either +1 or -1) to cover the two halves of a precesion cycle.</span>
<span class="sd">    precomputedroots: array, optional (default: None)</span>
<span class="sd">        Pre-computed output of deltachiroots for computational efficiency.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    phiL: float</span>
<span class="sd">        Azimuthal angle spanned by L about J.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``phiL = precession.eval_phiL(deltachi,kappa,r,chieff,q,chi1,chi2,cyclesign=1)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    
    <span class="n">u</span><span class="o">=</span> <span class="n">eval_u</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span><span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">)</span>
    <span class="n">deltachiminus</span><span class="p">,</span><span class="n">deltachiplus</span><span class="p">,</span><span class="n">deltachi3</span> <span class="o">=</span> <span class="n">deltachiroots</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="n">precomputedroots</span><span class="p">)</span>

    <span class="n">bigC0</span><span class="p">,</span> <span class="n">bigCplus</span><span class="p">,</span> <span class="n">bigCminus</span><span class="p">,</span><span class="n">bigRplus</span><span class="p">,</span><span class="n">bigRminus</span> <span class="o">=</span> <span class="n">intertial_ingredients</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>

    <span class="n">psiperiod</span> <span class="o">=</span> <span class="n">eval_tau</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">deltachiminus</span><span class="p">,</span><span class="n">deltachiplus</span><span class="p">,</span><span class="n">deltachi3</span><span class="p">]),</span> <span class="n">return_psiperiod</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">deltachitilde</span> <span class="o">=</span> <span class="n">affine</span><span class="p">(</span><span class="n">deltachi</span><span class="p">,</span><span class="n">deltachiminus</span><span class="p">,</span><span class="n">deltachiplus</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">elliptic_parameter</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">deltachiminus</span><span class="p">,</span><span class="n">deltachiplus</span><span class="p">,</span><span class="n">deltachi3</span><span class="p">]))</span>

    <span class="n">phiL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">cyclesign</span><span class="p">)</span> <span class="o">*</span> <span class="n">bigC0</span> <span class="o">*</span> <span class="n">psiperiod</span> <span class="o">*</span> <span class="p">(</span> <span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">ellipkinc</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">deltachitilde</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)),</span> <span class="n">m</span><span class="p">)</span>
        <span class="o">-</span> <span class="n">bigCplus</span> <span class="o">/</span> <span class="p">(</span><span class="n">bigRplus</span> <span class="o">-</span> <span class="n">deltachiminus</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
        <span class="o">*</span> <span class="n">ellippi</span><span class="p">(</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">deltachiplus</span><span class="o">-</span><span class="n">deltachiminus</span><span class="p">)</span> <span class="o">/</span>  <span class="p">(</span><span class="n">bigRplus</span> <span class="o">-</span> <span class="n">deltachiminus</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">deltachitilde</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)),</span> <span class="n">m</span><span class="p">)</span>
        <span class="o">-</span> <span class="n">bigCminus</span> <span class="o">/</span> <span class="p">(</span><span class="n">bigRminus</span> <span class="o">-</span> <span class="n">deltachiminus</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
        <span class="o">*</span> <span class="n">ellippi</span><span class="p">(</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">deltachiplus</span><span class="o">-</span><span class="n">deltachiminus</span><span class="p">)</span> <span class="o">/</span>  <span class="p">(</span><span class="n">bigRminus</span> <span class="o">-</span> <span class="n">deltachiminus</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">deltachitilde</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)),</span> <span class="n">m</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">phiL</span> </div>



<div class="viewcode-block" id="eval_alpha"><a class="viewcode-back" href="../auto.html#precession.eval_alpha">[docs]</a><span class="k">def</span> <span class="nf">eval_alpha</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate the precession angle spanned by L during an entire cycle.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kappa: float</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    precomputedroots: array, optional (default: None)</span>
<span class="sd">        Pre-computed output of deltachiroots for computational efficiency.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    alpha: float</span>
<span class="sd">        Azimuthal angle spanned by L about J during an entire cycle.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``alpha = precession.eval_alpha(kappa,r,chieff,q,chi1,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">u</span><span class="o">=</span> <span class="n">eval_u</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span><span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        
        <span class="c1"># If there are infinitely large separation in the array the following will throw a warning. You can safely ignore it because that value is not used, see below  </span>
        <span class="k">if</span> <span class="mi">0</span> <span class="ow">in</span> <span class="n">u</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">Warning</span><span class="p">)</span>
 
        <span class="n">deltachiminus</span><span class="p">,</span><span class="n">deltachiplus</span><span class="p">,</span><span class="n">deltachi3</span> <span class="o">=</span> <span class="n">deltachiroots</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="n">precomputedroots</span><span class="p">)</span>
        <span class="n">bigC0</span><span class="p">,</span> <span class="n">bigCplus</span><span class="p">,</span> <span class="n">bigCminus</span><span class="p">,</span><span class="n">bigRplus</span><span class="p">,</span><span class="n">bigRminus</span> <span class="o">=</span> <span class="n">intertial_ingredients</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
        <span class="n">psiperiod</span> <span class="o">=</span> <span class="n">eval_tau</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">deltachiminus</span><span class="p">,</span><span class="n">deltachiplus</span><span class="p">,</span><span class="n">deltachi3</span><span class="p">]),</span><span class="n">return_psiperiod</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">elliptic_parameter</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">deltachiminus</span><span class="p">,</span><span class="n">deltachiplus</span><span class="p">,</span><span class="n">deltachi3</span><span class="p">]))</span>

        <span class="n">alpha</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">bigC0</span> <span class="o">*</span> <span class="n">psiperiod</span> <span class="o">*</span> <span class="p">(</span> <span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">ellipk</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="o">-</span> <span class="n">bigCplus</span> <span class="o">/</span> <span class="p">(</span><span class="n">bigRplus</span> <span class="o">-</span> <span class="n">deltachiminus</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
            <span class="o">*</span> <span class="n">ellippi</span><span class="p">(</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">deltachiplus</span><span class="o">-</span><span class="n">deltachiminus</span><span class="p">)</span> <span class="o">/</span>  <span class="p">(</span><span class="n">bigRplus</span> <span class="o">-</span> <span class="n">deltachiminus</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
            <span class="o">-</span> <span class="n">bigCminus</span> <span class="o">/</span> <span class="p">(</span><span class="n">bigRminus</span> <span class="o">-</span> <span class="n">deltachiminus</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
            <span class="o">*</span> <span class="n">ellippi</span><span class="p">(</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">deltachiplus</span><span class="o">-</span><span class="n">deltachiminus</span><span class="p">)</span> <span class="o">/</span>  <span class="p">(</span><span class="n">bigRminus</span> <span class="o">-</span> <span class="n">deltachiminus</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="p">)</span>

    <span class="c1"># At infinitely large separation use the analytic result</span>
    <span class="k">if</span> <span class="mi">0</span> <span class="ow">in</span> <span class="n">u</span><span class="p">:</span>
        
        <span class="n">mathcalY</span> <span class="o">=</span>  <span class="mi">2</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">kappa</span> <span class="o">*</span> <span class="n">chieff</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="mi">5</span> <span class="o">*</span> <span class="n">kappa</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span> <span class="o">*</span><span class="p">(</span><span class="n">chi1</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span><span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">alphainf1</span><span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="mi">4</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="o">/</span><span class="mi">3</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">alphainf2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">q</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">alphainf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mathcalY</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">,</span> <span class="n">alphainf1</span><span class="p">,</span> <span class="n">alphainf2</span><span class="p">)</span>
        <span class="n">alpha</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">u</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="n">alpha</span><span class="p">,</span><span class="n">alphainf</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">alpha</span> </div>


<span class="c1">################ More phenomenology ################</span>

<div class="viewcode-block" id="morphology"><a class="viewcode-back" href="../auto.html#precession.morphology">[docs]</a><span class="k">def</span> <span class="nf">morphology</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">simpler</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate the spin morphology. Returns:</span>
<span class="sd">        - L0 for librating about deltaphi=0,</span>
<span class="sd">        - Lpi for librating about deltaphi=pi</span>
<span class="sd">        - C- for circulating from deltaphi=pi to deltaphi=0,</span>
<span class="sd">        - C+ for circulating from deltaphi=0 to deltaphi=pi.</span>
<span class="sd">    If simpler=True, do not distinguish between the two circulating morphologies and return C for both.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kappa: float</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    simpler: boolean, optional (default: False)</span>
<span class="sd">        If True simplifies output.</span>
<span class="sd">    precomputedroots: array, optional (default: None)</span>
<span class="sd">        Pre-computed output of deltachiroots for computational efficiency.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    morph: string</span>
<span class="sd">        Spin morphology.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``morph = precession.morphology(kappa,r,chieff,q,chi1,chi2,simpler=False)``</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="n">deltachiminus</span><span class="p">,</span><span class="n">deltachiplus</span> <span class="o">=</span> <span class="n">deltachilimits_plusminus</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
    <span class="c1"># Pairs of booleans based on the values of deltaphi at S- and S+</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span><span class="n">eval_cosdeltaphi</span><span class="p">(</span><span class="n">deltachiminus</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">eval_cosdeltaphi</span><span class="p">(</span><span class="n">deltachiplus</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
    <span class="c1"># Map to labels</span>
    <span class="n">dictlabel</span> <span class="o">=</span> <span class="p">{(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="s2">&quot;Lpi&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="s2">&quot;L0&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="s2">&quot;C-&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="s2">&quot;C+&quot;</span><span class="p">}</span>
    <span class="c1"># Subsitute pairs with labels</span>
    <span class="n">morphs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">deltachiminus</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dictlabel</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">morphs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">status</span> <span class="o">==</span> <span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">v</span><span class="p">,</span> <span class="n">morphs</span><span class="p">)</span>
    <span class="c1"># Simplifies output, only one circulating morphology</span>
    <span class="k">if</span> <span class="n">simpler</span><span class="p">:</span>
        <span class="n">morphs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">morphs</span> <span class="o">==</span> <span class="s1">&#39;C+&#39;</span><span class="p">,</span> <span class="n">morphs</span> <span class="o">==</span> <span class="s1">&#39;C-&#39;</span><span class="p">),</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="n">morphs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">morphs</span></div>


<div class="viewcode-block" id="chip_terms"><a class="viewcode-back" href="../auto.html#precession.chip_terms">[docs]</a><span class="k">def</span> <span class="nf">chip_terms</span><span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the two terms entering the effective precessing spin chip.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    theta1: float</span>
<span class="sd">        Angle between orbital angular momentum and primary spin.</span>
<span class="sd">    theta2: float</span>
<span class="sd">        Angle between orbital angular momentum and secondary spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    chipterm1: float</span>
<span class="sd">        Term in effective precessing spin.</span>
<span class="sd">    chipterm2: float</span>
<span class="sd">        Term in effective precessing spin.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``chipterm1,chipterm2 = precession.chip_terms(theta1,theta2,q,chi1,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">theta1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">theta1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">theta2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">theta2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">chipterm1</span> <span class="o">=</span> <span class="n">chi1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta1</span><span class="p">)</span>
    <span class="n">omegatilde</span> <span class="o">=</span> <span class="n">q</span><span class="o">*</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">q</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">4</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">q</span><span class="p">)</span>
    <span class="n">chipterm2</span> <span class="o">=</span> <span class="n">omegatilde</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">chipterm1</span><span class="p">,</span> <span class="n">chipterm2</span><span class="p">])</span></div>


<div class="viewcode-block" id="eval_chip_heuristic"><a class="viewcode-back" href="../auto.html#precession.eval_chip_heuristic">[docs]</a><span class="k">def</span> <span class="nf">eval_chip_heuristic</span><span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Heuristic definition of the effective precessing spin chip (Schmidt et al 2015), see arxiv:2011.11948. This definition inconsistently averages over some, but not all, variations on the precession timescale.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    theta1: float</span>
<span class="sd">        Angle between orbital angular momentum and primary spin.</span>
<span class="sd">    theta2: float</span>
<span class="sd">        Angle between orbital angular momentum and secondary spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    chip: float</span>
<span class="sd">        Effective precessing spin.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``chip = precession.eval_chip_heuristic(theta1,theta2,q,chi1,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">term1</span><span class="p">,</span> <span class="n">term2</span> <span class="o">=</span> <span class="n">chip_terms</span><span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
    <span class="n">chip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">term1</span><span class="p">,</span> <span class="n">term2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chip</span></div>


<div class="viewcode-block" id="eval_chip_generalized"><a class="viewcode-back" href="../auto.html#precession.eval_chip_generalized">[docs]</a><span class="k">def</span> <span class="nf">eval_chip_generalized</span><span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generalized definition of the effective precessing spin chip, see arxiv:2011.11948. This definition retains all variations on the precession timescale.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    theta1: float</span>
<span class="sd">        Angle between orbital angular momentum and primary spin.</span>
<span class="sd">    theta2: float</span>
<span class="sd">        Angle between orbital angular momentum and secondary spin.</span>
<span class="sd">    deltaphi: float</span>
<span class="sd">        Angle between the projections of the two spins onto the orbital plane.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    chip: float</span>
<span class="sd">        Effective precessing spin.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``chip = precession.eval_chip_generalized(theta1,theta2,deltaphi,q,chi1,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">term1</span><span class="p">,</span> <span class="n">term2</span> <span class="o">=</span> <span class="n">chip_terms</span><span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
    <span class="n">chip</span> <span class="o">=</span> <span class="p">(</span><span class="n">term1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">term2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">term1</span><span class="o">*</span><span class="n">term2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">deltaphi</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span>
    <span class="k">return</span> <span class="n">chip</span></div>


<div class="viewcode-block" id="eval_chip_averaged"><a class="viewcode-back" href="../auto.html#precession.eval_chip_averaged">[docs]</a><span class="k">def</span> <span class="nf">eval_chip_averaged</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Averaged definition of the effective precessing spin, see arxiv:2011.11948.</span>
<span class="sd">    Additional keywords arguments are passed to `precession_average`.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kappa: float</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    **kwargs: unpacked dictionary, optional</span>
<span class="sd">        Additional keyword arguments.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    chip: float</span>
<span class="sd">        Effective precessing spin.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``chip = precession.eval_chip_averaged(kappa,r,chieff,q,chi1,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_integrand</span><span class="p">(</span><span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">):</span>
        <span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span> <span class="o">=</span> <span class="n">conserved_to_angles</span><span class="p">(</span><span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
        <span class="n">chip_integrand</span> <span class="o">=</span> <span class="n">eval_chip_generalized</span><span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">chip_integrand</span>

    <span class="n">chip</span> <span class="o">=</span> <span class="n">precession_average</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">_integrand</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">chip</span></div>


<div class="viewcode-block" id="eval_chip_rms"><a class="viewcode-back" href="../auto.html#precession.eval_chip_rms">[docs]</a><span class="k">def</span> <span class="nf">eval_chip_rms</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Root-mean-square definition of the effective precessing spin. This is much faster to evaluate than the plain average.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kappa: float</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    chip: float</span>
<span class="sd">        Effective precessing spin.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``chip = precession.eval_chip_rms(kappa,r,chieff,q,chi1,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">kappa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">kappa</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chieff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chieff</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">u</span><span class="o">=</span><span class="n">eval_u</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span><span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">)</span>

    <span class="c1"># Machine generated with eq_generator.nb</span>
    <span class="n">lambdabar</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">4</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Machine generated with eq_generator.nb</span>
    <span class="n">lambda2</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span>

    <span class="c1"># Machine generated with eq_generator.nb</span>
    <span class="n">lambda1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">((</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> \
    <span class="n">q</span><span class="p">)</span> <span class="o">+</span> <span class="mi">7</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">chieff</span><span class="p">)</span>

    <span class="c1"># Machine generated with eq_generator.nb</span>
    <span class="n">lambda0</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">kappa</span> \
    <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">chieff</span><span class="p">)</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="p">(</span><span class="mi">12</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="n">chi1</span><span class="o">**</span><span class="mi">2</span> \
    <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">49</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> \
    <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

    <span class="n">deltachiminus</span><span class="p">,</span><span class="n">deltachiplus</span><span class="p">,</span><span class="n">deltachi3</span> <span class="o">=</span> <span class="n">deltachiroots</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">elliptic_parameter</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">deltachiminus</span><span class="p">,</span> <span class="n">deltachiplus</span><span class="p">,</span> <span class="n">deltachi3</span><span class="p">]))</span>
    
    <span class="n">chip</span> <span class="o">=</span> <span class="n">lambdabar</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span><span class="n">deltachiplus</span><span class="o">-</span><span class="n">deltachiminus</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">lambda2</span> <span class="o">*</span> <span class="n">deltachitildeav2</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>  <span class="o">+</span>
        <span class="p">(</span><span class="n">deltachiplus</span><span class="o">-</span><span class="n">deltachiminus</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">lambda1</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">deltachiminus</span><span class="o">*</span><span class="n">lambda2</span><span class="p">)</span> <span class="o">*</span> <span class="n">deltachitildeav</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">+</span>
        <span class="p">(</span><span class="n">deltachiminus</span><span class="o">*</span><span class="n">lambda1</span> <span class="o">+</span> <span class="n">deltachiminus</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">lambda2</span> <span class="o">+</span> <span class="n">lambda0</span> <span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Debug:</span>
    <span class="c1"># def _integrand(deltachi, kappa, r, chieff, q, chi1, chi2):</span>
    <span class="c1">#     theta1, theta2, deltaphi = conserved_to_angles(deltachi, kappa, r, chieff, q, chi1, chi2)</span>
    <span class="c1">#     chip_integrand = eval_chip_generalized(theta1, theta2, deltaphi, q, chi1, chi2)**2</span>
    <span class="c1">#     return chip_integrand</span>
    <span class="c1"># chip = precession_average(kappa, r, chieff, q, chi1, chi2, _integrand, kappa, r, chieff, q, chi1, chi2, **kwargs)**0.5</span>

    <span class="k">return</span> <span class="n">chip</span></div>


<div class="viewcode-block" id="eval_chip"><a class="viewcode-back" href="../auto.html#precession.eval_chip">[docs]</a><span class="k">def</span> <span class="nf">eval_chip</span><span class="p">(</span><span class="n">theta1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">theta2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deltaphi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deltachi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chieff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chi1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chi2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;averaged&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the effective precessing spin. The keyword `which` one of the following definitions:</span>
<span class="sd">        - `heuristic`, as in Schmidt et al 2015. Required inputs are either</span>
<span class="sd">        - `generalized`, retail all precession-timescale variations,</span>
<span class="sd">        - `averaged` (default), averages over precession-timescale variations,</span>
<span class="sd">        - `rms`, compute the root-mean-square average, which is faster to evaluate.</span>
<span class="sd">    The required inputs are either (theta1,theta2,deltaphi,r,q,chi1,chi2) or (deltachi,kappa,chieff,r,q,chi1,chi2). In the latter case, deltachi can be omitted and will be resampled from its PN-weighted distribution.</span>
<span class="sd">    Some inputs will be ignored for some of the chip definitions (for instance the heuristic chip does not depend on either r or deltaphi), but dummy values are still requested for code consistency.</span>
<span class="sd">    The keywords arguments are only used for the `averaged` formulation and are passed to `precession_average`.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    theta1: float, optional (default: None)</span>
<span class="sd">        Angle between orbital angular momentum and primary spin.</span>
<span class="sd">    theta2: float, optional (default: None)</span>
<span class="sd">        Angle between orbital angular momentum and secondary spin.</span>
<span class="sd">    deltaphi: float, optional (default: None)</span>
<span class="sd">        Angle between the projections of the two spins onto the orbital plane.</span>
<span class="sd">    deltachi: float, optional (default: None)</span>
<span class="sd">        Weighted spin difference.</span>
<span class="sd">    kappa: float, optional (default: None)</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    r: float, optional (default: None)</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    chieff: float, optional (default: None)</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float, optional (default: None)</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float, optional (default: None)</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float, optional (default: None)</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    which: string, optional (default: &quot;averaged&quot;)</span>
<span class="sd">        Select function behavior.</span>
<span class="sd">    **kwargs: unpacked dictionary, optional</span>
<span class="sd">        Additional keyword arguments.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    chip: float</span>
<span class="sd">        Effective precessing spin.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``chip = precession.eval_chip(theta1=theta1,theta2=theta2,deltaphi=deltaphi,r=r,q=q,chi1=chi1,chi2=chi2,which=&quot;heuristic&quot;)``</span>
<span class="sd">    ``chip = precession.eval_chip(theta1=theta1,theta2=theta2,deltaphi=deltaphi,r=r,q=q,chi1=chi1,chi2=chi2,which=&quot;generalized&quot;)``</span>
<span class="sd">    ``chip = precession.eval_chip(theta1=theta1,theta2=theta2,deltaphi=deltaphi,r=r,q=q,chi1=chi1,chi2=chi2,which=&quot;averaged&quot;)``</span>
<span class="sd">    ``chip = precession.eval_chip(theta1=theta1,theta2=theta2,deltaphi=deltaphi,r=r,q=q,chi1=chi1,chi2=chi2,which=&quot;rms&quot;)``</span>
<span class="sd">    ``chip = precession.eval_chip(deltachi=deltachi,kappa=kappa,r=r,chieff=chieff,q=q,chi1=chi1,chi2=chi2,which=&quot;heuristic&quot;)``</span>
<span class="sd">    ``chip = precession.eval_chip(deltachi=deltachi,kappa=kappa,r=r,chieff=chieff,q=q,chi1=chi1,chi2=chi2,which=&quot;generalized&quot;)``</span>
<span class="sd">    ``chip = precession.eval_chip(deltachi=deltachi,kappa=kappa,r=r,chieff=chieff,q=q,chi1=chi1,chi2=chi2,which=&quot;averaged&quot;)``</span>
<span class="sd">    ``chip = precession.eval_chip(deltachi=deltachi,kappa=kappa,r=r,chieff=chieff,q=q,chi1=chi1,chi2=chi2,which=&quot;rms&quot;)``</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">q</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">chi1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">chi2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Provide r, q, chi1, and chi2.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">theta1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">theta2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">deltaphi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">deltachi</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">kappa</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chieff</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">chieff</span> <span class="o">=</span> <span class="n">angles_to_conserved</span><span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">full_output</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="k">elif</span> <span class="n">theta1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">theta2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">deltaphi</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">kappa</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chieff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">deltachi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;heuristic&#39;</span> <span class="ow">or</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;generalized&#39;</span><span class="p">:</span>
                <span class="n">deltachi</span> <span class="o">=</span> <span class="n">deltachisampling</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
        <span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span> <span class="o">=</span> <span class="n">conserved_to_angles</span><span class="p">(</span><span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
     
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Provide either (theta1,theta2,deltaphi), (deltachi,kappa,chieff), or (kappa,chieff).&quot;</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;heuristic&#39;</span><span class="p">:</span>
        <span class="n">chip</span> <span class="o">=</span> <span class="n">eval_chip_heuristic</span><span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;generalized&#39;</span><span class="p">:</span>
        <span class="n">chip</span> <span class="o">=</span> <span class="n">eval_chip_generalized</span><span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;averaged&#39;</span><span class="p">:</span>
        <span class="n">chip_finite</span> <span class="o">=</span> <span class="n">eval_chip_averaged</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">term1</span><span class="p">,</span> <span class="n">term2</span> <span class="o">=</span> <span class="n">chip_terms</span><span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
        <span class="n">chip_infinity</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">term1</span><span class="o">+</span><span class="n">term2</span><span class="p">)</span> <span class="o">*</span> <span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">ellipe</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">term1</span><span class="o">*</span><span class="n">term2</span><span class="o">/</span><span class="p">(</span><span class="n">term1</span><span class="o">+</span><span class="n">term2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>         
        <span class="n">chip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">r</span><span class="o">!=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">chip_finite</span><span class="p">,</span> <span class="n">chip_infinity</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;rms&#39;</span><span class="p">:</span>
        <span class="n">chip_finite</span> <span class="o">=</span> <span class="n">eval_chip_rms</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>

        <span class="n">term1</span><span class="p">,</span> <span class="n">term2</span> <span class="o">=</span> <span class="n">chip_terms</span><span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
        <span class="n">chip_infinity</span> <span class="o">=</span> <span class="p">(</span><span class="n">term1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">term2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>         
        <span class="n">chip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">r</span><span class="o">!=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">chip_finite</span><span class="p">,</span> <span class="n">chip_infinity</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`which` needs to be one of the following: `heuristic`, `generalized`, `averaged`, &#39;rms`.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">chip</span></div>


<div class="viewcode-block" id="eval_nutation_freq"><a class="viewcode-back" href="../auto.html#precession.eval_nutation_freq">[docs]</a><span class="k">def</span> <span class="nf">eval_nutation_freq</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Nutation frequency of deltachi as it oscillates from deltachi- to deltachi+ back to deltachi-. </span>
<span class="sd">    This of the five phenomenological parameters from arxiv:2103.03894.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kappa: float</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    precomputedroots: array, optional (default: None)</span>
<span class="sd">        Pre-computed output of deltachiroots for computational efficiency.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    littleomega: float</span>
<span class="sd">        Squared time derivative of the weighted spin difference.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``littleomega = precession.eval_nutation_freq(kappa,r,chieff,q,chi1,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tau</span> <span class="o">=</span> <span class="n">eval_tau</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="n">precomputedroots</span><span class="p">)</span>
    <span class="n">littleomega</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">/</span> <span class="n">tau</span>
    <span class="k">return</span> <span class="n">littleomega</span></div>


<div class="viewcode-block" id="eval_bracket_omega"><a class="viewcode-back" href="../auto.html#precession.eval_bracket_omega">[docs]</a><span class="k">def</span> <span class="nf">eval_bracket_omega</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Precession average of the precession frequency deltachi as it oscillates from deltachi- to deltachi+ back to deltachi-.</span>
<span class="sd">    This of the five phenomenological parameters from arxiv:2103.03894.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kappa: float</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    precomputedroots: array, optional (default: None)</span>
<span class="sd">        Pre-computed output of deltachiroots for computational efficiency.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bracket_omega: float</span>
<span class="sd">        Precession-averaged precession frequency.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``bracket_omega = precession.eval_bracket_omega(kappa,r,chieff,q,chi1,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">alpha</span> <span class="o">=</span> <span class="n">eval_alpha</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="n">precomputedroots</span><span class="p">)</span>
    <span class="n">tau</span> <span class="o">=</span> <span class="n">eval_tau</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="n">precomputedroots</span><span class="p">)</span>
    <span class="n">bracket_omega</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">/</span> <span class="n">tau</span>
    <span class="k">return</span> <span class="n">bracket_omega</span></div>


<div class="viewcode-block" id="eval_delta_omega"><a class="viewcode-back" href="../auto.html#precession.eval_delta_omega">[docs]</a><span class="k">def</span> <span class="nf">eval_delta_omega</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Variation of the precession frequency of deltachi as it oscillates from deltachi- to deltachi+ back to deltachi-.</span>
<span class="sd">    This of the five phenomenological parameters from arxiv:2103.03894.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kappa: float</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    precomputedroots: array, optional (default: None)</span>
<span class="sd">        Pre-computed output of deltachiroots for computational efficiency.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    delta_omega: float</span>
<span class="sd">        Precession frequency variation due to nutation.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``delta_omega = precession.eval_delta_omega(kappa,r,chieff,q,chi1,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">precomputedroots</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">deltachimin</span><span class="p">,</span> <span class="n">deltachiplus</span> <span class="o">=</span> <span class="n">deltachilimits_plusminus</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">deltachimin</span><span class="p">,</span> <span class="n">deltachiplus</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">precomputedroots</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Omega_minus</span> <span class="o">=</span> <span class="n">eval_OmegaL</span><span class="p">(</span><span class="n">deltachiplus</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
    <span class="n">Omega_plus</span> <span class="o">=</span> <span class="n">eval_OmegaL</span><span class="p">(</span><span class="n">deltachimin</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
    <span class="n">delta_omega</span> <span class="o">=</span> <span class="p">(</span><span class="n">Omega_plus</span> <span class="o">-</span> <span class="n">Omega_minus</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">delta_omega</span></div>


<div class="viewcode-block" id="eval_delta_theta"><a class="viewcode-back" href="../auto.html#precession.eval_delta_theta">[docs]</a><span class="k">def</span> <span class="nf">eval_delta_theta</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Nutation amplitude of deltachi as it oscillates from deltachi- to deltachi+ back to deltachi-.</span>
<span class="sd">    This of the five phenomenological parameters from arxiv:2103.03894.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kappa: float</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    precomputedroots: array, optional (default: None)</span>
<span class="sd">        Pre-computed output of deltachiroots for computational efficiency.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    delta_theta: float</span>
<span class="sd">        Nutation amplitude.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``delta_theta = precession.eval_delta_theta(kappa,r,chieff,q,chi1,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">precomputedroots</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">deltachimin</span><span class="p">,</span> <span class="n">deltachiplus</span> <span class="o">=</span> <span class="n">deltachilimits_plusminus</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">deltachimin</span><span class="p">,</span> <span class="n">deltachiplus</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">precomputedroots</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">theta_minus</span> <span class="o">=</span> <span class="n">eval_thetaL</span><span class="p">(</span><span class="n">deltachiplus</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
    <span class="n">theta_plus</span> <span class="o">=</span> <span class="n">eval_thetaL</span><span class="p">(</span><span class="n">deltachimin</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
    <span class="n">delta_theta</span> <span class="o">=</span> <span class="p">(</span><span class="n">theta_plus</span> <span class="o">-</span> <span class="n">theta_minus</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">delta_theta</span></div>


<div class="viewcode-block" id="eval_bracket_theta"><a class="viewcode-back" href="../auto.html#precession.eval_bracket_theta">[docs]</a><span class="k">def</span> <span class="nf">eval_bracket_theta</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Precession average of precession amplitude of deltachi as it oscillates from deltachi- to deltachi+ back to deltachi-.</span>
<span class="sd">    This of the five phenomenological parameters from arxiv:2103.03894. Additional keywords arguments are passed to `precession_average`.</span>

<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kappa: float</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    **kwargs: unpacked dictionary, optional</span>
<span class="sd">        Additional keyword arguments.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bracket_theta: float</span>
<span class="sd">        Precession-averaged precession amplitude.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``bracket_theta = precession.eval_bracket_theta(kappa,r,chieff,q,chi1,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_integrand</span><span class="p">(</span><span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
        <span class="n">bracket_theta_integrand</span> <span class="o">=</span> <span class="n">eval_thetaL</span><span class="p">(</span><span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bracket_theta_integrand</span>

    <span class="n">bracket_theta</span> <span class="o">=</span> <span class="n">precession_average</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">_integrand</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bracket_theta</span></div>


<div class="viewcode-block" id="rupdown"><a class="viewcode-back" href="../auto.html#precession.rupdown">[docs]</a><span class="k">def</span> <span class="nf">rupdown</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The critical separations r_ud+/- marking the region of the up-down precessional instability.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    rudm: float</span>
<span class="sd">        Inner orbital separation in the up-down instability.</span>
<span class="sd">    rudp: float</span>
<span class="sd">        Outer orbital separation in the up-down instability.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``rudp,rudm = precession.rupdown(q,chi1,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="c1">#Ignore q=1 &quot;divide by zero&quot; warning here</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span>
        <span class="n">rudp</span> <span class="o">=</span> <span class="p">(</span><span class="n">chi1</span><span class="o">**</span><span class="mf">0.5</span><span class="o">+</span><span class="p">(</span><span class="n">q</span><span class="o">*</span><span class="n">chi2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span><span class="o">**</span><span class="mi">4</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">rudm</span> <span class="o">=</span> <span class="p">(</span><span class="n">chi1</span><span class="o">**</span><span class="mf">0.5</span><span class="o">-</span><span class="p">(</span><span class="n">q</span><span class="o">*</span><span class="n">chi2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span><span class="o">**</span><span class="mi">4</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">rudp</span><span class="p">,</span> <span class="n">rudm</span><span class="p">])</span></div>


<div class="viewcode-block" id="updown_endpoint"><a class="viewcode-back" href="../auto.html#precession.updown_endpoint">[docs]</a><span class="k">def</span> <span class="nf">updown_endpoint</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Endpoint of the up-down precessional instability.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    deltaphi: float</span>
<span class="sd">        Angle between the projections of the two spins onto the orbital plane.</span>
<span class="sd">    theta1: float</span>
<span class="sd">        Angle between orbital angular momentum and primary spin.</span>
<span class="sd">    theta2: float</span>
<span class="sd">        Angle between orbital angular momentum and secondary spin.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``theta1,theta2,deltaphi = precession.updown_endpoint(q,chi1,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    
    <span class="n">costhetaupdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">chi1</span> <span class="o">-</span> <span class="n">q</span> <span class="o">*</span> <span class="n">chi2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">chi1</span> <span class="o">+</span> <span class="n">q</span> <span class="o">*</span> <span class="n">chi2</span><span class="p">)</span>

    <span class="n">theta1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">costhetaupdown</span><span class="p">)</span>
    <span class="n">theta2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">costhetaupdown</span><span class="p">)</span>
    <span class="n">deltaphi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">theta1</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span><span class="p">])</span></div>


<div class="viewcode-block" id="angleresonances_endpoint"><a class="viewcode-back" href="../auto.html#precession.angleresonances_endpoint">[docs]</a><span class="k">def</span> <span class="nf">angleresonances_endpoint</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">chieff</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Small-separation limit of the spin-orbit resonances.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    deltaphiatmax: float</span>
<span class="sd">        Value of the angle deltaphi at the resonance that maximizes kappa.</span>
<span class="sd">    deltaphiatmin: float</span>
<span class="sd">        Value of the angle deltaphi at the resonance that minimizes kappa.</span>
<span class="sd">    theta1atmax: float</span>
<span class="sd">        Value of the angle theta1 at the resonance that maximizes kappa.</span>
<span class="sd">    theta1atmin: float</span>
<span class="sd">        Value of the angle theta1 at the resonance that minimizes kappa.</span>
<span class="sd">    theta2atmax: float</span>
<span class="sd">        Value of the angle theta2 at the resonance that maximizes kappa.</span>
<span class="sd">    theta2atmin: float</span>
<span class="sd">        Value of the angle theta2 at the resonance that minimizes kappa.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``theta1atmin,theta2atmin,deltaphiatmin,theta1atmax,theta2atmax,deltaphiatmax = precession.angleresonances_endpoint(q,chi1,chi2,chieff)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chieff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chieff</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    
    <span class="n">chieff_uu</span> <span class="o">=</span> <span class="n">eval_chieff</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
    <span class="n">chieff_ud</span> <span class="o">=</span> <span class="n">eval_chieff</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
    
    <span class="n">thetakappaplus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">chieff</span> <span class="o">/</span> <span class="n">chieff_uu</span><span class="p">)</span>
    <span class="n">deltaphikappaplus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">thetakappaplus</span><span class="p">)</span>
    
    
    <span class="n">condition</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">chieff</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">chieff_ud</span><span class="p">)</span>
    <span class="n">costheta1kappaminus_less</span> <span class="o">=</span> <span class="n">chieff</span> <span class="o">/</span> <span class="n">chieff_ud</span>
    <span class="n">costheta1kappaminus_gtr</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">chieff_ud</span><span class="o">*</span><span class="n">chieff_uu</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">chi1</span><span class="o">*</span><span class="n">chieff</span><span class="p">)</span>
    <span class="n">costheta1kappaminus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">costheta1kappaminus_less</span><span class="p">,</span> <span class="n">costheta1kappaminus_gtr</span><span class="p">)</span>
    <span class="n">theta1kappaminus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">costheta1kappaminus</span><span class="p">)</span>
    <span class="n">costheta2kappaminus_less</span> <span class="o">=</span> <span class="o">-</span><span class="n">costheta1kappaminus_less</span>
    <span class="n">costheta2kappaminus_gtr</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">chieff</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">chieff_ud</span><span class="o">*</span><span class="n">chieff_uu</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="o">*</span><span class="n">chi2</span><span class="o">*</span><span class="n">chieff</span><span class="p">)</span>
    <span class="n">costheta2kappaminus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">costheta2kappaminus_less</span><span class="p">,</span> <span class="n">costheta2kappaminus_gtr</span><span class="p">)</span>
    <span class="n">theta2kappaminus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">costheta2kappaminus</span><span class="p">)</span>
    <span class="n">deltaphikappaminus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">condition</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">theta1kappaminus</span><span class="p">,</span> <span class="n">theta2kappaminus</span><span class="p">,</span> <span class="n">deltaphikappaminus</span><span class="p">,</span> <span class="n">thetakappaplus</span><span class="p">,</span> <span class="n">thetakappaplus</span><span class="p">,</span> <span class="n">deltaphikappaplus</span><span class="p">])</span></div>


<div class="viewcode-block" id="omegasq_aligned"><a class="viewcode-back" href="../auto.html#precession.omegasq_aligned">[docs]</a><span class="k">def</span> <span class="nf">omegasq_aligned</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">which</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Squared oscillation frequency of a given perturbed aligned-spin binary.</span>
<span class="sd">    The flag which needs to be set to `uu` for up-up, `ud` for up-down, `du` for down-up or `dd` for down-down where the term before (after) the hyphen refers to the spin of the heavier (lighter) black hole.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    which: string</span>
<span class="sd">        Select function behavior.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    omegasq: float</span>
<span class="sd">        Squared frequency.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``omegasq = precession.omegasq_aligned(r,q,chi1,chi2,which)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="c1"># These are all the valid input flags</span>
    <span class="n">uulabels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;uu&#39;</span><span class="p">,</span> <span class="s1">&#39;up-up&#39;</span><span class="p">,</span> <span class="s1">&#39;upup&#39;</span><span class="p">,</span> <span class="s1">&#39;++&#39;</span><span class="p">])</span>
    <span class="n">udlabels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;ud&#39;</span><span class="p">,</span> <span class="s1">&#39;up-down&#39;</span><span class="p">,</span> <span class="s1">&#39;updown&#39;</span><span class="p">,</span> <span class="s1">&#39;+-&#39;</span><span class="p">])</span>
    <span class="n">dulabels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;du&#39;</span><span class="p">,</span> <span class="s1">&#39;down-up&#39;</span><span class="p">,</span> <span class="s1">&#39;downup&#39;</span><span class="p">,</span> <span class="s1">&#39;-+&#39;</span><span class="p">])</span>
    <span class="n">ddlabels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;dd&#39;</span><span class="p">,</span> <span class="s1">&#39;down-down&#39;</span><span class="p">,</span> <span class="s1">&#39;downdown&#39;</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">])</span>

    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">which</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">uulabels</span><span class="p">,</span> <span class="n">udlabels</span><span class="p">,</span> <span class="n">dulabels</span><span class="p">,</span> <span class="n">ddlabels</span><span class="p">]))</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="s2">&quot;Set `which` flag to either uu, ud, du, or dd.&quot;</span>

    <span class="c1"># +1 if primary is co-aligned, -1 if primary is counter-aligned</span>
    <span class="n">alpha1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">which</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">uulabels</span><span class="p">,</span> <span class="n">udlabels</span><span class="p">])),</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># +1 if secondary is co-aligned, -1 if secondary is counter-aligned</span>
    <span class="n">alpha2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">which</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">uulabels</span><span class="p">,</span> <span class="n">dulabels</span><span class="p">])),</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">theta1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">alpha1</span><span class="p">)</span>
    <span class="n">theta2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">alpha2</span><span class="p">)</span>
    <span class="n">deltachi</span> <span class="o">=</span> <span class="n">eval_deltachi</span><span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
    <span class="n">chieff</span> <span class="o">=</span> <span class="n">eval_chieff</span><span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
    
    <span class="n">omegasq</span> <span class="o">=</span> <span class="p">(</span><span class="mi">9</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">r</span><span class="p">)</span><span class="o">**</span><span class="mi">7</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span><span class="o">**</span><span class="mf">0.5</span><span class="o">-</span><span class="n">chieff</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span>
        <span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">r</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">))</span><span class="o">*</span><span class="n">deltachi</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">chieff</span><span class="o">**</span><span class="mi">2</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">omegasq</span></div>


<div class="viewcode-block" id="widenutation_separation"><a class="viewcode-back" href="../auto.html#precession.widenutation_separation">[docs]</a><span class="k">def</span> <span class="nf">widenutation_separation</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The critical separation r_wide below which the binary component with</span>
<span class="sd">    smaller dimensionless spin may undergo wide nutations.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    r_wide: float</span>
<span class="sd">        Orbital separation where wide nutations becomes possible.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``r_wide = precession.widenutation_separation(q,chi1,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">rwide</span> <span class="o">=</span> <span class="p">((</span><span class="n">chi1</span> <span class="o">-</span> <span class="n">q</span><span class="o">*</span><span class="n">chi2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">return</span> <span class="n">rwide</span></div>


<div class="viewcode-block" id="widenutation_condition"><a class="viewcode-back" href="../auto.html#precession.widenutation_condition">[docs]</a><span class="k">def</span> <span class="nf">widenutation_condition</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Conditions for wide nutation to take place. The returned flag which is</span>
<span class="sd">        - `wide1` if wide nutation is allowed for the primary BH.</span>
<span class="sd">        - `wide2` if wide nutation is allowed for the secondary BH.</span>
<span class="sd">        - `nowide` if wide nutation is not allowed.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    kappa: float</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    which: string</span>
<span class="sd">        Select function behavior.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``which,kappa,chieff = precession.widenutation_condition(r,q,chi1,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">rwide</span> <span class="o">=</span> <span class="n">widenutation_separation</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>

    <span class="n">kappawide1</span> <span class="o">=</span> <span class="p">(</span><span class="n">chi1</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="o">*</span><span class="n">chi1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">4</span><span class="o">*</span><span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">r</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">chieffwide1</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="mf">0.5</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span>

    <span class="n">kappawide2</span> <span class="o">=</span> <span class="p">(</span><span class="n">chi1</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="n">chi1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">4</span><span class="o">*</span><span class="n">chi2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">r</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">chieffwide2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="mf">0.5</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span>

    <span class="n">which</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">r</span><span class="o">&lt;=</span><span class="n">rwide</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">chi1</span><span class="o">&lt;=</span><span class="n">chi2</span><span class="p">,</span><span class="s2">&quot;wide1&quot;</span><span class="p">,</span><span class="s2">&quot;wide2&quot;</span><span class="p">),</span> <span class="s2">&quot;nowide&quot;</span><span class="p">)</span>
    <span class="n">kappa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">r</span><span class="o">&lt;=</span><span class="n">rwide</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">chi1</span><span class="o">&lt;=</span><span class="n">chi2</span><span class="p">,</span><span class="n">kappawide1</span><span class="p">,</span><span class="n">kappawide2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">chieff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">r</span><span class="o">&lt;=</span><span class="n">rwide</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">chi1</span><span class="o">&lt;=</span><span class="n">chi2</span><span class="p">,</span><span class="n">chieffwide1</span><span class="p">,</span><span class="n">chieffwide2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">[(</span><span class="n">which</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">chieff</span><span class="p">)]</span></div>


<span class="c1">################ Precession-averaged evolution ################</span>


<div class="viewcode-block" id="rhs_precav"><a class="viewcode-back" href="../auto.html#precession.rhs_precav">[docs]</a><span class="k">def</span> <span class="nf">rhs_precav</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Right-hand side of the dkappa/du ODE describing precession-averaged inspiral.</span>
<span class="sd">    This is an internal function used by the ODE integrator and is not array-compatible.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kappa: float</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    u: float</span>
<span class="sd">        Compactified separation 1/(2L).</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    RHS: float</span>
<span class="sd">        Right-hand side.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``RHS = precession.rhs_precav(kappa,u,chieff,q,chi1,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">u</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
       <span class="c1"># In this case use analytic result</span>
        <span class="k">if</span> <span class="n">q</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># TODO: think about this again</span>
            <span class="n">Ssav</span> <span class="o">=</span> <span class="p">(</span><span class="n">chi1</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="mi">4</span>  <span class="c1">#- ( 2*q*(kappa*(1+q) -chieff)*(kappa*(1+q) -q*chieff)/((-1 + q)**2 *(1 + q)**2))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Ssav</span> <span class="o">=</span> <span class="p">(</span><span class="n">chi1</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">q</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="mi">4</span>  <span class="o">-</span> <span class="p">(</span> <span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="o">*</span><span class="p">(</span><span class="n">kappa</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span> <span class="o">-</span><span class="n">chieff</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">kappa</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span> <span class="o">-</span><span class="n">q</span><span class="o">*</span><span class="n">chieff</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># I don&#39;t use deltachiroots here because I want to keep complex numbers. This is needed to sanitize the output in some tricky cases</span>
        <span class="n">coeffs</span> <span class="o">=</span> <span class="n">deltachicubic_coefficients</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>        
        <span class="n">coeffsr</span> <span class="o">=</span> <span class="n">deltachicubic_rescaled_coefficients</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">precomputedcoefficients</span><span class="o">=</span><span class="n">coeffs</span><span class="p">)</span>
        <span class="n">deltachiminus</span><span class="p">,</span> <span class="n">deltachiplus</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort_complex</span><span class="p">(</span><span class="n">roots_vec</span><span class="p">(</span><span class="n">coeffs</span><span class="o">.</span><span class="n">T</span><span class="p">)))</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">deltachi3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort_complex</span><span class="p">(</span><span class="n">roots_vec</span><span class="p">(</span><span class="n">coeffsr</span><span class="o">.</span><span class="n">T</span><span class="p">)))</span>

        <span class="c1"># deltachiminus, deltachiplus are complex. This can happen if the binary is very close to a spin-orbit resonance</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">iscomplex</span><span class="p">(</span><span class="n">deltachiminus</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">iscomplex</span><span class="p">(</span><span class="n">deltachiplus</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Sanitizing RHS output; too close to resonance. [rhs_precav].&quot;</span><span class="p">,</span> <span class="ne">Warning</span><span class="p">)</span>
            <span class="n">deltachiav</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">([</span><span class="n">deltachiminus</span><span class="p">,</span> <span class="n">deltachiplus</span><span class="p">]))</span>

        <span class="c1"># Normal case</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">deltachiminus</span><span class="p">,</span> <span class="n">deltachiplus</span><span class="p">,</span> <span class="n">deltachi3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">([</span><span class="n">deltachiminus</span><span class="p">,</span> <span class="n">deltachiplus</span><span class="p">,</span> <span class="n">deltachi3</span><span class="p">])</span>      
            <span class="n">m</span> <span class="o">=</span> <span class="n">elliptic_parameter</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">deltachiminus</span><span class="p">,</span> <span class="n">deltachiplus</span><span class="p">,</span> <span class="n">deltachi3</span><span class="p">]))</span>
            <span class="n">deltachiav</span> <span class="o">=</span> <span class="n">inverseaffine</span><span class="p">(</span> <span class="n">deltachitildeav</span><span class="p">(</span><span class="n">m</span><span class="p">),</span>  <span class="n">deltachiminus</span><span class="p">,</span> <span class="n">deltachiplus</span><span class="p">)</span>

        <span class="n">Ssav</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">kappa</span> <span class="o">-</span> <span class="n">chieff</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="n">deltachiav</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">u</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">Ssav</span><span class="p">)</span></div>


<div class="viewcode-block" id="integrator_precav"><a class="viewcode-back" href="../auto.html#precession.integrator_precav">[docs]</a><span class="k">def</span> <span class="nf">integrator_precav</span><span class="p">(</span><span class="n">kappainitial</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="o">**</span><span class="n">odeint_kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Integration of ODE dkappa/du describing precession-averaged inspirals. Here u needs to be an array with lenght &gt;=1, where u[0] corresponds to the initial condition and u[1:] corresponds to the location where outputs are returned. For past time infinity use u=0.</span>
<span class="sd">    The function is vectorized: evolving N multiple binaries with M outputs requires kappainitial, chieff, q, chi1, chi2 to be of shape (N,) and u of shape (M,N).</span>
<span class="sd">    Additional keywords arguments are passed to `scipy.integrate.odeint` after some custom-made default settings.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kappainitial: float</span>
<span class="sd">        Initial value of the regularized momentum kappa.</span>
<span class="sd">    u: float</span>
<span class="sd">        Compactified separation 1/(2L).</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    **odeint_kwargs: unpacked dictionary, optional</span>
<span class="sd">        Additional keyword arguments.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    kappa: float</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``kappa = precession.integrator_precav(kappainitial,u,chieff,q,chi1,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">kappainitial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">kappainitial</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chieff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chieff</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="c1"># Defaults for the integrators, can be changed by the user</span>
    <span class="k">if</span> <span class="s1">&#39;mxstep&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">odeint_kwargs</span><span class="p">:</span> <span class="n">odeint_kwargs</span><span class="p">[</span><span class="s1">&#39;mxstep&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">5000000</span>
    <span class="k">if</span> <span class="s1">&#39;rol&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">odeint_kwargs</span><span class="p">:</span> <span class="n">odeint_kwargs</span><span class="p">[</span><span class="s1">&#39;rtol&#39;</span><span class="p">]</span><span class="o">=</span><span class="mf">1e-10</span>
    <span class="k">if</span> <span class="s1">&#39;aol&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">odeint_kwargs</span><span class="p">:</span> <span class="n">odeint_kwargs</span><span class="p">[</span><span class="s1">&#39;atol&#39;</span><span class="p">]</span><span class="o">=</span><span class="mf">1e-10</span>
    <span class="c1"># I&#39;m sorry but this needs to be forced for compatibility with the rest of the code</span>
    <span class="n">odeint_kwargs</span><span class="p">[</span><span class="s1">&#39;full_output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> 

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="n">kappainitial</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">odeint_kwargs</span><span class="p">):</span>

        <span class="c1"># h0 controls the first stepsize attempted. If integrating from finite separation, let the solver decide (h0=0). If integrating from infinity, prevent it from being too small.</span>
        <span class="c1"># h0= 1e-3 if u[0]==0 else 0</span>

        <span class="c1"># Make sure the first step is large enough. This is to avoid LSODA to propose a tiny step which causes the integration to stall</span>
        <span class="c1"># if &#39;h0&#39; not in odeint_kwargs: odeint_kwargs[&#39;h0&#39;]=min(u[0])/1e6</span>
        <span class="c1"># Update: This does not seem to be necessary after all.</span>

        <span class="n">ODEsolution</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">odeint</span><span class="p">(</span><span class="n">rhs_precav</span><span class="p">,</span> <span class="n">kappainitial</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">),</span> <span class="o">**</span><span class="n">odeint_kwargs</span><span class="p">)</span><span class="c1">#, printmessg=0,rtol=1e-10,atol=1e-10)#,tcrit=sing)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">ODEsolution</span><span class="p">)</span>

        <span class="c1"># solve_ivp implementation. Didn&#39;t really work.</span>
        <span class="c1">#ODEsolution = scipy.integrate.solve_ivp(rhs_precav, (uinitial, ufinal), np.atleast_1d(kappainitial), method=&#39;RK45&#39;, t_eval=(uinitial, ufinal), dense_output=True, args=(chieff, q, chi1, chi2), atol=1e-8, rtol=1e-8)  # ,events=event)</span>
        <span class="c1"># Return ODE object. The key methods is .sol --callable, sol(t).</span>
        <span class="c1">#return ODEsolution</span>

    <span class="n">ODEsolution</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">_compute</span><span class="p">,</span> <span class="n">kappainitial</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">repeat</span><span class="p">(</span><span class="n">odeint_kwargs</span><span class="p">))))</span>

    <span class="k">return</span> <span class="n">ODEsolution</span></div>


<div class="viewcode-block" id="inspiral_precav"><a class="viewcode-back" href="../auto.html#precession.inspiral_precav">[docs]</a><span class="k">def</span> <span class="nf">inspiral_precav</span><span class="p">(</span><span class="n">theta1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">theta2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deltaphi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chieff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chi1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chi2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">requested_outputs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">enforce</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">odeint_kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform precession-averaged inspirals. The variables q, chi1, and chi2 must always be provided.</span>
<span class="sd">    The integration range must be specified using either r or u (and not both). These need to be arrays with lenght &gt;=1, where e.g. r[0] corresponds to the initial condition and r[1:] corresponds to the location where outputs are returned. For past time infinity use either u=0 or r=np.inf.</span>
<span class="sd">    The function is vectorized: evolving N multiple binaries with M outputs requires kappainitial, chieff, q, chi1, chi2 to be of shape (N,) and u of shape (M,N).</span>
<span class="sd">    The initial conditions must be specified in terms of one an only one of the following:</span>
<span class="sd">        - theta1,theta2, and deltaphi (but note that deltaphi is not necessary if integrating from infinite separation).</span>
<span class="sd">        - kappa, chieff.</span>
<span class="sd">    The desired outputs can be specified with a list e.g. requested_outputs=[&#39;theta1&#39;,&#39;theta2&#39;,&#39;deltaphi&#39;]. All the available variables are returned by default. These are: [&#39;theta1&#39;, &#39;theta2&#39;, &#39;deltaphi&#39;, &#39;deltachi&#39;, &#39;kappa&#39;, &#39;r&#39;, &#39;u&#39;, &#39;deltachiminus&#39;, &#39;deltachiplus&#39;, &#39;deltachi3&#39;, &#39;chieff&#39;, &#39;q&#39;, &#39;chi1&#39;, &#39;chi2&#39;].</span>
<span class="sd">    The flag enforce allows checking the consistency of the input variables.</span>
<span class="sd">    Additional keywords arguments are passed to `scipy.integrate.odeint` after some custom-made default settings.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    theta1: float, optional (default: None)</span>
<span class="sd">        Angle between orbital angular momentum and primary spin.</span>
<span class="sd">    theta2: float, optional (default: None)</span>
<span class="sd">        Angle between orbital angular momentum and secondary spin.</span>
<span class="sd">    deltaphi: float, optional (default: None)</span>
<span class="sd">        Angle between the projections of the two spins onto the orbital plane.</span>
<span class="sd">    kappa: float, optional (default: None)</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    r: float, optional (default: None)</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    u: float, optional (default: None)</span>
<span class="sd">        Compactified separation 1/(2L).</span>
<span class="sd">    chieff: float, optional (default: None)</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float, optional (default: None)</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float, optional (default: None)</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float, optional (default: None)</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    requested_outputs: list, optional (default: None)</span>
<span class="sd">        Set of outputs.</span>
<span class="sd">    enforce: boolean, optional (default: False)</span>
<span class="sd">        If True raise errors, if False raise warnings.</span>
<span class="sd">    **odeint_kwargs: unpacked dictionary, optional</span>
<span class="sd">        Additional keyword arguments.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    outputs: dictionary</span>
<span class="sd">        Set of outputs.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``outputs = precession.inspiral_precav(theta1=theta1,theta2=theta2,deltaphi=deltaphi,r=r,q=q,chi1=chi1,chi2=chi2)``</span>
<span class="sd">    ``outputs = precession.inspiral_precav(theta1=theta1,theta2=theta2,deltaphi=deltaphi,u=u,q=q,chi1=chi1,chi2=chi2)``</span>
<span class="sd">    ``outputs = precession.inspiral_precav(kappa,r=r,chieff=chieff,q=q,chi1=chi1,chi2=chi2)``</span>
<span class="sd">    ``outputs = precession.inspiral_precav(kappa,u=u,chieff=chieff,q=q,chi1=chi1,chi2=chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Substitute None inputs with arrays of Nones</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inputs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">inputs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tiler</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">))))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>  <span class="c1"># Either u or r</span>
                <span class="n">inputs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Any of the others</span>
                <span class="n">inputs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
    <span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span> <span class="o">=</span> <span class="n">inputs</span>

    <span class="c1"># This array has to match the outputs of _compute (in the right order!)</span>
    <span class="n">alloutputs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;theta1&#39;</span><span class="p">,</span> <span class="s1">&#39;theta2&#39;</span><span class="p">,</span> <span class="s1">&#39;deltaphi&#39;</span><span class="p">,</span> <span class="s1">&#39;deltachi&#39;</span><span class="p">,</span> <span class="s1">&#39;kappa&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;deltachiminus&#39;</span><span class="p">,</span> <span class="s1">&#39;deltachiplus&#39;</span><span class="p">,</span> <span class="s1">&#39;deltachi3&#39;</span><span class="p">,</span> <span class="s1">&#39;chieff&#39;</span><span class="p">,</span> <span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;chi1&#39;</span><span class="p">,</span> <span class="s1">&#39;chi2&#39;</span><span class="p">])</span>
    <span class="c1"># If in doubt, return everything</span>
    <span class="k">if</span> <span class="n">requested_outputs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">requested_outputs</span> <span class="o">=</span> <span class="n">alloutputs</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">):</span>

        <span class="c1"># Make sure you have q, chi1, and chi2.</span>
        <span class="k">if</span> <span class="n">q</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">chi1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">chi2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Please provide q, chi1, and chi2.&quot;</span><span class="p">)</span>

        <span class="c1"># Make sure you have either r or u.</span>
        <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">u</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">ismonotonic</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">),</span> <span class="n">ismonotonic</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">)),</span> <span class="s1">&#39;r must be monotonic&#39;</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">eval_u</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">tiler</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">r</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">u</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">ismonotonic</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">),</span> <span class="n">ismonotonic</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">)),</span> <span class="s1">&#39;u must be monotonic&#39;</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">eval_r</span><span class="p">(</span><span class="n">u</span><span class="o">=</span><span class="n">u</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="n">tiler</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">u</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Please provide either r or u. Use np.inf for infinity.&quot;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">u</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;There can only be one r=np.inf location, either at the beginning or at the end.&quot;</span>

        <span class="c1"># User provided theta1,theta2, and deltaphi. Get chieff and kappa.</span>
        <span class="k">if</span> <span class="n">theta1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">theta2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">deltaphi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">kappa</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chieff</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">chieff</span> <span class="o">=</span> <span class="n">angles_to_conserved</span><span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>

        <span class="c1"># User provides kappa, chieff</span>
        <span class="k">elif</span> <span class="n">theta1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">theta2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">deltaphi</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">kappa</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chieff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Please provide one and not more of the following: (theta1,theta2,deltaphi), (kappa,chieff).&quot;</span><span class="p">)</span>

        <span class="c1"># Enforce limits. Uncomment if you want to be more restrictive (though some integrations are going to fail for roundoff errors in the resonant finder)</span>
        <span class="k">if</span> <span class="n">enforce</span><span class="p">:</span>
            <span class="n">chieffmin</span><span class="p">,</span> <span class="n">chieffmax</span> <span class="o">=</span> <span class="n">chiefflimits</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">chieff</span> <span class="o">&gt;=</span> <span class="n">chieffmin</span> <span class="ow">and</span> <span class="n">chieff</span> <span class="o">&lt;=</span> <span class="n">chieffmax</span><span class="p">,</span> <span class="s2">&quot;Unphysical initial conditions [inspiral_precav].&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">theta1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">theta2</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">deltaphi</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">kappa</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">chieff</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">chi1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">chi2</span><span class="p">)</span>
            <span class="n">kappamin</span><span class="p">,</span><span class="n">kappamax</span> <span class="o">=</span> <span class="n">kappalimits</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">chieff</span><span class="o">=</span><span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="o">=</span><span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="o">=</span><span class="n">chi2</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">kappa</span> <span class="o">&gt;=</span> <span class="n">kappamin</span> <span class="ow">and</span> <span class="n">kappa</span> <span class="o">&lt;=</span> <span class="n">kappamax</span><span class="p">,</span> <span class="s2">&quot;Unphysical initial conditions [inspiral_precav].&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">theta1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">theta2</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">deltaphi</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">kappa</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">chieff</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">chi1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">chi2</span><span class="p">)</span>

        <span class="c1"># Actual integration.</span>
        <span class="n">kappa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">integrator_precav</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span><span class="o">**</span><span class="n">odeint_kwargs</span><span class="p">))</span>

        <span class="n">deltachiminus</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">deltachiplus</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">deltachi3</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">deltachi</span><span class="o">=</span><span class="kc">None</span>
        <span class="n">theta1</span><span class="o">=</span><span class="kc">None</span>
        <span class="n">theta2</span><span class="o">=</span><span class="kc">None</span>
        <span class="n">deltaphi</span><span class="o">=</span><span class="kc">None</span>

        <span class="c1"># Roots along the evolution</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">requested_outputs</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;theta1&#39;</span><span class="p">,</span> <span class="s1">&#39;theta2&#39;</span><span class="p">,</span> <span class="s1">&#39;deltaphi&#39;</span><span class="p">,</span> <span class="s1">&#39;deltachi&#39;</span><span class="p">,</span> <span class="s1">&#39;deltachiminus&#39;</span><span class="p">,</span> <span class="s1">&#39;deltachiplus&#39;</span><span class="p">,</span> <span class="s1">&#39;deltachi3&#39;</span><span class="p">]):</span>
            <span class="n">deltachiminus</span><span class="p">,</span><span class="n">deltachiplus</span><span class="p">,</span><span class="n">deltachi3</span> <span class="o">=</span> <span class="n">deltachiroots</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">tiler</span><span class="p">(</span><span class="n">chieff</span><span class="p">,</span><span class="n">r</span><span class="p">),</span> <span class="n">tiler</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">r</span><span class="p">),</span><span class="n">tiler</span><span class="p">(</span><span class="n">chi1</span><span class="p">,</span><span class="n">r</span><span class="p">),</span><span class="n">tiler</span><span class="p">(</span><span class="n">chi2</span><span class="p">,</span><span class="n">r</span><span class="p">))</span>

            <span class="c1"># Resample deltachi</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">requested_outputs</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;theta1&#39;</span><span class="p">,</span> <span class="s1">&#39;theta2&#39;</span><span class="p">,</span> <span class="s1">&#39;deltaphi&#39;</span><span class="p">,</span> <span class="s1">&#39;deltachi&#39;</span><span class="p">]):</span>
                <span class="n">deltachi</span> <span class="o">=</span> <span class="n">deltachisampling</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">tiler</span><span class="p">(</span><span class="n">chieff</span><span class="p">,</span><span class="n">r</span><span class="p">),</span> <span class="n">tiler</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">r</span><span class="p">),</span><span class="n">tiler</span><span class="p">(</span><span class="n">chi1</span><span class="p">,</span><span class="n">r</span><span class="p">),</span><span class="n">tiler</span><span class="p">(</span><span class="n">chi2</span><span class="p">,</span><span class="n">r</span><span class="p">),</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">deltachiminus</span><span class="p">,</span><span class="n">deltachiplus</span><span class="p">,</span><span class="n">deltachi3</span><span class="p">]))</span>

                <span class="c1"># Compute the angles. Assign random cyclesign</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">requested_outputs</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;theta1&#39;</span><span class="p">,</span> <span class="s1">&#39;theta2&#39;</span><span class="p">,</span> <span class="s1">&#39;deltaphi&#39;</span><span class="p">]):</span>
                    <span class="n">theta1</span><span class="p">,</span><span class="n">theta2</span><span class="p">,</span><span class="n">deltaphi</span> <span class="o">=</span> <span class="n">conserved_to_angles</span><span class="p">(</span><span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">tiler</span><span class="p">(</span><span class="n">chieff</span><span class="p">,</span><span class="n">r</span><span class="p">),</span> <span class="n">tiler</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">r</span><span class="p">),</span><span class="n">tiler</span><span class="p">(</span><span class="n">chi1</span><span class="p">,</span><span class="n">r</span><span class="p">),</span><span class="n">tiler</span><span class="p">(</span><span class="n">chi2</span><span class="p">,</span><span class="n">r</span><span class="p">),</span> <span class="n">cyclesign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">r</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span><span class="p">,</span> <span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">deltachiminus</span><span class="p">,</span> <span class="n">deltachiplus</span><span class="p">,</span> <span class="n">deltachi3</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span>

    <span class="c1"># Here I force dtype=object because the outputs have different shapes</span>
    <span class="n">allresults</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">_compute</span><span class="p">,</span> <span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># Return only requested outputs (in1d return boolean array)</span>
    <span class="n">wantoutputs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">alloutputs</span><span class="p">,</span> <span class="n">requested_outputs</span><span class="p">)</span>

    <span class="c1"># Store into a dictionary</span>
    <span class="n">outcome</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">alloutputs</span><span class="p">[</span><span class="n">wantoutputs</span><span class="p">],</span> <span class="n">allresults</span><span class="p">[</span><span class="n">wantoutputs</span><span class="p">]):</span>
        <span class="n">outcome</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

        <span class="c1"># For the constants of motion...</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;chieff&#39;</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;q&#39;</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;chi1&#39;</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;chi2&#39;</span><span class="p">:</span>  <span class="c1"># Constants of motion</span>
            <span class="n">outcome</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">outcome</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="c1">#... and everything else</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outcome</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">outcome</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">outcome</span></div>


<div class="viewcode-block" id="precession_average"><a class="viewcode-back" href="../auto.html#precession.precession_average">[docs]</a><span class="k">def</span> <span class="nf">precession_average</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;quadrature&#39;</span><span class="p">,</span> <span class="n">Nsamples</span><span class="o">=</span><span class="mf">1e4</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Average a generic function over a precession cycle. The function needs to have call: func(deltachi, *args). Keywords arguments are not supported.</span>
<span class="sd">    There are integration methods implemented:</span>
<span class="sd">        - method=&#39;quadrature&#39; uses scipy.integrate.quad. This is set by default and should be preferred.</span>
<span class="sd">        - method=&#39;montecarlo&#39; samples t(deltachi) and approximate the integral with a Monte Carlo sum. The number of samples can be specifed by Nsamples.</span>
<span class="sd">    Additional keyword arguments are passed to scipy.integrate.quad.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kappa: float</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    chieff: float</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    func: function</span>
<span class="sd">        Function to precession-average.</span>
<span class="sd">    *args: tuple</span>
<span class="sd">        Extra arguments to pass to func.</span>
<span class="sd">    method: string (default: &#39;quadrature&#39;)</span>
<span class="sd">        Either &#39;quadrature&#39; or &#39;montecarlo&#39;</span>
<span class="sd">    Nsamples: integer, optional (default: 1e4)</span>
<span class="sd">        Number of Monte Carlo samples.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    func_av: float</span>
<span class="sd">        Precession average of func.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``func_av = precession.precession_average(kappa,r,chieff,q,chi1,chi2,func,*args,method=&#39;quadrature&#39;,Nsamples=1e4)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">kappa</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">kappa</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">r</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chieff</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chieff</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">q</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">u</span> <span class="o">=</span> <span class="n">eval_u</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span><span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">)</span>
    <span class="n">deltachiminus</span><span class="p">,</span><span class="n">deltachiplus</span><span class="p">,</span><span class="n">deltachi3</span> <span class="o">=</span> <span class="n">deltachiroots</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;quadrature&#39;</span><span class="p">:</span>

        <span class="n">tau</span> <span class="o">=</span> <span class="n">eval_tau</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">deltachiminus</span><span class="p">,</span><span class="n">deltachiplus</span><span class="p">,</span><span class="n">deltachi3</span><span class="p">]),</span> <span class="n">donotnormalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Each args needs to be iterable</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>

        <span class="c1"># Compute the numerator explicitely</span>
        <span class="k">def</span> <span class="nf">_integrand</span><span class="p">(</span><span class="n">deltachi</span><span class="p">,</span> <span class="n">deltachiminus</span><span class="p">,</span><span class="n">deltachiplus</span><span class="p">,</span><span class="n">deltachi3</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
            <span class="n">dchidt2</span> <span class="o">=</span> <span class="n">dchidt2_RHS</span><span class="p">(</span><span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">deltachiminus</span><span class="p">,</span><span class="n">deltachiplus</span><span class="p">,</span><span class="n">deltachi3</span><span class="p">]),</span><span class="n">donotnormalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">deltachi</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">/</span> <span class="n">dchidt2</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="n">deltachiminus</span><span class="p">,</span><span class="n">deltachiplus</span><span class="p">,</span><span class="n">deltachi3</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="n">_integrand</span><span class="p">,</span> <span class="n">deltachiminus</span><span class="p">,</span> <span class="n">deltachiplus</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">deltachiminus</span><span class="p">,</span><span class="n">deltachiplus</span><span class="p">,</span><span class="n">deltachi3</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">func_av</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">_compute</span><span class="p">,</span> <span class="n">deltachiminus</span><span class="p">,</span><span class="n">deltachiplus</span><span class="p">,</span><span class="n">deltachi3</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)))</span> <span class="o">/</span> <span class="n">tau</span> <span class="o">*</span> <span class="mi">2</span> 

    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;montecarlo&#39;</span><span class="p">:</span>

        <span class="n">deltachi</span> <span class="o">=</span> <span class="n">deltachisampling</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">Nsamples</span><span class="p">),</span> <span class="n">precomputedroots</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">deltachiminus</span><span class="p">,</span><span class="n">deltachiplus</span><span class="p">,</span><span class="n">deltachi3</span><span class="p">]))</span>
        <span class="n">evals</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">deltachi</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="n">func_av</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">evals</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">Nsamples</span>
        <span class="n">func_av</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">func_av</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Available methods are &#39;quadrature&#39; and &#39;montecarlo&#39;.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">func_av</span></div>


<span class="c1">################ Orbit-averaged evolution ################</span>

<div class="viewcode-block" id="rhs_orbav"><a class="viewcode-back" href="../auto.html#precession.rhs_orbav">[docs]</a><span class="k">def</span> <span class="nf">rhs_orbav</span><span class="p">(</span><span class="n">allvars</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">S1</span><span class="p">,</span> <span class="n">S2</span><span class="p">,</span> <span class="n">PNorderpre</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.5</span><span class="p">],</span> <span class="n">PNorderrad</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">1.5</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mf">2.5</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mf">3.5</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Right-hand side of the systems of ODEs describing orbit-averaged inspiral. The equations are reported in Sec 4A of Gerosa and Kesden, arXiv:1605.01067. The format is d[allvars]/dv=RHS where allvars=[Lhx,Lhy,Lhz,S1hx,S1hy,S1hz,S2hx,S2hy,S2hz,t], h indicates unit vectors, v is the orbital velocity, and t is time.</span>
<span class="sd">    This is an internal function used by the ODE integrator and is not array-compatible.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    allvars: array</span>
<span class="sd">        Packed ODE input variables.</span>
<span class="sd">    v: float</span>
<span class="sd">        Newtonian orbital velocity.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    m1: float</span>
<span class="sd">        Mass of the primary (heavier) black hole.</span>
<span class="sd">    m2: float</span>
<span class="sd">        Mass of the secondary (lighter) black hole.</span>
<span class="sd">    eta: float</span>
<span class="sd">        Symmetric mass ratio 0&lt;=eta&lt;=1/4.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    S1: float</span>
<span class="sd">        Magnitude of the primary spin.</span>
<span class="sd">    S2: float</span>
<span class="sd">        Magnitude of the secondary spin.</span>
<span class="sd">    PNorderpre: array (default: [0,0.5])</span>
<span class="sd">        PN orders considered in the spin-precession equations.</span>
<span class="sd">    PNorderrad: array (default: [0,0.5])</span>
<span class="sd">        PN orders considered in the radiation-reaction equation.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    RHS: float</span>
<span class="sd">        Right-hand side.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``RHS = precession.rhs_orbav(allvars,v,q,m1,m2,eta,chi1,chi2,S1,S2,PNorderpre=[0,0.5],PNorderrad=[0,1,1.5,2,2.5,3,3.5])``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Unpack inputs</span>
    <span class="n">Lh</span> <span class="o">=</span> <span class="n">allvars</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">S1h</span> <span class="o">=</span> <span class="n">allvars</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
    <span class="n">S2h</span> <span class="o">=</span> <span class="n">allvars</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">allvars</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>

    <span class="c1"># Angles</span>
    <span class="n">ct1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">S1h</span><span class="p">,</span> <span class="n">Lh</span><span class="p">)</span>
    <span class="n">ct2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">S2h</span><span class="p">,</span> <span class="n">Lh</span><span class="p">)</span>
    <span class="n">ct12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">S1h</span><span class="p">,</span> <span class="n">S2h</span><span class="p">)</span>

    <span class="c1"># Spin precession for S1</span>
    <span class="n">Omega1</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="ow">in</span> <span class="n">PNorderpre</span><span class="p">)</span> <span class="o">*</span> <span class="n">eta</span><span class="o">*</span><span class="n">v</span><span class="o">**</span><span class="mi">5</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">q</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">Lh</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.5</span> <span class="ow">in</span> <span class="n">PNorderpre</span><span class="p">)</span> <span class="o">*</span> <span class="n">v</span><span class="o">**</span><span class="mi">6</span><span class="o">*</span><span class="p">(</span><span class="n">S2</span><span class="o">*</span><span class="n">S2h</span><span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="n">S2</span><span class="o">*</span><span class="n">ct2</span><span class="o">*</span><span class="n">Lh</span><span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="n">q</span><span class="o">*</span><span class="n">S1</span><span class="o">*</span><span class="n">ct1</span><span class="o">*</span><span class="n">Lh</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">dS1hdt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">Omega1</span><span class="p">,</span> <span class="n">S1h</span><span class="p">)</span>

    <span class="c1"># Spin precession for S2</span>
    <span class="n">Omega2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="ow">in</span> <span class="n">PNorderpre</span><span class="p">)</span> <span class="o">*</span> <span class="n">eta</span><span class="o">*</span><span class="n">v</span><span class="o">**</span><span class="mi">5</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">+</span><span class="mi">3</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="p">))</span><span class="o">*</span><span class="n">Lh</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.5</span> <span class="ow">in</span> <span class="n">PNorderpre</span><span class="p">)</span> <span class="o">*</span> <span class="n">v</span><span class="o">**</span><span class="mi">6</span><span class="o">*</span><span class="p">(</span><span class="n">S1</span><span class="o">*</span><span class="n">S1h</span><span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="n">S1</span><span class="o">*</span><span class="n">ct1</span><span class="o">*</span><span class="n">Lh</span><span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="n">S2</span><span class="o">*</span><span class="n">ct2</span><span class="o">*</span><span class="n">Lh</span><span class="o">/</span><span class="n">q</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">dS2hdt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">Omega2</span><span class="p">,</span> <span class="n">S2h</span><span class="p">)</span>

    <span class="c1"># Conservation of angular momentum</span>
    <span class="n">dLhdt</span> <span class="o">=</span> <span class="o">-</span><span class="n">v</span><span class="o">*</span><span class="p">(</span><span class="n">S1</span><span class="o">*</span><span class="n">dS1hdt</span><span class="o">+</span><span class="n">S2</span><span class="o">*</span><span class="n">dS2hdt</span><span class="p">)</span><span class="o">/</span><span class="n">eta</span>

    <span class="n">dvdt</span> <span class="o">=</span> <span class="p">(</span><span class="mi">32</span><span class="o">*</span><span class="n">eta</span><span class="o">*</span><span class="n">v</span><span class="o">**</span><span class="mi">9</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
        <span class="o">+</span> <span class="p">(</span><span class="mi">0</span> <span class="ow">in</span> <span class="n">PNorderrad</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span>
        <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="ow">in</span> <span class="n">PNorderrad</span><span class="p">)</span><span class="o">*</span><span class="n">v</span><span class="o">**</span><span class="mi">2</span> 
                 <span class="o">*</span> <span class="p">(</span><span class="mi">743</span><span class="o">+</span><span class="mi">924</span><span class="o">*</span><span class="n">eta</span><span class="p">)</span><span class="o">/</span><span class="mi">336</span>
        <span class="o">+</span> <span class="p">(</span><span class="mf">1.5</span> <span class="ow">in</span> <span class="n">PNorderrad</span><span class="p">)</span> <span class="o">*</span> <span class="n">v</span><span class="o">**</span><span class="mi">3</span> 
                 <span class="o">*</span> <span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
                 <span class="o">-</span> <span class="n">chi1</span><span class="o">*</span><span class="n">ct1</span><span class="o">*</span><span class="p">(</span><span class="mi">113</span><span class="o">*</span><span class="n">m1</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">12</span> <span class="o">+</span> <span class="mi">25</span><span class="o">*</span><span class="n">eta</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span>
                 <span class="o">-</span> <span class="n">chi2</span><span class="o">*</span><span class="n">ct2</span><span class="o">*</span><span class="p">(</span><span class="mi">113</span><span class="o">*</span><span class="n">m2</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">12</span> <span class="o">+</span> <span class="mi">25</span><span class="o">*</span><span class="n">eta</span><span class="o">/</span><span class="mi">4</span><span class="p">))</span>
        <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="ow">in</span> <span class="n">PNorderrad</span><span class="p">)</span> <span class="o">*</span> <span class="n">v</span><span class="o">**</span><span class="mi">4</span> 
                 <span class="o">*</span> <span class="p">(</span><span class="mi">34103</span><span class="o">/</span><span class="mi">18144</span> <span class="o">+</span> <span class="mi">13661</span><span class="o">*</span><span class="n">eta</span><span class="o">/</span><span class="mi">2016</span> <span class="o">+</span> <span class="mi">59</span><span class="o">*</span><span class="n">eta</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">18</span>
                 <span class="o">+</span> <span class="n">eta</span><span class="o">*</span><span class="n">chi1</span><span class="o">*</span><span class="n">chi2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">721</span><span class="o">*</span><span class="n">ct1</span><span class="o">*</span><span class="n">ct2</span> <span class="o">-</span> <span class="mi">247</span><span class="o">*</span><span class="n">ct12</span><span class="p">)</span><span class="o">/</span><span class="mi">48</span>
                 <span class="o">+</span> <span class="p">((</span><span class="n">m1</span><span class="o">*</span><span class="n">chi1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">719</span><span class="o">*</span><span class="n">ct1</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">233</span><span class="p">))</span><span class="o">/</span><span class="mi">96</span>
                 <span class="o">+</span> <span class="p">((</span><span class="n">m2</span><span class="o">*</span><span class="n">chi2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">719</span><span class="o">*</span><span class="n">ct2</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">233</span><span class="p">))</span><span class="o">/</span><span class="mi">96</span><span class="p">)</span>
        <span class="o">-</span> <span class="p">(</span><span class="mf">2.5</span> <span class="ow">in</span> <span class="n">PNorderrad</span><span class="p">)</span> <span class="o">*</span> <span class="n">v</span><span class="o">**</span><span class="mi">5</span> 
                 <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="mi">4159</span><span class="o">+</span><span class="mi">15876</span><span class="o">*</span><span class="n">eta</span><span class="p">)</span><span class="o">/</span><span class="mi">672</span>
        <span class="o">+</span> <span class="p">(</span><span class="mi">3</span> <span class="ow">in</span> <span class="n">PNorderrad</span><span class="p">)</span><span class="o">*</span><span class="n">v</span><span class="o">**</span><span class="mi">6</span> 
                 <span class="o">*</span> <span class="p">(</span><span class="mi">16447322263</span><span class="o">/</span><span class="mi">139708800</span> <span class="o">+</span> <span class="mi">16</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">3</span>
                 <span class="o">-</span> <span class="mi">1712</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5772156649</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">v</span><span class="p">))</span><span class="o">/</span><span class="mi">105</span>
                 <span class="o">+</span> <span class="p">(</span><span class="mi">451</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">48</span> <span class="o">-</span> <span class="mi">56198689</span><span class="o">/</span><span class="mi">217728</span><span class="p">)</span><span class="o">*</span><span class="n">eta</span>
                 <span class="o">+</span> <span class="mi">541</span><span class="o">*</span><span class="n">eta</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">896</span> <span class="o">-</span> <span class="mi">5605</span><span class="o">*</span><span class="n">eta</span><span class="o">**</span><span class="mi">3</span><span class="o">/</span><span class="mi">2592</span><span class="p">)</span>
        <span class="o">+</span> <span class="p">(</span><span class="mf">3.5</span> <span class="ow">in</span> <span class="n">PNorderrad</span><span class="p">)</span> <span class="o">*</span> <span class="n">v</span><span class="o">**</span><span class="mi">7</span> 
                 <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mi">4415</span><span class="o">/</span><span class="mi">4032</span> <span class="o">+</span> <span class="mi">358675</span><span class="o">*</span><span class="n">eta</span><span class="o">/</span><span class="mi">6048</span>
                 <span class="o">+</span> <span class="mi">91495</span><span class="o">*</span><span class="n">eta</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">1512</span><span class="p">))</span>

    <span class="c1"># Integrate in v, not in time</span>
    <span class="n">dtdv</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">dvdt</span>
    <span class="n">dLhdv</span> <span class="o">=</span> <span class="n">dLhdt</span><span class="o">*</span><span class="n">dtdv</span>
    <span class="n">dS1hdv</span> <span class="o">=</span> <span class="n">dS1hdt</span><span class="o">*</span><span class="n">dtdv</span>
    <span class="n">dS2hdv</span> <span class="o">=</span> <span class="n">dS2hdt</span><span class="o">*</span><span class="n">dtdv</span>

    <span class="c1"># Pack outputs</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">dLhdv</span><span class="p">,</span> <span class="n">dS1hdv</span><span class="p">,</span> <span class="n">dS2hdv</span><span class="p">,</span> <span class="p">[</span><span class="n">dtdv</span><span class="p">]])</span></div>


<div class="viewcode-block" id="integrator_orbav"><a class="viewcode-back" href="../auto.html#precession.integrator_orbav">[docs]</a><span class="k">def</span> <span class="nf">integrator_orbav</span><span class="p">(</span><span class="n">Lhinitial</span><span class="p">,</span> <span class="n">S1hinitial</span><span class="p">,</span> <span class="n">S2hinitial</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">PNorderpre</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.5</span><span class="p">],</span> <span class="n">PNorderrad</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">1.5</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mf">2.5</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mf">3.5</span><span class="p">],</span> <span class="o">**</span><span class="n">odeint_kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Integration of the systems of ODEs describing orbit-averaged inspirals.</span>
<span class="sd">    Additional keywords arguments are passed to `scipy.integrate.odeint` after some custom-made default settings.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Lhinitial: array</span>
<span class="sd">        Initial direction of the orbital angular momentum, unit vector.</span>
<span class="sd">    S1hinitial: array</span>
<span class="sd">        Initial direction of the primary spin, unit vector.</span>
<span class="sd">    S2hinitial: array</span>
<span class="sd">        Initial direction of the secondary spin, unit vector.</span>
<span class="sd">    v: float</span>
<span class="sd">        Newtonian orbital velocity.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    PNorderpre: array (default: [0,0.5])</span>
<span class="sd">        PN orders considered in the spin-precession equations.</span>
<span class="sd">    PNorderrad: array (default: [0,0.5])</span>
<span class="sd">        PN orders considered in the radiation-reaction equation.</span>
<span class="sd">    **odeint_kwargs: unpacked dictionary, optional</span>
<span class="sd">        Additional keyword arguments.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ODEsolution: array</span>
<span class="sd">        Solution of the ODE.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``ODEsolution = precession.integrator_orbavintegrator_orbav(Lhinitial,S1hinitial,S2hinitial,v,q,chi1,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">Lhinitial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">Lhinitial</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">S1hinitial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">S1hinitial</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">S2hinitial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">S2hinitial</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="c1"># Defaults for the integrators, can be changed by the user</span>
    <span class="k">if</span> <span class="s1">&#39;mxstep&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">odeint_kwargs</span><span class="p">:</span> <span class="n">odeint_kwargs</span><span class="p">[</span><span class="s1">&#39;mxstep&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">5000000</span>
    <span class="k">if</span> <span class="s1">&#39;rol&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">odeint_kwargs</span><span class="p">:</span> <span class="n">odeint_kwargs</span><span class="p">[</span><span class="s1">&#39;rtol&#39;</span><span class="p">]</span><span class="o">=</span><span class="mf">1e-10</span>
    <span class="k">if</span> <span class="s1">&#39;aol&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">odeint_kwargs</span><span class="p">:</span> <span class="n">odeint_kwargs</span><span class="p">[</span><span class="s1">&#39;atol&#39;</span><span class="p">]</span><span class="o">=</span><span class="mf">1e-10</span>
    <span class="n">odeint_kwargs</span><span class="p">[</span><span class="s1">&#39;full_output&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span> <span class="c1"># This needs to be forced for compatibility with the rest of the code</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="n">Lhinitial</span><span class="p">,</span> <span class="n">S1hinitial</span><span class="p">,</span> <span class="n">S2hinitial</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">):</span>

        <span class="c1"># I need unit vectors</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">Lhinitial</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">S1hinitial</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">S2hinitial</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Pack inputs</span>
        <span class="n">ic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">Lhinitial</span><span class="p">,</span> <span class="n">S1hinitial</span><span class="p">,</span> <span class="n">S2hinitial</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

        <span class="c1"># Compute these quantities here instead of inside the RHS for speed</span>
        <span class="n">m1</span> <span class="o">=</span> <span class="n">eval_m1</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">m2</span> <span class="o">=</span> <span class="n">eval_m2</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">S1</span> <span class="o">=</span> <span class="n">eval_S1</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">S2</span> <span class="o">=</span> <span class="n">eval_S2</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">eta</span> <span class="o">=</span> <span class="n">eval_eta</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

        <span class="c1"># solve_ivp implementation. Didn&#39;t really work.</span>
        <span class="c1">#ODEsolution = scipy.integrate.solve_ivp(rhs_orbav, (vinitial, vfinal), ic, method=&#39;LSODA&#39;, t_eval=(vinitial, vfinal), dense_output=True, args=(q, m1, m2, eta, chi1, chi2, S1, S2, quadrupole_formula),rtol=1e-12,atol=1e-12)</span>
        <span class="c1">#ODEsolution = scipy.integrate.solve_ivp(rhs_orbav, (vinitial, vfinal), ic, t_eval=(vinitial, vfinal), dense_output=True, args=(q, m1, m2, eta, chi1, chi2, S1, S2, quadrupole_formula))</span>

        <span class="c1"># Make sure the first step is large enough. This is to avoid LSODA to propose a tiny step which causes the integration to stall</span>
        <span class="k">if</span> <span class="s1">&#39;h0&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">odeint_kwargs</span><span class="p">:</span> <span class="n">odeint_kwargs</span><span class="p">[</span><span class="s1">&#39;h0&#39;</span><span class="p">]</span><span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span>  <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">1e6</span>

        <span class="n">ODEsolution</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">odeint</span><span class="p">(</span><span class="n">rhs_orbav</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">S1</span><span class="p">,</span> <span class="n">S2</span><span class="p">,</span> <span class="n">PNorderpre</span><span class="p">,</span> <span class="n">PNorderrad</span><span class="p">),</span> <span class="o">**</span><span class="n">odeint_kwargs</span><span class="p">)</span><span class="c1">#, printmessg=0,rtol=1e-10,atol=1e-10)#,tcrit=sing)</span>
        <span class="k">return</span> <span class="n">ODEsolution</span>

    <span class="n">ODEsolution</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">_compute</span><span class="p">,</span> <span class="n">Lhinitial</span><span class="p">,</span> <span class="n">S1hinitial</span><span class="p">,</span> <span class="n">S2hinitial</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">ODEsolution</span></div>


<div class="viewcode-block" id="inspiral_orbav"><a class="viewcode-back" href="../auto.html#precession.inspiral_orbav">[docs]</a><span class="k">def</span> <span class="nf">inspiral_orbav</span><span class="p">(</span><span class="n">theta1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">theta2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deltaphi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Lh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">S1h</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">S2h</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deltachi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chieff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chi1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chi2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cyclesign</span><span class="o">=+</span><span class="mi">1</span><span class="p">,</span> <span class="n">PNorderpre</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.5</span><span class="p">],</span> <span class="n">PNorderrad</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">1.5</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mf">2.5</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mf">3.5</span><span class="p">],</span> <span class="n">requested_outputs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">odeint_kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform precession-averaged inspirals. The variables q, chi1, and chi2 must always be provided.</span>
<span class="sd">    The integration range must be specified using either r or u (and not both). These need to be arrays with lenght &gt;=1, where e.g. r[0] corresponds to the initial condition and r[1:] corresponds to the location where outputs are returned.</span>
<span class="sd">    The function is vectorized: evolving N multiple binaries with M outputs requires kappainitial, chieff, q, chi1, chi2 to be of shape (N,) and u of shape (M,N).</span>
<span class="sd">    The initial conditions must be specified in terms of one an only one of the following:</span>
<span class="sd">        - Lh, S1h, and S2h</span>
<span class="sd">        - theta1,theta2, and deltaphi.</span>
<span class="sd">        - deltachi, kappa, chieff, cyclesign.</span>
<span class="sd">    The desired outputs can be specified with a list e.g. requested_outputs=[&#39;theta1&#39;,&#39;theta2&#39;,&#39;deltaphi&#39;]. All the available variables are returned by default. These are: [&#39;theta1&#39;, &#39;theta2&#39;, &#39;deltaphi&#39;, &#39;deltachi&#39;, &#39;kappa&#39;, &#39;r&#39;, &#39;u&#39;, &#39;deltachiminus&#39;, &#39;deltachiplus&#39;, &#39;deltachi3&#39;, &#39;chieff&#39;, &#39;q&#39;, &#39;chi1&#39;, &#39;chi2&#39;].</span>
<span class="sd">    The flag enforce allows checking the consistency of the input variables.</span>
<span class="sd">    Additional keywords arguments are passed to `scipy.integrate.odeint` after some custom-made default settings.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    theta1: float, optional (default: None)</span>
<span class="sd">        Angle between orbital angular momentum and primary spin.</span>
<span class="sd">    theta2: float, optional (default: None)</span>
<span class="sd">        Angle between orbital angular momentum and secondary spin.</span>
<span class="sd">    deltaphi: float, optional (default: None)</span>
<span class="sd">        Angle between the projections of the two spins onto the orbital plane.</span>
<span class="sd">    Lh: array, optional (default: None)</span>
<span class="sd">        Direction of the orbital angular momentum, unit vector.</span>
<span class="sd">    S1h: array, optional (default: None)</span>
<span class="sd">        Direction of the primary spin, unit vector.</span>
<span class="sd">    S2h: array, optional (default: None)</span>
<span class="sd">        Direction of the secondary spin, unit vector.</span>
<span class="sd">    deltachi: float, optional (default: None)</span>
<span class="sd">        Weighted spin difference.</span>
<span class="sd">    kappa: float, optional (default: None)</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    r: float, optional (default: None)</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    u: float, optional (default: None)</span>
<span class="sd">        Compactified separation 1/(2L).</span>
<span class="sd">    chieff: float, optional (default: None)</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float, optional (default: None)</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float, optional (default: None)</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float, optional (default: None)</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    cyclesign: integer, optional (default: +1)</span>
<span class="sd">        Sign (either +1 or -1) to cover the two halves of a precesion cycle.</span>
<span class="sd">    PNorderpre: array (default: [0,0.5])</span>
<span class="sd">        PN orders considered in the spin-precession equations.</span>
<span class="sd">    PNorderrad: array (default: [0,0.5])</span>
<span class="sd">        PN orders considered in the radiation-reaction equation.</span>
<span class="sd">    requested_outputs: list, optional (default: None)</span>
<span class="sd">        Set of outputs.</span>
<span class="sd">    **odeint_kwargs: unpacked dictionary, optional</span>
<span class="sd">        Additional keyword arguments.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    outputs: dictionary</span>
<span class="sd">        Set of outputs.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``outputs = precession.inspiral_orbav(Lh=Lh,S1h=S1h,S2h=S2h,r=r,q=q,chi1=chi1,chi2=chi2)``</span>
<span class="sd">    ``outputs = precession.inspiral_orbav(Lh=Lh,S1h=S1h,S2h=S2h,u=u,q=q,chi1=chi1,chi2=chi2)``</span>
<span class="sd">    ``outputs = precession.inspiral_orbav(theta1=theta1,theta2=theta2,deltaphi=deltaphi,r=r,q=q,chi1=chi1,chi2=chi2)``</span>
<span class="sd">    ``outputs = precession.inspiral_orbav(theta1=theta1,theta2=theta2,deltaphi=deltaphi,u=u,q=q,chi1=chi1,chi2=chi2)``</span>
<span class="sd">    ``outputs = precession.inspiral_orbav(deltachi=deltachi,kappa=kappa,r=r,chieff=chieff,q=q,chi1=chi1,chi2=chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="c1"># Substitute None inputs with arrays of Nones</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span><span class="p">,</span> <span class="n">Lh</span><span class="p">,</span> <span class="n">S1h</span><span class="p">,</span> <span class="n">S2h</span><span class="p">,</span> <span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inputs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">inputs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tiler</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">))))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">8</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>  <span class="c1"># Lh, S1h, S2h, u, or r</span>
                <span class="n">inputs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Any of the others</span>
                <span class="n">inputs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
    <span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span><span class="p">,</span> <span class="n">Lh</span><span class="p">,</span> <span class="n">S1h</span><span class="p">,</span> <span class="n">S2h</span><span class="p">,</span> <span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span> <span class="o">=</span> <span class="n">inputs</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span><span class="p">,</span> <span class="n">Lh</span><span class="p">,</span> <span class="n">S1h</span><span class="p">,</span> <span class="n">S2h</span><span class="p">,</span> <span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span><span class="n">cyclesign</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">q</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">chi1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">chi2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Please provide q, chi1, and chi2.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">u</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">ismonotonic</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">),</span> <span class="n">ismonotonic</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">)),</span> <span class="s1">&#39;r must be monotonic&#39;</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">eval_u</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">tiler</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">r</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">u</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">ismonotonic</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">),</span> <span class="n">ismonotonic</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">)),</span> <span class="s1">&#39;u must be monotonic&#39;</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">eval_r</span><span class="p">(</span><span class="n">u</span><span class="o">=</span><span class="n">u</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="n">tiler</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">u</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Please provide either r or u.&quot;</span><span class="p">)</span>

        <span class="c1"># User provides Lh, S1h, and S2h</span>
        <span class="k">if</span> <span class="n">Lh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">S1h</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">S2h</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">theta1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">theta2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">deltaphi</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">deltachi</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">kappa</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chieff</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># User provides theta1, theta2, and deltaphi.</span>
        <span class="k">elif</span> <span class="n">Lh</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">S1h</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">S2h</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">theta1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">theta2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">deltaphi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">deltachi</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">kappa</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chieff</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Lh</span><span class="p">,</span> <span class="n">S1h</span><span class="p">,</span> <span class="n">S2h</span> <span class="o">=</span> <span class="n">angles_to_Jframe</span><span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>


        <span class="c1"># User provides deltachi, kappa, and chieff.</span>
        <span class="k">elif</span> <span class="n">Lh</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">S1h</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">S2h</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">theta1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">theta2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">deltaphi</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">deltachi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">kappa</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chieff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># cyclesign=+1 by default</span>
            <span class="n">Lh</span><span class="p">,</span> <span class="n">S1h</span><span class="p">,</span> <span class="n">S2h</span> <span class="o">=</span> <span class="n">conserved_to_Jframe</span><span class="p">(</span><span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">cyclesign</span><span class="o">=</span><span class="n">cyclesign</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Please provide one and not more of the following: (Lh,S1h,S2h), (theta1,theta2,deltaphi), (deltachi,kappa,chieff).&quot;</span><span class="p">)</span>

        <span class="c1"># Make sure vectors are normalized</span>
        <span class="n">Lh</span> <span class="o">=</span> <span class="n">Lh</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">Lh</span><span class="p">)</span>
        <span class="n">S1h</span> <span class="o">=</span> <span class="n">S1h</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">S1h</span><span class="p">)</span>
        <span class="n">S2h</span> <span class="o">=</span> <span class="n">S2h</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">S2h</span><span class="p">)</span>

        <span class="n">v</span> <span class="o">=</span> <span class="n">eval_v</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

        <span class="c1"># Integration</span>
        <span class="n">evaluations</span> <span class="o">=</span> <span class="n">integrator_orbav</span><span class="p">(</span><span class="n">Lh</span><span class="p">,</span> <span class="n">S1h</span><span class="p">,</span> <span class="n">S2h</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">PNorderpre</span><span class="o">=</span><span class="n">PNorderpre</span><span class="p">,</span> <span class="n">PNorderrad</span><span class="o">=</span><span class="n">PNorderrad</span><span class="p">,</span><span class="o">**</span><span class="n">odeint_kwargs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        <span class="c1"># For solve_ivp implementation</span>
        <span class="c1">#evaluations = np.squeeze(ODEsolution.item().sol(v))</span>

        <span class="c1"># Returned output is</span>
        <span class="c1"># Lx, Ly, Lz, S1x, S1y, S1z, S2x, S2y, S2z, (t)</span>
        <span class="n">Lh</span> <span class="o">=</span> <span class="n">evaluations</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span>
        <span class="n">S1h</span> <span class="o">=</span> <span class="n">evaluations</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span>
        <span class="n">S2h</span> <span class="o">=</span> <span class="n">evaluations</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">evaluations</span><span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="p">:]</span>

        <span class="c1"># Renormalize. The normalization is not enforced by the integrator, it is only maintaied within numerical accuracy.</span>
        <span class="c1">#Lh = Lh/np.linalg.norm(Lh)</span>
        <span class="c1">#S1h = S1h/np.linalg.norm(S1h)</span>
        <span class="c1">#S2h = S2h/np.linalg.norm(S2h)</span>

        <span class="n">S1</span> <span class="o">=</span> <span class="n">eval_S1</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">)</span>
        <span class="n">S2</span> <span class="o">=</span> <span class="n">eval_S2</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">eval_L</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">tiler</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
        <span class="n">Lvec</span> <span class="o">=</span> <span class="p">(</span><span class="n">L</span><span class="o">*</span><span class="n">Lh</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">S1vec</span> <span class="o">=</span> <span class="n">S1</span><span class="o">*</span><span class="n">S1h</span>
        <span class="n">S2vec</span> <span class="o">=</span> <span class="n">S2</span><span class="o">*</span><span class="n">S2h</span>
        <span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span> <span class="o">=</span> <span class="n">vectors_to_angles</span><span class="p">(</span><span class="n">Lvec</span><span class="p">,</span> <span class="n">S1vec</span><span class="p">,</span> <span class="n">S2vec</span><span class="p">)</span>
        <span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">cyclesign</span> <span class="o">=</span> <span class="n">vectors_to_conserved</span><span class="p">(</span><span class="n">Lvec</span><span class="p">,</span> <span class="n">S1vec</span><span class="p">,</span> <span class="n">S2vec</span><span class="p">,</span> <span class="n">tiler</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">r</span><span class="p">),</span> <span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span><span class="p">,</span> <span class="n">Lh</span><span class="p">,</span> <span class="n">S1h</span><span class="p">,</span> <span class="n">S2h</span><span class="p">,</span> <span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">cyclesign</span>

    <span class="c1"># This array has to match the outputs of _compute (in the right order!)</span>
    <span class="n">alloutputs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;theta1&#39;</span><span class="p">,</span> <span class="s1">&#39;theta2&#39;</span><span class="p">,</span> <span class="s1">&#39;deltaphi&#39;</span><span class="p">,</span> <span class="s1">&#39;Lh&#39;</span><span class="p">,</span> <span class="s1">&#39;S1h&#39;</span><span class="p">,</span> <span class="s1">&#39;S2h&#39;</span><span class="p">,</span> <span class="s1">&#39;deltachi&#39;</span><span class="p">,</span> <span class="s1">&#39;kappa&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;chieff&#39;</span><span class="p">,</span> <span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;chi1&#39;</span><span class="p">,</span> <span class="s1">&#39;chi2&#39;</span><span class="p">,</span> <span class="s1">&#39;cyclesign&#39;</span><span class="p">])</span>


    <span class="k">if</span> <span class="n">cyclesign</span> <span class="o">==+</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">cyclesign</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">cyclesign</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">tiler</span><span class="p">(</span><span class="n">cyclesign</span><span class="p">,</span><span class="n">q</span><span class="p">))</span>
    
    <span class="c1"># Here I force dtype=object because the outputs have different shapes</span>
    <span class="n">allresults</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">_compute</span><span class="p">,</span> <span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span><span class="p">,</span> <span class="n">Lh</span><span class="p">,</span> <span class="n">S1h</span><span class="p">,</span> <span class="n">S2h</span><span class="p">,</span> <span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">cyclesign</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># Handle the outputs.</span>
    <span class="c1"># Return all</span>
    <span class="k">if</span> <span class="n">requested_outputs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">requested_outputs</span> <span class="o">=</span> <span class="n">alloutputs</span>
    <span class="c1"># Return only those requested (in1d return boolean array)</span>
    <span class="n">wantoutputs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">alloutputs</span><span class="p">,</span> <span class="n">requested_outputs</span><span class="p">)</span>

    <span class="c1"># Store into a dictionary</span>
    <span class="n">outcome</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">alloutputs</span><span class="p">[</span><span class="n">wantoutputs</span><span class="p">],</span> <span class="n">allresults</span><span class="p">[</span><span class="n">wantoutputs</span><span class="p">]):</span>
        <span class="n">outcome</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;q&#39;</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;chi1&#39;</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;chi2&#39;</span><span class="p">:</span>  <span class="c1"># Constants of motion (chieff is not enforced!)</span>
            <span class="n">outcome</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">outcome</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outcome</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">outcome</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">outcome</span></div>


<div class="viewcode-block" id="inspiral_hybrid"><a class="viewcode-back" href="../auto.html#precession.inspiral_hybrid">[docs]</a><span class="k">def</span> <span class="nf">inspiral_hybrid</span><span class="p">(</span><span class="n">theta1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">theta2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deltaphi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deltachi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rswitch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">uswitch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chieff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chi1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chi2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">requested_outputs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="o">**</span><span class="n">odeint_kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform hybrid inspirals, i.e. evolve the binary at large separation with a pression-averaged evolution and at small separation with an orbit-averaged evolution, matching the two. The variables q, chi1, and chi2 must always be provided. The integration range must be specified using either r or u (and not both); provide also uswitch and rswitch consistently.</span>
<span class="sd">    Either r of u needs to be arrays with lenght &gt;=1, where e.g. r[0] corresponds to the initial condition and r[1:] corresponds to the location where outputs are returned. For past time infinity use either u=0 or r=np.inf.</span>
<span class="sd">    The function is vectorized: evolving N multiple binaries with M outputs requires kappainitial, chieff, q, chi1, chi2 to be of shape (N,) and u of shape (M,N).</span>
<span class="sd">    The initial conditions must be specified in terms of one an only one of the following:</span>
<span class="sd">        - theta1,theta2, and deltaphi (but note that deltaphi is not necessary if integrating from infinite separation).</span>
<span class="sd">        - kappa, chieff.</span>
<span class="sd">    The desired outputs can be specified with a list e.g. requested_outputs=[&#39;theta1&#39;,&#39;theta2&#39;,&#39;deltaphi&#39;]. All the available variables are returned by default. These are: [&#39;theta1&#39;, &#39;theta2&#39;, &#39;deltaphi&#39;, &#39;deltachi&#39;, &#39;kappa&#39;, &#39;r&#39;, &#39;u&#39;, &#39;deltachiminus&#39;, &#39;deltachiplus&#39;, &#39;deltachi3&#39;, &#39;chieff&#39;, &#39;q&#39;, &#39;chi1&#39;, &#39;chi2&#39;].</span>
<span class="sd">    The flag enforce allows checking the consistency of the input variables.</span>
<span class="sd">    Additional keywords arguments are passed to `scipy.integrate.odeint` after some custom-made default settings.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    theta1: float, optional (default: None)</span>
<span class="sd">        Angle between orbital angular momentum and primary spin.</span>
<span class="sd">    theta2: float, optional (default: None)</span>
<span class="sd">        Angle between orbital angular momentum and secondary spin.</span>
<span class="sd">    deltaphi: float, optional (default: None)</span>
<span class="sd">        Angle between the projections of the two spins onto the orbital plane.</span>
<span class="sd">    deltachi: float, optional (default: None)</span>
<span class="sd">        Weighted spin difference.</span>
<span class="sd">    kappa: float, optional (default: None)</span>
<span class="sd">        Asymptotic angular momentum.</span>
<span class="sd">    r: float, optional (default: None)</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    rswitch: float, optional (default: None)</span>
<span class="sd">        Matching separation between the precession- and orbit-averaged chunks.</span>
<span class="sd">    u: float, optional (default: None)</span>
<span class="sd">        Compactified separation 1/(2L).</span>
<span class="sd">    uswitch: float, optional (default: None)</span>
<span class="sd">        Matching compactified separation between the precession- and orbit-averaged chunks.</span>
<span class="sd">    chieff: float, optional (default: None)</span>
<span class="sd">        Effective spin.</span>
<span class="sd">    q: float, optional (default: None)</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float, optional (default: None)</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float, optional (default: None)</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    requested_outputs: list, optional (default: None)</span>
<span class="sd">        Set of outputs.</span>
<span class="sd">    **odeint_kwargs: unpacked dictionary, optional</span>
<span class="sd">        Additional keyword arguments.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    outputs: dictionary</span>
<span class="sd">        Set of outputs.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``outputs = precession.inspiral_hybrid(theta1=theta1,theta2=theta2,deltaphi=deltaphi,r=r,q=q,chi1=chi1,chi2=chi2)``</span>
<span class="sd">    ``outputs = precession.inspiral_hybrid(theta1=theta1,theta2=theta2,deltaphi=deltaphi,u=u,q=q,chi1=chi1,chi2=chi2)``</span>
<span class="sd">    ``outputs = precession.inspiral_hybrid(kappa,r=r,chieff=chieff,q=q,chi1=chi1,chi2=chi2)``</span>
<span class="sd">    ``outputs = precession.inspiral_hybrid(kappa,u=u,chieff=chieff,q=q,chi1=chi1,chi2=chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Outputs available in both orbit-averaged and precession-averaged evolutions</span>
    <span class="n">alloutputs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;theta1&#39;</span><span class="p">,</span> <span class="s1">&#39;theta2&#39;</span><span class="p">,</span> <span class="s1">&#39;deltaphi&#39;</span><span class="p">,</span> <span class="s1">&#39;deltachi&#39;</span><span class="p">,</span> <span class="s1">&#39;kappa&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;chieff&#39;</span><span class="p">,</span> <span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;chi1&#39;</span><span class="p">,</span> <span class="s1">&#39;chi2&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">requested_outputs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">requested_outputs</span> <span class="o">=</span> <span class="n">alloutputs</span>
        <span class="c1"># Return only those requested (in1d return boolean array)</span>
    <span class="n">wantoutputs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">alloutputs</span><span class="p">,</span> <span class="n">requested_outputs</span><span class="p">)</span>

    <span class="c1"># Substitute None inputs with arrays of Nones</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span><span class="p">,</span> <span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">rswitch</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">uswitch</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inputs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">inputs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tiler</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">))))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>  <span class="c1"># Either u or r</span>
                <span class="n">inputs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Any of the others</span>
                <span class="n">inputs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
    <span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span><span class="p">,</span> <span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">rswitch</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">uswitch</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span> <span class="o">=</span> <span class="n">inputs</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span><span class="p">,</span> <span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">rswitch</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">uswitch</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">rswitch</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">u</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">uswitch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">eval_r</span><span class="p">(</span><span class="n">u</span><span class="o">=</span><span class="n">u</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="n">tiler</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">u</span><span class="p">))</span>
            <span class="n">rswitch</span> <span class="o">=</span> <span class="n">eval_r</span><span class="p">(</span><span class="n">u</span><span class="o">=</span><span class="n">uswitch</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="n">tiler</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">uswitch</span><span class="p">))</span>

        <span class="n">forward</span> <span class="o">=</span> <span class="n">ismonotonic</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s2">&quot;&gt;=&quot;</span><span class="p">)</span>
        <span class="n">backward</span> <span class="o">=</span> <span class="n">ismonotonic</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s2">&quot;&lt;=&quot;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">forward</span><span class="p">,</span> <span class="n">backward</span><span class="p">),</span> <span class="s2">&quot;r must be monotonic&quot;</span>
        <span class="k">assert</span> <span class="n">rswitch</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="ow">and</span> <span class="n">rswitch</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="s2">&quot;The switching condition must to be within the range spanned by r or u.&quot;</span>

        <span class="n">rlarge</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">r</span> <span class="o">&gt;=</span> <span class="n">rswitch</span><span class="p">]</span>
        <span class="n">rsmall</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">r</span> <span class="o">&lt;</span> <span class="n">rswitch</span><span class="p">]</span>

        <span class="c1"># Integrating forward: precession-averaged first, then orbit-averaged</span>
        <span class="k">if</span> <span class="n">forward</span><span class="p">:</span>
            <span class="n">inspiral_first</span> <span class="o">=</span> <span class="n">inspiral_precav</span>
            <span class="n">rfirst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rlarge</span><span class="p">,</span> <span class="n">rswitch</span><span class="p">)</span>
            <span class="n">inspiral_second</span> <span class="o">=</span> <span class="n">inspiral_orbav</span>
            <span class="n">rsecond</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rswitch</span><span class="p">,</span> <span class="n">rsmall</span><span class="p">)</span>

        <span class="c1"># Integrating backward: orbit-averaged first, then precession-averaged</span>
        <span class="k">elif</span> <span class="n">backward</span><span class="p">:</span>
            <span class="n">inspiral_first</span> <span class="o">=</span> <span class="n">inspiral_orbav</span>
            <span class="n">rfirst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rsmall</span><span class="p">,</span> <span class="n">rswitch</span><span class="p">)</span>
            <span class="n">inspiral_second</span> <span class="o">=</span> <span class="n">inspiral_precav</span>
            <span class="n">rsecond</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rswitch</span><span class="p">,</span> <span class="n">rlarge</span><span class="p">)</span>

        <span class="c1"># First chunk of the evolution</span>
        <span class="n">evolution_first</span> <span class="o">=</span> <span class="n">inspiral_first</span><span class="p">(</span><span class="n">theta1</span><span class="o">=</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="o">=</span><span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span><span class="o">=</span><span class="n">deltaphi</span><span class="p">,</span> <span class="n">deltachi</span><span class="o">=</span><span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">rfirst</span><span class="p">,</span> <span class="n">chieff</span><span class="o">=</span><span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="o">=</span><span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="o">=</span><span class="n">chi2</span><span class="p">,</span> <span class="n">requested_outputs</span><span class="o">=</span><span class="n">alloutputs</span><span class="p">,</span><span class="o">**</span><span class="n">odeint_kwargs</span><span class="p">)</span>

        <span class="c1"># Second chunk of the evolution</span>
        <span class="n">evolution_second</span> <span class="o">=</span> <span class="n">inspiral_second</span><span class="p">(</span><span class="n">theta1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">evolution_first</span><span class="p">[</span><span class="s1">&#39;theta1&#39;</span><span class="p">])[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">theta2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">evolution_first</span><span class="p">[</span><span class="s1">&#39;theta2&#39;</span><span class="p">])[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">deltaphi</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">evolution_first</span><span class="p">[</span><span class="s1">&#39;deltaphi&#39;</span><span class="p">])[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="n">rsecond</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="o">=</span><span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="o">=</span><span class="n">chi2</span><span class="p">,</span> <span class="n">requested_outputs</span><span class="o">=</span><span class="n">alloutputs</span><span class="p">,</span><span class="o">**</span><span class="n">odeint_kwargs</span><span class="p">)</span>

        <span class="c1"># Store outputs</span>
        <span class="n">evolution_full</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">wantoutputs</span><span class="p">:</span>
            <span class="c1"># Quantities that vary in both the precession-averaged and the orbit-averaged evolution</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;theta1&#39;</span><span class="p">,</span> <span class="s1">&#39;theta2&#39;</span><span class="p">,</span> <span class="s1">&#39;deltaphi&#39;</span><span class="p">,</span> <span class="s1">&#39;deltachi&#39;</span><span class="p">,</span> <span class="s1">&#39;kappa&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">]:</span>
                <span class="n">evolution_full</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">evolution_first</span><span class="p">[</span><span class="n">k</span><span class="p">][:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">evolution_second</span><span class="p">[</span><span class="n">k</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">:]))</span>
            <span class="c1"># Quantities that vary only on the orbit-averaged evolution</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;chieff&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">forward</span><span class="p">:</span>
                    <span class="n">evolution_full</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tiler</span><span class="p">(</span><span class="n">evolution_first</span><span class="p">[</span><span class="n">k</span><span class="p">][:],</span> <span class="n">rfirst</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">evolution_second</span><span class="p">[</span><span class="n">k</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">:]))</span>
                <span class="k">elif</span> <span class="n">backward</span><span class="p">:</span>
                    <span class="n">evolution_full</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">evolution_first</span><span class="p">[</span><span class="n">k</span><span class="p">][:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">tiler</span><span class="p">(</span><span class="n">evolution_second</span><span class="p">[</span><span class="n">k</span><span class="p">][:],</span> <span class="n">rsecond</span><span class="p">[</span><span class="mi">1</span><span class="p">:])))</span>
            <span class="c1"># Quanties that do not vary</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;chi1&#39;</span><span class="p">,</span> <span class="s1">&#39;chi2&#39;</span><span class="p">]:</span>
                <span class="n">evolution_full</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">evolution_second</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">evolution_full</span>

    <span class="n">allresults</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">_compute</span><span class="p">,</span> <span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span><span class="p">,</span> <span class="n">deltachi</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">rswitch</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">uswitch</span><span class="p">,</span> <span class="n">chieff</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">))</span>
    <span class="n">evolution_full</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">allresults</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">evolution_full</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">evolution_full</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">evolution_full</span> <span class="ow">in</span> <span class="n">allresults</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">evolution_full</span></div>


<div class="viewcode-block" id="inspiral"><a class="viewcode-back" href="../auto.html#precession.inspiral">[docs]</a><span class="k">def</span> <span class="nf">inspiral</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generic wrapper for binary inspirals. The keyword which selects between the different approximation:</span>
<span class="sd">        - If which=precession use precession-averaged inspiral (i.e. run `inspiral_precav`)</span>
<span class="sd">        - If which=orbit use orbit-averaged inspiral (i.e. run `inspiral_orbav`)</span>
<span class="sd">        - If which=hybrid use hybrid inspiral (i.e. run `inspiral_hybrid`)</span>
<span class="sd">    All other aguments and keyword arguments are passed on to the relevant inspiral function; see their docs for details.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    **args: unpacked dictionary, optional</span>
<span class="sd">        Additional arguments.</span>
<span class="sd">    which: string, optional (default: None)</span>
<span class="sd">        Select function behavior.</span>
<span class="sd">    **kwargs: unpacked dictionary, optional</span>
<span class="sd">        Additional keyword arguments.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    outputs: dictionary, optional</span>
<span class="sd">        Set of outputs.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``outputs = precession.inspiral(*args,which=&#39;precession&#39;,**kwargs)``</span>
<span class="sd">    ``outputs = precession.inspiral(*args,which=&#39;orbit&#39;,**kwargs)``</span>
<span class="sd">    ``outputs = precession.inspiral(*args,which=&#39;hybrid&#39;,**kwargs)``</span>
<span class="sd">    &quot;&quot;&quot;</span>




    <span class="c1"># Precession-averaged integrations</span>
    <span class="k">if</span> <span class="n">which</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;precession&#39;</span><span class="p">,</span> <span class="s1">&#39;precav&#39;</span><span class="p">,</span> <span class="s1">&#39;precessionaveraged&#39;</span><span class="p">,</span> <span class="s1">&#39;precessionaverage&#39;</span><span class="p">,</span> <span class="s1">&#39;precession-averaged&#39;</span><span class="p">,</span> <span class="s1">&#39;precession-average&#39;</span><span class="p">,</span> <span class="s1">&#39;precessionav&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">inspiral_precav</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">which</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;orbit&#39;</span><span class="p">,</span> <span class="s1">&#39;orbav&#39;</span><span class="p">,</span> <span class="s1">&#39;orbitaveraged&#39;</span><span class="p">,</span> <span class="s1">&#39;orbitaverage&#39;</span><span class="p">,</span> <span class="s1">&#39;orbit-averaged&#39;</span><span class="p">,</span> <span class="s1">&#39;orbit-average&#39;</span><span class="p">,</span> <span class="s1">&#39;orbitav&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">inspiral_orbav</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">which</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;hybrid&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">inspiral_hybrid</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`which` needs to be `precav`, `orbav` or `hybrid`.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="gwfrequency_to_pnseparation"><a class="viewcode-back" href="../auto.html#precession.gwfrequency_to_pnseparation">[docs]</a><span class="k">def</span> <span class="nf">gwfrequency_to_pnseparation</span><span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span><span class="p">,</span> <span class="n">fGW</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">M_msun</span><span class="p">,</span> <span class="n">PNorder</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">1.5</span><span class="p">,</span><span class="mi">2</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert GW frequency (in Hz) to PN orbital separation (in natural units, c=G=M=1). We use the 2PN expression reported in Eq. 4.13 of Kidder 1995, arxiv:gr-qc/9506022.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    theta1: float</span>
<span class="sd">        Angle between orbital angular momentum and primary spin.</span>
<span class="sd">    theta2: float</span>
<span class="sd">        Angle between orbital angular momentum and secondary spin.</span>
<span class="sd">    deltaphi: float</span>
<span class="sd">        Angle between the projections of the two spins onto the orbital plane.</span>
<span class="sd">    fGW: float</span>
<span class="sd">        Gravitational-wave frequency.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    M_msun: float</span>
<span class="sd">        Total mass of the binary in solar masses.</span>
<span class="sd">    PNorder: array (default: [0,1,1.5,2])</span>
<span class="sd">        PN orders considered.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``r = precession.gwfrequency_to_pnseparation(theta1,theta2,deltaphi,fGW,q,chi1,chi2,M_msun,PNorder=[0,1,1.5,2])``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">theta1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">theta1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">theta2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">theta2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">deltaphi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">deltaphi</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">fGW</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">fGW</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">M_msun</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">M_msun</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="c1"># Prefactor is pi*Msun*G/c^3/s. It&#39;s pi and not 2pi because f is the GW frequency while Kidder&#39;s omega is the orbital angular velocity</span>
    <span class="n">tildeomega</span> <span class="o">=</span> <span class="n">M_msun</span> <span class="o">*</span> <span class="n">fGW</span> <span class="o">*</span> <span class="mf">1.548e-5</span> 

    <span class="n">r</span> <span class="o">=</span>  <span class="n">tildeomega</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
        <span class="p">(</span><span class="mi">0</span> <span class="ow">in</span> <span class="n">PNorder</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span> 
        <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="ow">in</span> <span class="n">PNorder</span><span class="p">)</span> <span class="o">*</span> <span class="n">tildeomega</span><span class="o">**</span><span class="p">(</span><span class="mi">2</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="mi">1</span><span class="o">-</span> <span class="n">q</span><span class="o">/</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span> 
        <span class="o">-</span> <span class="p">(</span><span class="mf">1.5</span> <span class="ow">in</span> <span class="n">PNorder</span><span class="p">)</span> <span class="o">*</span> <span class="n">tildeomega</span> <span class="o">/</span> <span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span><span class="mi">2</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="n">chi1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta1</span><span class="p">)</span> <span class="o">+</span> <span class="n">q</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="n">chi2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta2</span><span class="p">)</span> <span class="p">)</span>
        <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="ow">in</span> <span class="n">PNorder</span><span class="p">)</span> <span class="o">*</span> <span class="n">tildeomega</span><span class="o">**</span><span class="p">(</span><span class="mi">4</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">19</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span>  <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">9</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span> <span class="n">chi1</span><span class="o">*</span><span class="n">chi2</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta2</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">deltaphi</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta2</span><span class="p">))</span> <span class="p">)</span> 
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">r</span></div>


<div class="viewcode-block" id="pnseparation_to_gwfrequency"><a class="viewcode-back" href="../auto.html#precession.pnseparation_to_gwfrequency">[docs]</a><span class="k">def</span> <span class="nf">pnseparation_to_gwfrequency</span><span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">M_msun</span><span class="p">,</span> <span class="n">PNorder</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">1.5</span><span class="p">,</span><span class="mi">2</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert PN orbital separation in natural units (c=G=M=1) to GW frequency in Hz. We use the 2PN expression reported in Eq. 4.5 of Kidder 1995, arxiv:gr-qc/9506022.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    theta1: float</span>
<span class="sd">        Angle between orbital angular momentum and primary spin.</span>
<span class="sd">    theta2: float</span>
<span class="sd">        Angle between orbital angular momentum and secondary spin.</span>
<span class="sd">    deltaphi: float</span>
<span class="sd">        Angle between the projections of the two spins onto the orbital plane.</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    M_msun: float</span>
<span class="sd">        Total mass of the binary in solar masses.</span>
<span class="sd">    PNorder: array (default: [0,1,1.5,2])</span>
<span class="sd">        PN orders considered.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fGW: float</span>
<span class="sd">        Gravitational-wave frequency.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``fGW = precession.pnseparation_to_gwfrequency(theta1,theta2,deltaphi,r,q,chi1,chi2,M_msun,PNorder=[0,1,1.5,2])``</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="n">theta1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">theta1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">theta2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">theta2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">deltaphi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">deltaphi</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">M_msun</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">M_msun</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">tildeomega</span> <span class="o">=</span> <span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
        <span class="p">(</span><span class="mi">0</span> <span class="ow">in</span> <span class="n">PNorder</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span> 
        <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="ow">in</span> <span class="n">PNorder</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span><span class="p">(</span><span class="mi">3</span><span class="o">-</span> <span class="n">q</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="o">-</span> <span class="p">(</span><span class="mf">1.5</span> <span class="ow">in</span> <span class="n">PNorder</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span><span class="p">(</span> <span class="p">(</span><span class="mi">2</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="n">chi1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta1</span><span class="p">)</span> <span class="o">+</span> <span class="n">q</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="n">chi2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta2</span><span class="p">)</span> <span class="p">)</span>
        <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="ow">in</span> <span class="n">PNorder</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">6</span> <span class="o">+</span> <span class="mi">41</span><span class="o">*</span><span class="n">q</span><span class="o">/</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">q</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span><span class="n">chi1</span><span class="o">*</span><span class="n">chi2</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta2</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">deltaphi</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta2</span><span class="p">)))</span>
        <span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Prefactor is pi*Msun*G/c^3/s. It&#39;s pi and not 2pi because f is the GW frequency while Kidder&#39;s omega is the orbital angular velocity</span>
    <span class="n">fGW</span> <span class="o">=</span> <span class="n">tildeomega</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.548e-5</span>  <span class="o">*</span> <span class="n">M_msun</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fGW</span></div>




<span class="c1">################ Remnant properties ################</span>

<div class="viewcode-block" id="remnantmass"><a class="viewcode-back" href="../auto.html#precession.remnantmass">[docs]</a><span class="k">def</span> <span class="nf">remnantmass</span><span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Estimate the final mass of the post-merger renmant. We implement the fitting</span>
<span class="sd">    formula to numerical relativity simulations by Barausse Morozova Rezzolla</span>
<span class="sd">    2012. This formula has to be applied *close to merger*, where numerical</span>
<span class="sd">    relativity simulations are available. You should do a PN evolution to</span>
<span class="sd">    transfer binaries to r~10M.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    theta1: float</span>
<span class="sd">        Angle between orbital angular momentum and primary spin.</span>
<span class="sd">    theta2: float</span>
<span class="sd">        Angle between orbital angular momentum and secondary spin.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    mfin: float</span>
<span class="sd">        Mass of the black-hole remnant.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``mfin = precession.remnantmass(theta1,theta2,q,chi1,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">eta</span> <span class="o">=</span> <span class="n">eval_eta</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">chit_par</span> <span class="o">=</span>  <span class="p">(</span> <span class="n">chi2</span><span class="o">*</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta2</span><span class="p">)</span> <span class="o">+</span> <span class="n">chi1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta1</span><span class="p">)</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

    <span class="c1">#Final mass. Barausse Morozova Rezzolla 2012</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="mf">0.04827</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="mf">0.01707</span>
    <span class="n">Z1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">chit_par</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span> <span class="p">((</span><span class="mi">1</span><span class="o">+</span><span class="n">chit_par</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">chit_par</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">Z2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="o">*</span> <span class="n">chit_par</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Z1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">risco</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">Z2</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">chit_par</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mi">3</span><span class="o">-</span><span class="n">Z1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span><span class="o">+</span><span class="n">Z1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">Z2</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">Eisco</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">risco</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1">#Radiated energy, in units of the initial total mass of the binary</span>
    <span class="n">Erad</span> <span class="o">=</span> <span class="n">eta</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">Eisco</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span> <span class="n">eta</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">p0</span><span class="o">+</span><span class="mi">16</span><span class="o">*</span><span class="n">p1</span><span class="o">*</span><span class="n">chit_par</span><span class="o">*</span><span class="p">(</span><span class="n">chit_par</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">Eisco</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">Mfin</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span> <span class="n">Erad</span> <span class="c1"># Final mass</span>

    <span class="k">return</span> <span class="n">Mfin</span></div>


<div class="viewcode-block" id="remnantspin"><a class="viewcode-back" href="../auto.html#precession.remnantspin">[docs]</a><span class="k">def</span> <span class="nf">remnantspin</span><span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;HBR16_34corr&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Estimate the final spin of the post-merger renmant. We implement the fitting</span>
<span class="sd">    formula to numerical relativity simulations by  Barausse and Rezzolla 2009</span>
<span class="sd">    and Hofmann, Barausse and Rezzolla 2016. This can be selected by the keywork `</span>
<span class="sd">    `which`, see those references for details. By default this returns the</span>
<span class="sd">    Hofmann+ expression with nM=3, nJ=4 and corrections for the effective</span>
<span class="sd">    angles (HBR16_34corr). This formula has to be applied *close to merger*,</span>
<span class="sd">    where numerical relativity simulations are available. You should do a PN</span>
<span class="sd">    evolution to transfer binaries at r~10M.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    theta1: float</span>
<span class="sd">        Angle between orbital angular momentum and primary spin.</span>
<span class="sd">    theta2: float</span>
<span class="sd">        Angle between orbital angular momentum and secondary spin.</span>
<span class="sd">    deltaphi: float</span>
<span class="sd">        Angle between the projections of the two spins onto the orbital plane.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    which: string, optional (default: &#39;HBR16_34corr&#39;)</span>
<span class="sd">        Select function behavior.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    chifin: float</span>
<span class="sd">        Spin of the black-hole remnant.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``chifin = precession.remnantspin(theta1,theta2,deltaphi,q,chi1,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">eta</span> <span class="o">=</span> <span class="n">eval_eta</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">which</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;HBR16_12&#39;</span><span class="p">,</span> <span class="s1">&#39;HBR16_12corr&#39;</span><span class="p">,</span> <span class="s1">&#39;HBR16_33&#39;</span><span class="p">,</span> <span class="s1">&#39;HBR16_33corr&#39;</span><span class="p">,</span> <span class="s1">&#39;HBR16_34&#39;</span><span class="p">,</span> <span class="s1">&#39;HBR16_34corr&#39;</span><span class="p">]:</span>

        <span class="n">kfit</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="s1">&#39;HBR16_12&#39;</span> <span class="ow">in</span> <span class="n">which</span><span class="p">:</span>
            <span class="n">kfit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.2019</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.20764</span><span class="p">]</span> <span class="p">,</span>
                              <span class="p">[</span><span class="mf">3.79245</span><span class="p">,</span> <span class="mf">1.18385</span><span class="p">,</span> <span class="mf">4.90494</span><span class="p">]</span> <span class="p">]</span>  <span class="p">)</span>
            <span class="n">xifit</span> <span class="o">=</span> <span class="mf">0.41616</span>

        <span class="k">if</span> <span class="s1">&#39;HBR16_33&#39;</span> <span class="ow">in</span> <span class="n">which</span><span class="p">:</span>
            <span class="n">kfit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="mf">2.87025</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.53315</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.78893</span><span class="p">]</span> <span class="p">,</span>
                              <span class="p">[</span><span class="mf">32.9127</span><span class="p">,</span> <span class="o">-</span><span class="mf">62.9901</span><span class="p">,</span> <span class="mf">10.0068</span><span class="p">,</span> <span class="mf">56.1926</span><span class="p">],</span>
                              <span class="p">[</span><span class="o">-</span><span class="mf">136.832</span><span class="p">,</span> <span class="mf">329.32</span><span class="p">,</span> <span class="o">-</span><span class="mf">13.2034</span><span class="p">,</span> <span class="o">-</span><span class="mf">252.27</span><span class="p">],</span>
                              <span class="p">[</span><span class="mf">210.075</span><span class="p">,</span> <span class="o">-</span><span class="mf">545.35</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.97509</span><span class="p">,</span> <span class="mf">368.405</span><span class="p">]]</span>  <span class="p">)</span>
            <span class="n">xifit</span> <span class="o">=</span> <span class="mf">0.463926</span>

        <span class="k">if</span> <span class="s1">&#39;HBR16_34&#39;</span> <span class="ow">in</span> <span class="n">which</span><span class="p">:</span>
            <span class="n">kfit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="mf">3.39221</span><span class="p">,</span> <span class="mf">4.48865</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.77101</span><span class="p">,</span> <span class="o">-</span><span class="mf">13.0459</span><span class="p">]</span> <span class="p">,</span>
                              <span class="p">[</span><span class="mf">35.1278</span><span class="p">,</span> <span class="o">-</span><span class="mf">72.9336</span><span class="p">,</span> <span class="o">-</span><span class="mf">86.0036</span><span class="p">,</span> <span class="mf">93.7371</span><span class="p">,</span> <span class="mf">200.975</span><span class="p">],</span>
                              <span class="p">[</span><span class="o">-</span><span class="mf">146.822</span><span class="p">,</span> <span class="mf">387.184</span><span class="p">,</span> <span class="mf">447.009</span><span class="p">,</span> <span class="o">-</span><span class="mf">467.383</span><span class="p">,</span> <span class="o">-</span><span class="mf">884.339</span><span class="p">],</span>
                              <span class="p">[</span><span class="mf">223.911</span><span class="p">,</span> <span class="o">-</span><span class="mf">648.502</span><span class="p">,</span> <span class="o">-</span><span class="mf">697.177</span><span class="p">,</span> <span class="mf">753.738</span><span class="p">,</span> <span class="mf">1166.89</span><span class="p">]])</span>
            <span class="n">xifit</span> <span class="o">=</span> <span class="mf">0.474046</span>

        <span class="c1"># Calculate K00 from Eq 11</span>
        <span class="n">kfit</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span> <span class="mf">0.68646</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">kfit</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span><span class="p">(</span><span class="mi">4</span><span class="o">**</span><span class="p">(</span><span class="mi">3</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">kfit</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))))</span> <span class="o">-</span> <span class="p">(</span><span class="mi">3</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">theta12</span> <span class="o">=</span> <span class="n">eval_theta12</span><span class="p">(</span><span class="n">theta1</span><span class="o">=</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="o">=</span><span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span><span class="o">=</span><span class="n">deltaphi</span><span class="p">)</span>

        <span class="c1"># Eq. 18</span>
        <span class="k">if</span> <span class="s1">&#39;corr&#39;</span> <span class="ow">in</span> <span class="n">which</span><span class="p">:</span>
            <span class="n">eps1</span> <span class="o">=</span> <span class="mf">0.024</span>
            <span class="n">eps2</span> <span class="o">=</span> <span class="mf">0.024</span>
            <span class="n">eps12</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">theta1</span> <span class="o">=</span> <span class="n">theta1</span> <span class="o">+</span> <span class="n">eps1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta1</span><span class="p">)</span>
            <span class="n">theta2</span> <span class="o">=</span> <span class="n">theta2</span> <span class="o">+</span> <span class="n">eps2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta2</span><span class="p">)</span>
            <span class="n">theta12</span> <span class="o">=</span> <span class="n">theta12</span> <span class="o">+</span> <span class="n">eps12</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta12</span><span class="p">)</span>

        <span class="c1"># Eq. 14 - 15</span>
        <span class="n">atot</span> <span class="o">=</span> <span class="p">(</span> <span class="n">chi1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta1</span><span class="p">)</span> <span class="o">+</span> <span class="n">chi2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">aeff</span> <span class="o">=</span> <span class="n">atot</span> <span class="o">+</span> <span class="n">xifit</span><span class="o">*</span><span class="n">eta</span><span class="o">*</span> <span class="p">(</span> <span class="n">chi1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta1</span><span class="p">)</span> <span class="o">+</span> <span class="n">chi2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta2</span><span class="p">)</span> <span class="p">)</span>

        <span class="c1"># Eq. 2 - 6 evaluated at aeff, as specified in Eq. 11</span>
        <span class="n">Z1</span><span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="n">aeff</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">aeff</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">aeff</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">Z2</span><span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">aeff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">Z1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">risco</span><span class="o">=</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">Z2</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">aeff</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span><span class="mi">3</span><span class="o">-</span><span class="n">Z1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span><span class="o">+</span><span class="n">Z1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">Z2</span><span class="p">)</span> <span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">Eisco</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">risco</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">Lisco</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">))))</span> <span class="o">*</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">risco</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>

        <span class="c1"># Eq. 13</span>
        <span class="n">etatoi</span> <span class="o">=</span> <span class="n">eta</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">kfit</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">innersum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">kfit</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">etatoi</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">aefftoj</span> <span class="o">=</span> <span class="n">aeff</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">kfit</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">sumell</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">innersum</span>  <span class="o">*</span> <span class="n">aefftoj</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">ell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span> <span class="n">Lisco</span>  <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">atot</span><span class="o">*</span><span class="p">(</span><span class="n">Eisco</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="o">+</span> <span class="n">sumell</span> <span class="p">)</span>

        <span class="c1"># Eq. 16</span>
        <span class="n">chifin</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">chi1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">chi2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span>  <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">chi1</span><span class="o">*</span><span class="n">chi2</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta12</span><span class="p">)</span>
                <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">chi1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta1</span><span class="p">)</span> <span class="o">+</span> <span class="n">chi2</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta2</span><span class="p">))</span><span class="o">*</span><span class="n">ell</span><span class="o">*</span><span class="n">q</span> <span class="o">+</span> <span class="p">((</span><span class="n">ell</span><span class="o">*</span><span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  <span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`which` needs to be one of the following: `HBR16_12`, `HBR16_12corr`, `HBR16_33`, `HBR16_33corr`, `HBR16_34`, `HBR16_34corr`.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">chifin</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="reminantspindirection"><a class="viewcode-back" href="../auto.html#precession.reminantspindirection">[docs]</a><span class="k">def</span> <span class="nf">reminantspindirection</span><span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Angle between the spin of the remnant and the binary angular momentum, assuming that the spins stays in the direction of the total angular momentum &#39;at plunge&#39;.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    theta1: float</span>
<span class="sd">        Angle between orbital angular momentum and primary spin.</span>
<span class="sd">    theta2: float</span>
<span class="sd">        Angle between orbital angular momentum and secondary spin.</span>
<span class="sd">    deltaphi: float</span>
<span class="sd">        Angle between the projections of the two spins onto the orbital plane.</span>
<span class="sd">    r: float</span>
<span class="sd">        Binary separation.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    thetaL: float</span>
<span class="sd">        Angle betwen orbital angular momentum and total angular momentum.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``thetaL = precession.reminantspindirection(theta1,theta2,deltaphi,r,q,chi1,chi2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">Lvec</span><span class="p">,</span><span class="n">S1vec</span><span class="p">,</span><span class="n">S2vec</span> <span class="o">=</span> <span class="n">angles_to_Lframe</span><span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
    <span class="n">Jvec</span> <span class="o">=</span> <span class="n">Lvec</span> <span class="o">+</span> <span class="n">S1vec</span> <span class="o">+</span> <span class="n">S2vec</span>
    <span class="n">hatL</span> <span class="o">=</span> <span class="n">normalize_nested</span><span class="p">(</span><span class="n">Lvec</span><span class="p">)</span>
    <span class="n">hatJ</span> <span class="o">=</span> <span class="n">normalize_nested</span><span class="p">(</span><span class="n">Jvec</span><span class="p">)</span>
    <span class="n">thetaL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">dot_nested</span><span class="p">(</span><span class="n">hatL</span><span class="p">,</span><span class="n">hatJ</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">thetaL</span></div>

    

<div class="viewcode-block" id="remnantkick"><a class="viewcode-back" href="../auto.html#precession.remnantkick">[docs]</a><span class="k">def</span> <span class="nf">remnantkick</span><span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">kms</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">maxphase</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">superkick</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">hangupkick</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">crosskick</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">full_output</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Estimate the kick of the merger remnant. We collect various numerical-relativity</span>
<span class="sd">    results, as described in Gerosa and Kesden 2016. Flags let you switch the</span>
<span class="sd">    various contributions on and off (all on by default): superkicks (Gonzalez et al. 2007a;</span>
<span class="sd">    Campanelli et al. 2007), hang-up kicks (Lousto &amp; Zlochower 2011),</span>
<span class="sd">    cross-kicks (Lousto &amp; Zlochower 2013). The orbital-plane kick components are</span>
<span class="sd">    implemented as described in Kesden et al. 2010a.  The final kick depends on</span>
<span class="sd">    the orbital phase at merger. By default, this is assumed to be uniformly</span>
<span class="sd">    distributed in [0,2pi]. The maximum kick is realized for Theta=0 and can be</span>
<span class="sd">    computed with the optional argument maxphase. The final kick is returned in</span>
<span class="sd">    geometrical units (i.e. vkick/c) by default, and converted to km/s if</span>
<span class="sd">    kms=True. This formula has to be applied *close to merger*, where</span>
<span class="sd">    numerical relativity simulations are available. You should do a PN evolution</span>
<span class="sd">    to transfer binaries at r~10M.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    theta1: float</span>
<span class="sd">        Angle between orbital angular momentum and primary spin.</span>
<span class="sd">    theta2: float</span>
<span class="sd">        Angle between orbital angular momentum and secondary spin.</span>
<span class="sd">    deltaphi: float</span>
<span class="sd">        Angle between the projections of the two spins onto the orbital plane.</span>
<span class="sd">    q: float</span>
<span class="sd">        Mass ratio: 0&lt;=q&lt;=1.</span>
<span class="sd">    chi1: float</span>
<span class="sd">        Dimensionless spin of the primary (heavier) black hole: 0&lt;=chi1&lt;=1.</span>
<span class="sd">    chi2: float</span>
<span class="sd">        Dimensionless spin of the secondary (lighter) black hole: 0&lt;=chi2&lt;=1.</span>
<span class="sd">    kms: boolean, optional (default: False)</span>
<span class="sd">        Return velocities in km/s.</span>
<span class="sd">    maxphase: boolean, optional (default: False)</span>
<span class="sd">        Maximize over orbital phase at merger.</span>
<span class="sd">    superkick: boolean, optional (default: True)</span>
<span class="sd">        Switch kick terms on and off.</span>
<span class="sd">    hangupkick: boolean, optional (default: True)</span>
<span class="sd">        Switch kick terms on and off.</span>
<span class="sd">    crosskick: boolean, optional (default: True)</span>
<span class="sd">        Switch kick terms on and off.</span>
<span class="sd">    full_output: boolean, optional (default: False)</span>
<span class="sd">        Return additional outputs.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    vk: float</span>
<span class="sd">        Kick of the black-hole remnant (magnitude).</span>
<span class="sd">    vk_array: array, optional</span>
<span class="sd">        Kick of the black-hole remnant (in a frame aligned with L).</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ``vk = precession.remnantkick(theta1,theta2,deltaphi,q,chi1,chi2,full_output=False)``</span>
<span class="sd">    ``vk,vk_array = precession.remnantkick(theta1,theta2,deltaphi,q,chi1,chi2,full_output=True)``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">chi2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">eta</span> <span class="o">=</span> <span class="n">eval_eta</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>

    <span class="n">Lvec</span><span class="p">,</span><span class="n">S1vec</span><span class="p">,</span><span class="n">S2vec</span> <span class="o">=</span> <span class="n">angles_to_Lframe</span><span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">deltaphi</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chi1</span><span class="p">,</span> <span class="n">chi2</span><span class="p">)</span>
    <span class="n">hatL</span> <span class="o">=</span> <span class="n">normalize_nested</span><span class="p">(</span><span class="n">Lvec</span><span class="p">)</span>
    <span class="n">hatS1</span> <span class="o">=</span> <span class="n">normalize_nested</span><span class="p">(</span><span class="n">S1vec</span><span class="p">)</span>
    <span class="n">hatS2</span> <span class="o">=</span> <span class="n">normalize_nested</span><span class="p">(</span><span class="n">S2vec</span><span class="p">)</span>

    <span class="c1">#More spin parameters.</span>
    <span class="n">Delta</span> <span class="o">=</span> <span class="o">-</span> <span class="n">scalar_nested</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">),</span> <span class="p">(</span><span class="n">scalar_nested</span><span class="p">(</span><span class="n">q</span><span class="o">*</span><span class="n">chi2</span><span class="p">,</span><span class="n">hatS2</span><span class="p">)</span><span class="o">-</span><span class="n">scalar_nested</span><span class="p">(</span><span class="n">chi1</span><span class="p">,</span><span class="n">hatS1</span><span class="p">))</span> <span class="p">)</span>
    <span class="n">Delta_par</span> <span class="o">=</span> <span class="n">dot_nested</span><span class="p">(</span><span class="n">Delta</span><span class="p">,</span><span class="n">hatL</span><span class="p">)</span>
    <span class="n">Delta_perp</span> <span class="o">=</span> <span class="n">norm_nested</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">Delta</span><span class="p">,</span><span class="n">hatL</span><span class="p">))</span>
    <span class="n">chit</span> <span class="o">=</span> <span class="n">scalar_nested</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">scalar_nested</span><span class="p">(</span><span class="n">chi2</span><span class="o">*</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">hatS2</span><span class="p">)</span><span class="o">+</span><span class="n">scalar_nested</span><span class="p">(</span><span class="n">chi1</span><span class="p">,</span><span class="n">hatS1</span><span class="p">))</span> <span class="p">)</span>
    <span class="n">chit_par</span> <span class="o">=</span> <span class="n">dot_nested</span><span class="p">(</span><span class="n">chit</span><span class="p">,</span><span class="n">hatL</span><span class="p">)</span>
    <span class="n">chit_perp</span> <span class="o">=</span> <span class="n">norm_nested</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">chit</span><span class="p">,</span><span class="n">hatL</span><span class="p">))</span>

    <span class="c1">#Coefficients are quoted in km/s</span>
    <span class="c1">#vm and vperp from Kesden at 2010a. vpar from Lousto Zlochower 2013</span>
    <span class="n">zeta</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">145</span><span class="p">)</span>
    <span class="n">A</span><span class="o">=</span><span class="mf">1.2e4</span>
    <span class="n">B</span><span class="o">=-</span><span class="mf">0.93</span>
    <span class="n">H</span><span class="o">=</span><span class="mf">6.9e3</span>

    <span class="c1">#Multiply by 0/1 boolean flags to select terms</span>
    <span class="n">V11</span> <span class="o">=</span> <span class="mf">3677.76</span> <span class="o">*</span> <span class="n">superkick</span>
    <span class="n">VA</span> <span class="o">=</span> <span class="mf">2481.21</span> <span class="o">*</span> <span class="n">hangupkick</span>
    <span class="n">VB</span> <span class="o">=</span> <span class="mf">1792.45</span> <span class="o">*</span> <span class="n">hangupkick</span>
    <span class="n">VC</span> <span class="o">=</span> <span class="mf">1506.52</span> <span class="o">*</span> <span class="n">hangupkick</span>
    <span class="n">C2</span> <span class="o">=</span> <span class="mi">1140</span> <span class="o">*</span> <span class="n">crosskick</span>
    <span class="n">C3</span> <span class="o">=</span> <span class="mi">2481</span> <span class="o">*</span> <span class="n">crosskick</span>

    <span class="c1">#maxkick</span>
    <span class="n">bigTheta</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="n">q</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="ow">not</span> <span class="n">maxphase</span><span class="p">)</span>

    <span class="n">vm</span> <span class="o">=</span> <span class="n">A</span> <span class="o">*</span> <span class="n">eta</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">B</span><span class="o">*</span><span class="n">eta</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">q</span><span class="p">)</span>
    <span class="n">vperp</span> <span class="o">=</span> <span class="n">H</span> <span class="o">*</span> <span class="n">eta</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">Delta_par</span>
    <span class="n">vpar</span> <span class="o">=</span> <span class="mi">16</span><span class="o">*</span><span class="n">eta</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">Delta_perp</span> <span class="o">*</span> <span class="p">(</span><span class="n">V11</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">VA</span><span class="o">*</span><span class="n">chit_par</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">VB</span><span class="o">*</span><span class="n">chit_par</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">8</span><span class="o">*</span><span class="n">VC</span><span class="o">*</span><span class="n">chit_par</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">chit_perp</span> <span class="o">*</span> <span class="n">Delta_par</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">C2</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">C3</span><span class="o">*</span><span class="n">chit_par</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">bigTheta</span><span class="p">)</span>
    <span class="n">kick</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">vm</span><span class="o">+</span><span class="n">vperp</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">zeta</span><span class="p">),</span><span class="n">vperp</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">zeta</span><span class="p">),</span><span class="n">vpar</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">kms</span><span class="p">:</span>
        <span class="n">kick</span> <span class="o">=</span> <span class="n">kick</span><span class="o">/</span><span class="mf">299792.458</span> <span class="c1"># speed of light in km/s</span>

    <span class="n">vk</span> <span class="o">=</span> <span class="n">norm_nested</span><span class="p">(</span><span class="n">kick</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">full_output</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">vk</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">kick</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">vk</span></div>




<span class="c1">################ Main ################</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">pass</span>


    <span class="nb">print</span> <span class="p">(</span> <span class="n">remnantkick</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">],</span> <span class="n">maxphase</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Copyright (c) Davide Gerosa.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>